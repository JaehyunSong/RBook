<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>私たちのR – 27&nbsp; 反復処理</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./oop.html" rel="next">
<link href="./renv.html" rel="prev">
<link href="./Figs/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CEHS4C056W"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CEHS4C056W', { 'anonymize_ip': false});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<meta property="og:title" content="私たちのR: ベストプラクティスの探求">
<meta property="og:description" content="R Not for Everyone: An Esoteric Guide">
<meta property="og:image" content="https://www.jaysong.net/RBook/imgs/favicon.png">
<meta property="og:site-name" content="私たちのR">
<meta name="twitter:title" content="私たちのR: ベストプラクティスの探求">
<meta name="twitter:description" content="R Not for Everyone: An Esoteric Guide">
<meta name="twitter:image" content="https://www.jaysong.net/RBook/imgs/favicon.png">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar docked">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">
      私たちのR
      </a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/JaehyunSong/RBook/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">紹介</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Rの導入</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aboutr.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./installation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Rのインストール</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ide.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">IDEの導入</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_customize.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">分析環境のカスタマイズ</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./packages.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Rパッケージ</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Rの基礎</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_basic.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">基本的な操作</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./io.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">データの入出力</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datatype.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データ型</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datastructure.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">データ構造</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Rプログラミングの基礎</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">関数の自作</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">データハンドリング</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factor.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [factor型]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidydata.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">整然データ構造</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./string.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">文字列の処理</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">可視化</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">可視化 [理論]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">可視化 [基礎]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">可視化 [応用]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">可視化 [発展]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">モデルの可視化</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">再現可能な研究</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">R Markdown [基礎]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">R Markdown [応用]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Quarto入門</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./table.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">表の作成</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./renv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">分析環境の管理</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">中級者向け</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./oop.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./monte.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">モンテカルロ・シミュレーション</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scraping.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">スクレイピング</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./api.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">API</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">付録</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tips.html" class="sidebar-item-text sidebar-link">R Tips</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link">本書の執筆環境</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">参考文献</a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="RN4ETOC" role="doc-toc" class="toc-active"><h2 id="RN4Etoc-title" class="anchored">目次</h2>
   
  <ul>
<li><a href="#RN4Esec-iteration-intro" id="RN4Etoc-sec-iteration-intro" class="nav-link active" data-scroll-target="#RN4Esec-iteration-intro"><span class="toc-section-number">27.1</span>  <code>*apply()</code>関数群と<code>map_*()</code>関数群</a></li>
  <li><a href="#RN4Esec-iteration-map2" id="RN4Etoc-sec-iteration-map2" class="nav-link" data-scroll-target="#RN4Esec-iteration-map2"><span class="toc-section-number">27.2</span>  引数が2つ以上の場合</a></li>
  <li>
<a href="#RN4Esec-iteration-df" id="RN4Etoc-sec-iteration-df" class="nav-link" data-scroll-target="#RN4Esec-iteration-df"><span class="toc-section-number">27.3</span>  データフレームと{purrr}</a>
  <ul class="collapse">
<li><a href="#RN4Esec-iteration-tibble" id="RN4Etoc-sec-iteration-tibble" class="nav-link" data-scroll-target="#RN4Esec-iteration-tibble"><span class="toc-section-number">27.3.1</span>  tibbleの話</a></li>
  </ul>
</li>
  <li>
<a href="#RN4Esec-iteration-model1" id="RN4Etoc-sec-iteration-model1" class="nav-link" data-scroll-target="#RN4Esec-iteration-model1"><span class="toc-section-number">27.4</span>  モデルの反復推定</a>
  <ul class="collapse">
<li><a href="#RN4Esec-iteration-split1" id="RN4Etoc-sec-iteration-split1" class="nav-link" data-scroll-target="#RN4Esec-iteration-split1"><span class="toc-section-number">27.4.1</span>  サンプルの分割とモデル推定（<code>split()</code>利用）</a></li>
  <li><a href="#RN4Esec-iteration-split2" id="RN4Etoc-sec-iteration-split2" class="nav-link" data-scroll-target="#RN4Esec-iteration-split2"><span class="toc-section-number">27.4.2</span>  サンプルの分割とモデル推定（<code>nest()</code>利用）</a></li>
  <li><a href="#RN4Esec-iteration-range" id="RN4Etoc-sec-iteration-range" class="nav-link" data-scroll-target="#RN4Esec-iteration-range"><span class="toc-section-number">27.4.3</span>  データの範囲を指定したモデル推定</a></li>
  <li><a href="#RN4Esec-iteration-variables" id="RN4Etoc-sec-iteration-variables" class="nav-link" data-scroll-target="#RN4Esec-iteration-variables"><span class="toc-section-number">27.4.4</span>  説明・応答変数を指定したモデル推定</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="RN4Esec-iteration" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="RN4Esec-iteration-intro" class="level2" data-number="27.1"><h2 data-number="27.1" class="anchored" data-anchor-id="RN4Esec-iteration-intro">
<span class="header-section-number">27.1</span> <code>*apply()</code>関数群と<code>map_*()</code>関数群</h2>
<p>まず、我らの盟友、{tidyverse}を読み込んでおきましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb1-1"><a href="#RN4Ecb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>それでは、<code>*apply()</code>関数群と<code>map_*()</code>関数群の動きとその仕組について調べてみましょう。まず、実習用データとして長さ5のnumericベクトル<code>num_vec</code>を用意します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb2-1"><a href="#RN4Ecb2-1"></a>num_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この<code>num_vec</code>の個々の要素に2を足す場合はどうすれば良いでしょうか。Rはベクトル単位での演算が行われるため、<code>num_vec + 2</code>だけで十分です。<code>+</code>の右側にある2は長さ1のベクトルですが、<code>num_vec</code>の長さに合わせてリサイクルされます（第<a href="#RN4Esec-datastructure_vector"><span>9.2</span></a>章を参照）。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb3-1"><a href="#RN4Ecb3-1"></a>num_vec <span class="sc">+</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 4 7 6 9</code></pre>
</div>
</div>
<p>賢明なRユーザーなら上のコードが正解でしょう。しかし、これからの練習のために<code>+</code>を使わずに、<code>for()</code>文を使用してみましょう（第<a href="#RN4Esec-programming_iteration"><span>10.3</span></a>章を参照）。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb5"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb5-1"><a href="#RN4Ecb5-1"></a><span class="cf">for</span> (i <span class="cf">in</span> num_vec) {</span>
<span id="RN4Ecb5-2"><a href="#RN4Ecb5-2"></a>    <span class="fu">print</span>(i <span class="sc">+</span> <span class="dv">2</span>)</span>
<span id="RN4Ecb5-3"><a href="#RN4Ecb5-3"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5
[1] 4
[1] 7
[1] 6
[1] 9</code></pre>
</div>
</div>
<p>実はこれと同じ役割をする関数がRには内蔵されており、それが<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>関数です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb7"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb7-1"><a href="#RN4Ecb7-1"></a><span class="fu">lapply</span>(オブジェクト名, 関数名, 関数の引数)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下のコードからも確認出来ますが、足し算を意味する<code>+</code>も関数です。ただし、演算子を関数として使う場合は演算子を<code>`</code>で囲む必要があり、<code>+</code>だと<code>`+`</code>と表記します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb8-1"><a href="#RN4Ecb8-1"></a><span class="st">`</span><span class="at">+</span><span class="st">`</span>(num_vec, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 4 7 6 9</code></pre>
</div>
</div>
<p>したがって、<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>関数を使用して<code>num_vec</code>の全要素に2を足す場合、以下のようなコードとなります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb10"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb10-1"><a href="#RN4Ecb10-1"></a><span class="fu">lapply</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 5

[[2]]
[1] 4

[[3]]
[1] 7

[[4]]
[1] 6

[[5]]
[1] 9</code></pre>
</div>
</div>
<p>これと同じ動きをする関数が{purrr}パッケージの<code>map()</code>です。{purrr}は{tidyverse}を読み込むと自動的に読み込まれます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb12-1"><a href="#RN4Ecb12-1"></a><span class="fu">map</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 5

[[2]]
[1] 4

[[3]]
[1] 7

[[4]]
[1] 6

[[5]]
[1] 9</code></pre>
</div>
</div>
<p>ただし、<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>と<code>map()</code>の場合、戻り値はリスト型となります。もし、ベクトル型の戻り値が必要な場合は更に<code><a href="https://rdrr.io/r/base/unlist.html">unlist()</a></code>関数を使うか、<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb14"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb14-1"><a href="#RN4Ecb14-1"></a><span class="co"># unlist()を利用し、リストを解除する</span></span>
<span id="RN4Ecb14-2"><a href="#RN4Ecb14-2"></a><span class="fu">lapply</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 4 7 6 9</code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb16"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb16-1"><a href="#RN4Ecb16-1"></a><span class="co"># sapply()を利用すると戻り値はベクトルとなる</span></span>
<span id="RN4Ecb16-2"><a href="#RN4Ecb16-2"></a><span class="fu">sapply</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 4 7 6 9</code></pre>
</div>
</div>
<p><code>map()</code>関数なら<code><a href="https://rdrr.io/r/base/unlist.html">unlist()</a></code>でも良いですが、<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>と同じ動きをする<code>map_dbl()</code>があります。これは戻り値がdoubleのnumericベクトルになる<code>map()</code>関数です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb18"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb18-1"><a href="#RN4Ecb18-1"></a><span class="co"># map_dbl()を利用するとnumeric (double)のベクトルが返される</span></span>
<span id="RN4Ecb18-2"><a href="#RN4Ecb18-2"></a><span class="fu">map_dbl</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 4 7 6 9</code></pre>
</div>
</div>
<p>もし、2を足すだけでなく、更に3で割るためにはどうすれば良いでしょうか。まず考えられるのは更に<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>や<code>map_dbl</code>を使うことです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb20"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb20-1"><a href="#RN4Ecb20-1"></a><span class="fu">map_dbl</span>(num_vec, <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="RN4Ecb20-2"><a href="#RN4Ecb20-2"></a>    <span class="fu">map_dbl</span>(<span class="st">`</span><span class="at">/</span><span class="st">`</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
</div>
<p>もう一つの方法は<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>や<code>map_dbl()</code>の第二引数に直接関数を指定する方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb22"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb22-1"><a href="#RN4Ecb22-1"></a><span class="fu">sapply</span>(num_vec, <span class="cf">function</span>(x){(x <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb24"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb24-1"><a href="#RN4Ecb24-1"></a><span class="fu">map_dbl</span>(num_vec, <span class="cf">function</span>(x){(x <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
</div>
<p>上のコードだと、<code>num_vec</code>の要素が第二引数で指定した関数の引数（<code>x</code>）として用いられます。関数が長くなる場合は、<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>や<code>map()</code>の外側に関数を予め指定して置くことも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb26"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb26-1"><a href="#RN4Ecb26-1"></a>add_two_divide_three <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="RN4Ecb26-2"><a href="#RN4Ecb26-2"></a>    (x <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span> </span>
<span id="RN4Ecb26-3"><a href="#RN4Ecb26-3"></a>}</span>
<span id="RN4Ecb26-4"><a href="#RN4Ecb26-4"></a><span class="fu">sapply</span>(num_vec, add_two_divide_three)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb28"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb28-1"><a href="#RN4Ecb28-1"></a><span class="fu">map_dbl</span>(num_vec, add_two_divide_three)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
</div>
<p>ここまでの例だと<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>と<code>map_dbl()</code>はほぼ同じ関数です。なぜわざわざ{purrr}パッケージを読み込んでまで<code>map_dbl()</code>関数を使う必要があるでしょうか。それは<code>map_dbl()</code>の内部にはラムダ（lambda）式、あるいは無名関数（anonymous function）と呼ばれるものが使用可能だからです。ラムダ式は第<a href="#RN4Esec-handling2-summarise"><span>13.1</span></a>章でも説明しましたが、もう一回解説します。ラムダ式は使い捨ての関数で、<code>map_dbl()</code>内部での処理が終わるとメモリ上から削除される関数です。使い捨てですので、関数の名前（オブジェクト名）も与えられておりません。</p>
<p>このラムダ式の作り方ですが、<code>~</code>で始まり、引数の部分には<code>.x</code>が入ります<a href="#RN4Efn1" class="footnote-ref" id="RN4Efnref1" role="doc-noteref"><sup>1</sup></a>。したがって、<code>~(.x + 2) / 3</code>は<code>function(x){(x + 2) / 3}</code>の簡略したものとなります。ただし、後者だと無名関数の引数に該当する<code>x</code>を<code>y</code>や<code>j</code>などに書き換えても問題ありませんが、ラムダ式では必ず<code>.x</code>と表記する必要があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb30"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb30-1"><a href="#RN4Ecb30-1"></a><span class="fu">map_dbl</span>(num_vec, <span class="sc">~</span>(.x <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.666667 1.333333 2.333333 2.000000 3.000000</code></pre>
</div>
</div>
<p>かなり短めなコードで「<code>num_vec</code>の全要素に2を足して3で割る」処理ができました。一方、<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>や<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>のような<code>*apply()</code>関数群だとラムダ式を使うことはできません。現在のメモリ上にある関数のみしか使うことができません。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb32"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb32-1"><a href="#RN4Ecb32-1"></a><span class="fu">sapply</span>(num_vec, <span class="sc">~</span>(.x <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in match.fun(FUN): '~(.x + 2)/3' is not a function, character or symbol</code></pre>
</div>
</div>
<p>これまでの例は<strong>正しい</strong>コードではありますが、<strong>良い</strong>コードとは言えないでしょう。なぜなら<code>num_vec + 2</code>という最適解が存在するからです。<code>*apply()</code>と<code>map_*()</code>はより複雑な処理に特化しています。たとえば、リスト型データの処理です。以下の例を考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb34"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb34-1"><a href="#RN4Ecb34-1"></a>num_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">List1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>),</span>
<span id="RN4Ecb34-2"><a href="#RN4Ecb34-2"></a>                 <span class="at">List2 =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">13</span>, <span class="dv">3</span>),</span>
<span id="RN4Ecb34-3"><a href="#RN4Ecb34-3"></a>                 <span class="at">List3 =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="cn">NA</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>num_list</code>は3つのnumeric型ベクトルで構成されたリスト型オブジェクトです。それぞれのベクトルの平均値を求めてみましょう。これを普通に<code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>関数のみで済まそうとすると、リストからベクトルを一つずつ抽出し、3回の<code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>関数を使用する必要があります、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb35-1"><a href="#RN4Ecb35-1"></a><span class="fu">mean</span>(num_list[[<span class="st">"List1"</span>]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb37"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb37-1"><a href="#RN4Ecb37-1"></a><span class="fu">mean</span>(num_list[[<span class="st">"List2"</span>]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.571429</code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb39"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb39-1"><a href="#RN4Ecb39-1"></a><span class="fu">mean</span>(num_list[[<span class="st">"List3"</span>]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.666667</code></pre>
</div>
</div>
<p>もしリストの長さが大きくなると、以下のように<code>for()</code>文の方が効率的でしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb41-1"><a href="#RN4Ecb41-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(num_list)) {</span>
<span id="RN4Ecb41-2"><a href="#RN4Ecb41-2"></a>    <span class="fu">print</span>(<span class="fu">mean</span>(num_list[[i]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="RN4Ecb41-3"><a href="#RN4Ecb41-3"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5
[1] 6.571429
[1] 4.666667</code></pre>
</div>
</div>
<p>計算結果をベクトルとして出力/保存する場合は予めベクトルを用意しておく必要があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb43-1"><a href="#RN4Ecb43-1"></a><span class="co"># num_listの長さと同じ長さの空ベクトルを生成</span></span>
<span id="RN4Ecb43-2"><a href="#RN4Ecb43-2"></a>Return_vec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(num_list))</span>
<span id="RN4Ecb43-3"><a href="#RN4Ecb43-3"></a></span>
<span id="RN4Ecb43-4"><a href="#RN4Ecb43-4"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(num_list)) {</span>
<span id="RN4Ecb43-5"><a href="#RN4Ecb43-5"></a>    Return_vec[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(num_list[[i]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="RN4Ecb43-6"><a href="#RN4Ecb43-6"></a>}</span>
<span id="RN4Ecb43-7"><a href="#RN4Ecb43-7"></a></span>
<span id="RN4Ecb43-8"><a href="#RN4Ecb43-8"></a>Return_vec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.000000 6.571429 4.666667</code></pre>
</div>
</div>
<p>以上の例は<code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code>、または<code>map_dbl</code>関数を使うとより短くすることができます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb45-1"><a href="#RN4Ecb45-1"></a><span class="fu">sapply</span>(num_list, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   List1    List2    List3 
5.000000 6.571429 4.666667 </code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb47"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb47-1"><a href="#RN4Ecb47-1"></a><span class="fu">map_dbl</span>(num_list, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   List1    List2    List3 
5.000000 6.571429 4.666667 </code></pre>
</div>
</div>
<p><code>*apply()</code>も<code>map_*()</code>も、それぞれの要素に対して同じ処理を行うことを得意とする関数です。他の応用としては、各ベクトルからn番目の要素を抽出することもできます。ベクトルからn番目の要素を抽出するには<code>ベクトル名[n]</code>と入力しますが、実はこの<code>[</code>も関数です。関数として使う場合は<code>+</code>と同様、<code>`[`</code>と表記します。<code>num_list</code>内の3つのベクトルから3番目の要素を抽出してみましょう<a href="#RN4Efn2" class="footnote-ref" id="RN4Efnref2" role="doc-noteref"><sup>2</sup></a>。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb49"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb49-1"><a href="#RN4Ecb49-1"></a><span class="fu">map_dbl</span>(num_list, <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List1 List2 List3 
    5     6    NA </code></pre>
</div>
</div>
<p>ここまで来たら<code>map_*()</code>関数群の仕組みについてイメージが出来たかと思います。<code>map_*()</code>関数群の動きは <a href="#RN4Efig-map_inside">図&nbsp;<span>27.1</span></a> のように表すことができます。第一引数はデータであり、そのデータの各要素に対して第二引数で指定された関数を適用します。この関数に必要な（データを除く）引数は第三引数以降に指定します。この関数部（第二引数）はRやパッケージなどで予め提供されている関数でも、内部に直接無名関数を作成することもできます。この無名関数は<code>function(x){}</code>のような従来の書き方も可能ですが、<code>map_*()</code>関数群の場合<code>~</code>で始まるラムダ式を使うことも可能です。</p>
<div id="RN4Efig-map_inside" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="Figs/Iteration/map_inside.png" class="img-fluid figure-img" style="width:85.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.1: map関数群のイメージ</figcaption><p></p>
</figure>
</div>
<p><code>map()</code>の場合、返り値はリストとなり、<code>map_dbl()</code>の返り値はnumeric (double)型のベクトルとなります。他にも<code>map_*()</code>関数群には<code>map_int()</code>、<code>map_lgl()</code>、<code>map_chr()</code>、<code>map_df()</code>などがあり、それぞれ返り値のデータ型/データ構造を表しています。例えば、返り値がcharacter型のベクトルであれば、<code>map_chr()</code>を使います。<code>c(1, 2, 3, 4, 5)</code>のベクトルの各要素の前に<code>"ID: "</code>を付ける例だと以下のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb51"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb51-1"><a href="#RN4Ecb51-1"></a><span class="co"># 以下のコードでもOK</span></span>
<span id="RN4Ecb51-2"><a href="#RN4Ecb51-2"></a><span class="co"># map_chr(c(1, 2, 3, 4, 5), ~paste0("ID: ", .x))</span></span>
<span id="RN4Ecb51-3"><a href="#RN4Ecb51-3"></a><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb51-4"><a href="#RN4Ecb51-4"></a>  <span class="fu">map_chr</span>(<span class="sc">~</span><span class="fu">paste0</span>(<span class="st">"ID: "</span>, .x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ID: 1" "ID: 2" "ID: 3" "ID: 4" "ID: 5"</code></pre>
</div>
</div>
<hr></section><section id="RN4Esec-iteration-map2" class="level2" data-number="27.2"><h2 data-number="27.2" class="anchored" data-anchor-id="RN4Esec-iteration-map2">
<span class="header-section-number">27.2</span> 引数が2つ以上の場合</h2>
<p>{purrr}を使った本格的な例を紹介する前に、引数が2つ以上の場合を考えたいと思います。まずは引数が2つの場合です。この場合、<code>map2_*()</code>関数群を使用します。例えば、<code>num_vec</code>に長さ5のnumeric型ベクトル<code>num_vec2</code>をかける例を考えてみましょう。</p>
<p>この場合、データとして<code>num_vec</code>と<code>num_vec2</code>が必要となり、ラムダ式にも2つの引数が必要です。まず、<code>num_vec2</code>を用意します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb53-1"><a href="#RN4Ecb53-1"></a>num_vec2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>続いて<code>map2_dbl()</code>関数を使用し<code>num_vec</code>と<code>num_vec2</code>の掛け算を行います。<code>map2_*()</code>の使い方は<code>map_*()</code>とほぼ同様です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb54"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb54-1"><a href="#RN4Ecb54-1"></a><span class="fu">map2_dbl</span>(データ1, データ2, 関数 or ラムダ式, 追加の引数)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>map_*()</code>との違いとしては、(1) データが2つである、(2) 関数、またはラムダ式に2つの引数が必要である点です。この2点目の引数ですが、データ2は<code>.y</code>と表記します。したがって、データ1とデータ2の掛け算を意味するラムダ式は<code>~.x * .y</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb55"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb55-1"><a href="#RN4Ecb55-1"></a><span class="fu">map2_dbl</span>(num_vec, num_vec2, <span class="sc">~</span>.x <span class="sc">*</span> .y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 0 5 0 7</code></pre>
</div>
</div>
<p><code>num_vec</code>と<code>num_vec2</code>が必ずしも同じデータ構造、データ型、同じ長さである必要がありません。数字の前に<code>"ID:"</code>を付ける先ほどの例を<code>map2_chr()</code>で書いてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb57"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb57-1"><a href="#RN4Ecb57-1"></a><span class="fu">map2_chr</span>(num_vec, <span class="st">"ID:"</span>, <span class="sc">~</span><span class="fu">paste0</span>(.y, .x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ID:3" "ID:2" "ID:5" "ID:4" "ID:7"</code></pre>
</div>
</div>
<p>それでは3つ以上の引数について考えてみましょう。たとえば、<code>num_vec</code>の前に<code>"ID"</code>を付けるとします。そして<code>"ID"</code>と<code>num_vec</code>の間に<code>":"</code>を入れたい場合はどうすればい良いでしょう。むろん、賢い解決方法は単純に<code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code>関数を使うだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb59"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb59-1"><a href="#RN4Ecb59-1"></a><span class="fu">paste</span>(<span class="st">"ID"</span>, num_vec, <span class="at">sep =</span> <span class="st">":"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ID:3" "ID:2" "ID:5" "ID:4" "ID:7"</code></pre>
</div>
</div>
<p>この場合、引数は3つです<a href="#RN4Efn3" class="footnote-ref" id="RN4Efnref3" role="doc-noteref"><sup>3</sup></a>。この場合の書き方はどうなるでしょうか。<code>map2_*()</code>はデータを2つまでしか指定できません。3つ目以降は関数/ラムダ式の後ろに書くこととなります。ただし、関数/ラムダ式の後ろに指定される引数は長さ1のベクトルでなければなりません。また、ラムダ式内の引数は<code>.x</code>と<code>.y</code>でなく、<code>..1</code>、<code>..2</code>、<code>..3</code>、…となります。</p>
<p>今回の例だと<code>map2_chr()</code>内に<code>num_vec</code>がデータ1、<code>"ID"</code>がデータ2です。そして、期待される結果は、「“ID” + <code>sep</code>の実引数 + <code>num_vec</code>の値」となります。したがって、ラムダ式は<code>paste(..2, ..1, sep = ..3)</code>となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb61"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb61-1"><a href="#RN4Ecb61-1"></a><span class="fu">map2_chr</span>(num_vec, <span class="st">"ID"</span>, <span class="sc">~</span><span class="fu">paste</span>(..<span class="dv">2</span>, ..<span class="dv">1</span>, <span class="at">sep =</span> ..<span class="dv">3</span>), <span class="st">"-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ID-3" "ID-2" "ID-5" "ID-4" "ID-7"</code></pre>
</div>
</div>
<p>データ2である<code>"ID"</code>は長さ1のcharacter型ベクトルであるため、以下のように<code>map_chr()</code>を使うことも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb63"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb63-1"><a href="#RN4Ecb63-1"></a><span class="co"># データ2も長さ1なのでmap_chr()もOK</span></span>
<span id="RN4Ecb63-2"><a href="#RN4Ecb63-2"></a><span class="fu">map_chr</span>(num_vec, <span class="sc">~</span><span class="fu">paste</span>(..<span class="dv">2</span>, ..<span class="dv">1</span>, <span class="at">sep =</span> ..<span class="dv">3</span>), <span class="st">"ID"</span>, <span class="st">"-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ID-3" "ID-2" "ID-5" "ID-4" "ID-7"</code></pre>
</div>
</div>
<p>それではデータを3つ以上使うにはどうすれば良いでしょうか。そこで登場するのが<code>pmap_*()</code>関数です。以下の3つのベクトルを利用し、「名前:数学成績」を出力してみましょう。ただし、不正行為がある場合（<code>cheat_vec</code>の値が1）は成績が0点になるようにしましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb65"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb65-1"><a href="#RN4Ecb65-1"></a>name_vec  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Hadley"</span>, <span class="st">"Song"</span>, <span class="st">"Yanai"</span>)</span>
<span id="RN4Ecb65-2"><a href="#RN4Ecb65-2"></a>math_vec  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">70</span>, <span class="dv">55</span>, <span class="dv">80</span>)</span>
<span id="RN4Ecb65-3"><a href="#RN4Ecb65-3"></a>cheat_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>賢い解決法は普通に<code><a href="https://rdrr.io/r/base/paste.html">paste0()</a></code>関数を使う方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb66"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb66-1"><a href="#RN4Ecb66-1"></a><span class="fu">paste0</span>(name_vec, <span class="st">":"</span>, math_vec <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> cheat_vec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hadley:70" "Song:0"    "Yanai:80" </code></pre>
</div>
</div>
<p>今回はあえて<code>pmap_*()</code>関数を使ってみましょう。<code>pmap_*()</code>の場合、第一引数であるデータはリスト型で渡す必要があります。したがって、3つのベクトルを<code><a href="https://rdrr.io/r/base/list.html">list()</a></code>関数を用いてリスト化します。第二引数には既存の関数やラムダ式を入力し、各引数は<code>..1</code>、<code>..2</code>、…といった形で表記します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb68"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb68-1"><a href="#RN4Ecb68-1"></a><span class="fu">pmap_chr</span>(<span class="fu">list</span>(name_vec, math_vec, cheat_vec), </span>
<span id="RN4Ecb68-2"><a href="#RN4Ecb68-2"></a>         <span class="sc">~</span><span class="fu">paste0</span>(..<span class="dv">1</span>, <span class="st">":"</span>, ..<span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> ..<span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hadley:70" "Song:0"    "Yanai:80" </code></pre>
</div>
</div>
<p>第一引数はデータであるため、まずリストを作成し、パイプ演算子（<code>%&gt;%</code>）で<code>pmap_*()</code>に渡すことも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb70"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb70-1"><a href="#RN4Ecb70-1"></a><span class="fu">list</span>(name_vec, math_vec, cheat_vec) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb70-2"><a href="#RN4Ecb70-2"></a>  <span class="fu">pmap_chr</span>(<span class="sc">~</span><span class="fu">paste0</span>(..<span class="dv">1</span>, <span class="st">":"</span>, ..<span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> ..<span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hadley:70" "Song:0"    "Yanai:80" </code></pre>
</div>
</div>
<hr></section><section id="RN4Esec-iteration-df" class="level2" data-number="27.3"><h2 data-number="27.3" class="anchored" data-anchor-id="RN4Esec-iteration-df">
<span class="header-section-number">27.3</span> データフレームと{purrr}</h2>
<p><code>map_*()</code>関数のデータとしてデータフレームを渡すことも可能です。ここでは5行3列のデータフレームを作成してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb72"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb72-1"><a href="#RN4Ecb72-1"></a>Dummy_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="fu">seq</span>(<span class="dv">1</span>,  <span class="dv">5</span>,  <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="RN4Ecb72-2"><a href="#RN4Ecb72-2"></a>                       <span class="at">Y =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">10</span>),</span>
<span id="RN4Ecb72-3"><a href="#RN4Ecb72-3"></a>                       <span class="at">Z =</span> <span class="fu">seq</span>(<span class="dv">2</span>,  <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>各行の<code>X</code>、<code>Y</code>、<code>Z</code>の合計を計算するには{dplyr}の<code>rowwise()</code>と<code>mutate()</code>を組み合わせることで計算出来ることを第<a href="#RN4Esec-handling2-rowwise"><span>13.4</span></a>章で紹介しました。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb73"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb73-1"><a href="#RN4Ecb73-1"></a>Dummy_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb73-2"><a href="#RN4Ecb73-2"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb73-3"><a href="#RN4Ecb73-3"></a>  <span class="fu">mutate</span>(<span class="at">Sum =</span> <span class="fu">sum</span>(X, Y, Z)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb73-4"><a href="#RN4Ecb73-4"></a>  <span class="co"># rowwise()は1行を1グループとする関数であるため、最後にグループ化を解除</span></span>
<span id="RN4Ecb73-5"><a href="#RN4Ecb73-5"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
      X     Y     Z   Sum
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1    10     2    13
2     2    20     4    26
3     3    30     6    39
4     4    40     8    52
5     5    50    10    65</code></pre>
</div>
</div>
<p>それでは各列の平均値を計算するにはどうすれば良いでしょうか。ここではR内蔵関数である<code><a href="https://rdrr.io/r/base/colSums.html">colMeans()</a></code>を使わないことにしましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb75"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb75-1"><a href="#RN4Ecb75-1"></a><span class="fu">colMeans</span>(Dummy_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> X  Y  Z 
 3 30  6 </code></pre>
</div>
</div>
<p>まず、<code>mean(Dummy_df$X)</code>を3回実行する方法や、{dplyr}の<code>summarise()</code>関数を使う方法があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb77"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb77-1"><a href="#RN4Ecb77-1"></a>Dummy_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb77-2"><a href="#RN4Ecb77-2"></a>  <span class="fu">summarise</span>(<span class="at">X =</span> <span class="fu">mean</span>(X), </span>
<span id="RN4Ecb77-3"><a href="#RN4Ecb77-3"></a>            <span class="at">Y =</span> <span class="fu">mean</span>(Y),</span>
<span id="RN4Ecb77-4"><a href="#RN4Ecb77-4"></a>            <span class="at">Z =</span> <span class="fu">mean</span>(Z))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  X  Y Z
1 3 30 6</code></pre>
</div>
</div>
<p>実はこの操作、<code>map_dbl()</code>関数を使えば、より簡単です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb79"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb79-1"><a href="#RN4Ecb79-1"></a><span class="fu">map_dbl</span>(Dummy_df, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> X  Y  Z 
 3 30  6 </code></pre>
</div>
</div>
<p><code>map_dbl()</code>はnumeric (double) 型ベクトルを返しますが、データフレーム（具体的にはtibble）に返すなら<code>map_df()</code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb81"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb81-1"><a href="#RN4Ecb81-1"></a><span class="fu">map_df</span>(Dummy_df, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
      X     Y     Z
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     3    30     6</code></pre>
</div>
</div>
<p>なぜこれが出来るでしょうか。これを理解するためにはデータフレームとtibbleが本質的にはリスト型と同じであることを理解する必要があります。たとえば、以下のようなリストについて考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb83"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb83-1"><a href="#RN4Ecb83-1"></a>Dummy_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">X =</span> <span class="fu">seq</span>(<span class="dv">1</span>,  <span class="dv">5</span>,  <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="RN4Ecb83-2"><a href="#RN4Ecb83-2"></a>                   <span class="at">Y =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">10</span>),</span>
<span id="RN4Ecb83-3"><a href="#RN4Ecb83-3"></a>                   <span class="at">Z =</span> <span class="fu">seq</span>(<span class="dv">2</span>,  <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">2</span>))</span>
<span id="RN4Ecb83-4"><a href="#RN4Ecb83-4"></a></span>
<span id="RN4Ecb83-5"><a href="#RN4Ecb83-5"></a>Dummy_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$X
[1] 1 2 3 4 5

$Y
[1] 10 20 30 40 50

$Z
[1]  2  4  6  8 10</code></pre>
</div>
</div>
<p>この<code>Dummy_list</code>を<code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code>関数を使用して強制的にデータフレームに変換してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb85"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb85-1"><a href="#RN4Ecb85-1"></a><span class="fu">as.data.frame</span>(Dummy_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10</code></pre>
</div>
</div>
<p><code>Dummy_df</code>と同じものが出てきました。逆に<code>Dummy_df</code>を、<code><a href="https://rdrr.io/r/base/list.html">as.list()</a></code>を使用してリストに変換すると<code>Dummy_list</code>と同じものが返されます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb87"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb87-1"><a href="#RN4Ecb87-1"></a><span class="fu">as.list</span>(Dummy_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$X
[1] 1 2 3 4 5

$Y
[1] 10 20 30 40 50

$Z
[1]  2  4  6  8 10</code></pre>
</div>
</div>
<p>ここまで理解できれば、<code>map_*()</code>関数のデータがデータフレームの場合、内部ではリストとして扱われることが分かるでしょう。実際、<code>Dummy_list</code>をデータとして入れても<code>Dummy_df</code>を入れた結果と同じものが得られます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb89"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb89-1"><a href="#RN4Ecb89-1"></a><span class="fu">map_df</span>(Dummy_list, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
      X     Y     Z
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     3    30     6</code></pre>
</div>
</div>
<section id="RN4Esec-iteration-tibble" class="level3" data-number="27.3.1"><h3 data-number="27.3.1" class="anchored" data-anchor-id="RN4Esec-iteration-tibble">
<span class="header-section-number">27.3.1</span> tibbleの話</h3>
<p>ここまで「データフレーム」と「tibble」を区別せずに説明してきましたが、これからの話しではこの2つを区別する必要があります。tibbleは{tidyverse}のコアパッケージの一つである{tibble}が提供するデータ構造であり、データフレームの上位互換です。tibbleもデータフレーム同様、本質的にはリストですが、リストの構造をより的確に表すことが出来ます。</p>
<p>データフレームをリストとして考える場合、リストの各要素は<strong>必ずベクトル</strong>である必要があります。たとえば、<code>Dummy_list</code>には3つの要素があり、それぞれ長さ5のベクトルです。一方、リストの中にはリストを入れることも出来ます。たとえば、以下のような<code>Dummy_list2</code>について考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb91-1"><a href="#RN4Ecb91-1"></a>Dummy_list2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ID   =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, </span>
<span id="RN4Ecb91-2"><a href="#RN4Ecb91-2"></a>                    <span class="at">Data =</span> <span class="fu">list</span>(Dummy_df, Dummy_df, Dummy_df))</span>
<span id="RN4Ecb91-3"><a href="#RN4Ecb91-3"></a></span>
<span id="RN4Ecb91-4"><a href="#RN4Ecb91-4"></a>Dummy_list2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ID
[1] 1 2 3

$Data
$Data[[1]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10

$Data[[2]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10

$Data[[3]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10</code></pre>
</div>
</div>
<p><code>Dummy_list2</code>には2つの要素があり、最初の要素は長さ3のベクトル、2つ目の要素は長さ3のリストです。2つ目の要素がベクトルでないため、<code>Dummy_list2</code>をデータフレームに変換することはできません。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb93"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb93-1"><a href="#RN4Ecb93-1"></a>Dummy_df2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(Dummy_list2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in (function (..., row.names = NULL, check.rows = FALSE, check.names = TRUE, : arguments imply differing number of rows: 3, 5</code></pre>
</div>
</div>
<p>一方、<code>as_tibble()</code>を使用してtibble型に変換することは可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb95"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb95-1"><a href="#RN4Ecb95-1"></a>Dummy_tibble <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(Dummy_list2)</span>
<span id="RN4Ecb95-2"><a href="#RN4Ecb95-2"></a></span>
<span id="RN4Ecb95-3"><a href="#RN4Ecb95-3"></a>Dummy_tibble</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
     ID Data        
  &lt;int&gt; &lt;list&gt;      
1     1 &lt;df [5 × 3]&gt;
2     2 &lt;df [5 × 3]&gt;
3     3 &lt;df [5 × 3]&gt;</code></pre>
</div>
</div>
<p>2列目の各セルには5行3列のデータフレーム（<code>df</code>）が格納されていることが分かります。たとえば、<code>Dummy_tibble</code>の<code>Data</code>列を抽出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb97"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb97-1"><a href="#RN4Ecb97-1"></a>Dummy_tibble<span class="sc">$</span>Data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10

[[2]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10

[[3]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10</code></pre>
</div>
</div>
<p>長さ3のリスト出力されます。続いて、<code>Dummy_tibble$Data</code>の2番目のセルを抽出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb99"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb99-1"><a href="#RN4Ecb99-1"></a>Dummy_tibble<span class="sc">$</span>Data[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  X  Y  Z
1 1 10  2
2 2 20  4
3 3 30  6
4 4 40  8
5 5 50 10</code></pre>
</div>
</div>
<p>データフレームが出力されました。簡単にまとめるとtibbleはデータフレームの中にデータフレームを入れることが出来るデータ構造です。むろん、これまでの通り、データフレームのように使うことも可能です<a href="#RN4Efn4" class="footnote-ref" id="RN4Efnref4" role="doc-noteref"><sup>4</sup></a>。これがtibbleの強みでもあり、{purrr}との相性も非常に高いです。たとえば、<code>Data</code>列を<code>map()</code>関数のデータとして渡せば、複数のデータセットに対して同じモデルの推定が出来るようになります。以下ではその例を紹介します。</p>
<hr></section></section><section id="RN4Esec-iteration-model1" class="level2" data-number="27.4"><h2 data-number="27.4" class="anchored" data-anchor-id="RN4Esec-iteration-model1">
<span class="header-section-number">27.4</span> モデルの反復推定</h2>
<p>ここからは<code>map_*()</code>関数群を使って複数のモデルを素早く推定する方法について解説します。サンプルデータは第<a href="#RN4Esec-visualization2"><span>18</span></a>章で使いました各国の政治経済データ（<code>Countries.csv</code>）を使用します。csv形式データ読み込みの際、これまではR内蔵関数である<code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>と{readr}<a href="#RN4Efn5" class="footnote-ref" id="RN4Efnref5" role="doc-noteref"><sup>5</sup></a>の<code>read_csv()</code>を区別せずに使用してきました。しかし、ここからは<code>read_csv()</code>を使用します。2つの使い方はほぼ同じですが、<code>read_csv()</code>は各列のデータ型を自動的に指定してくれるだけではなく、tibble構造として読み込みます。<code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>を使用する場合、<code>as_tibble(データフレーム名)</code>でデータフレームをtibbleに変換してください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb101"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb101-1"><a href="#RN4Ecb101-1"></a>Country_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Countries.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="RN4Esec-iteration-split1" class="level3" data-number="27.4.1"><h3 data-number="27.4.1" class="anchored" data-anchor-id="RN4Esec-iteration-split1">
<span class="header-section-number">27.4.1</span> サンプルの分割とモデル推定（<code>split()</code>利用）</h3>
<p>まずは、サンプルを分割し、それぞれの下位サンプルを使った分析を繰り返す方法について解説します。サンプルを分割する方法は2つありますが、最初はR内蔵関数である<code><a href="https://rdrr.io/r/base/split.html">split()</a></code>関数を使った方法について紹介します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb102"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb102-1"><a href="#RN4Ecb102-1"></a><span class="co"># split()の使い方</span></span>
<span id="RN4Ecb102-2"><a href="#RN4Ecb102-2"></a>新しいオブジェクト名 <span class="ot">&lt;-</span> <span class="fu">split</span>(データ名, 分割の基準となるベクトル)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>たとえば、<code>Country_df</code>を大陸ごとにサンプルを分けるとします。大陸を表すベクトルは<code>Country_df$Continent</code>です。したがって、以下のように入力します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb103"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb103-1"><a href="#RN4Ecb103-1"></a>Split_Data <span class="ot">&lt;-</span> <span class="fu">split</span>(Country_df, Country_df<span class="sc">$</span>Continent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>サンプルが分割された<code>Split_Data</code>のデータ構造はリスト型です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb104"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb104-1"><a href="#RN4Ecb104-1"></a><span class="fu">class</span>(Split_Data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
</div>
<p>中身を見るとリストの各要素としてtibble（データフレーム）が格納されています。リストの中にはあらゆるデータ型、データ構造を入れることができることが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb106"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb106-1"><a href="#RN4Ecb106-1"></a>Split_Data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Africa
# A tibble: 54 × 18
   Country        Popul…¹   Area    GDP    PPP GDP_p…² PPP_p…³    G7   G20  OECD
   &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Algeria         4.39e7 2.38e6 1.70e5 4.97e5   3876.  11324.     0     0     0
 2 Angola          3.29e7 1.25e6 9.46e4 2.19e5   2879.   6649.     0     0     0
 3 Benin           1.21e7 1.13e5 1.44e4 3.72e4   1187.   3067.     0     0     0
 4 Botswana        2.35e6 5.67e5 1.83e4 4.07e4   7799.  17311.     0     0     0
 5 Burkina Faso    2.09e7 2.74e5 1.57e4 3.76e4    753.   1800.     0     0     0
 6 Burundi         1.19e7 2.57e4 3.01e3 8.72e3    253.    733.     0     0     0
 7 Cabo Verde      5.56e5 4.03e3 1.98e3 3.84e3   3565.   6913.     0     0     0
 8 Cameroon        2.65e7 4.73e5 3.88e4 9.31e4   1460.   3506.     0     0     0
 9 Central Afric…  4.83e6 6.23e5 2.22e3 4.46e3    460.    924.     0     0     0
10 Chad            1.64e7 1.26e6 1.13e4 2.51e4    689.   1525.     0     0     0
# … with 44 more rows, 8 more variables: HDI_2018 &lt;dbl&gt;, Polity_Score &lt;dbl&gt;,
#   Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;, FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;,
#   FH_Status &lt;chr&gt;, Continent &lt;chr&gt;, and abbreviated variable names
#   ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita

$America
# A tibble: 36 × 18
   Country        Popul…¹   Area    GDP    PPP GDP_p…² PPP_p…³    G7   G20  OECD
   &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Antigua and B…  9.79e4 4.4 e2 1.73e3 2.08e3  17643.  21267.     0     0     0
 2 Argentina       4.52e7 2.74e6 4.50e5 1.04e6   9949.  22938.     0     1     0
 3 Bahamas         3.93e5 1.00e4 1.28e4 1.40e4  32618.  35662.     0     0     0
 4 Barbados        2.87e5 4.3 e2 5.21e3 4.62e3  18126.  16066.     0     0     0
 5 Belize          3.98e5 2.28e4 1.88e3 2.82e3   4727.   7091.     0     0     0
 6 Bolivia         1.17e7 1.08e6 4.09e4 1.01e5   3503.   8623.     0     0     0
 7 Brazil          2.13e8 8.36e6 1.84e6 3.13e6   8655.  14734.     0     1     0
 8 Canada          3.77e7 9.09e6 1.74e6 1.85e6  46008.  49088.     1     1     1
 9 Chile           1.91e7 7.44e5 2.82e5 4.64e5  14769.  24262.     0     0     1
10 Colombia        5.09e7 1.11e6 3.24e5 7.37e5   6364.  14475.     0     0     1
# … with 26 more rows, 8 more variables: HDI_2018 &lt;dbl&gt;, Polity_Score &lt;dbl&gt;,
#   Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;, FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;,
#   FH_Status &lt;chr&gt;, Continent &lt;chr&gt;, and abbreviated variable names
#   ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita

$Asia
# A tibble: 42 × 18
   Country     Population   Area    GDP    PPP GDP_p…¹ PPP_p…²    G7   G20  OECD
   &lt;chr&gt;            &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Afghanistan   38928346 6.53e5 1.91e4 8.27e4    491.   2125.     0     0     0
 2 Bahrain        1701575 7.6 e2 3.86e4 7.42e4  22670.  43624.     0     0     0
 3 Bangladesh   164689383 1.30e5 3.03e5 7.34e5   1837.   4458.     0     0     0
 4 Bhutan          771608 3.81e4 2.45e3 8.77e3   3171.  11363.     0     0     0
 5 Brunei          437479 5.27e3 1.35e4 2.65e4  30789.  60656.     0     0     0
 6 Burma         54409800 6.53e5 7.61e4 2.68e5   1398.   4932.     0     0     0
 7 Cambodia      16718965 1.77e5 2.71e4 6.93e4   1620.   4142.     0     0     0
 8 China       1447470092 9.39e6 1.48e7 2.20e7  10199.  15177.     0     1     0
 9 India       1380004385 2.97e6 2.88e6 9.06e6   2083.   6564.     0     1     0
10 Indonesia    273523615 1.81e6 1.12e6 3.12e6   4092.  11397.     0     1     0
# … with 32 more rows, 8 more variables: HDI_2018 &lt;dbl&gt;, Polity_Score &lt;dbl&gt;,
#   Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;, FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;,
#   FH_Status &lt;chr&gt;, Continent &lt;chr&gt;, and abbreviated variable names
#   ¹​GDP_per_capita, ²​PPP_per_capita

$Europe
# A tibble: 50 × 18
   Country       Popul…¹   Area    GDP     PPP GDP_p…² PPP_p…³    G7   G20  OECD
   &lt;chr&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Albania        2.88e6  27400 1.53e4  39658.   5309.  13781.     0     0     0
 2 Andorra        7.73e4    470 3.15e3     NA   40821.     NA      0     0     0
 3 Armenia        2.96e6  28470 1.37e4  38446.   4614.  12974.     0     0     0
 4 Austria        9.01e6  82409 4.46e5 502771.  49555.  55824.     0     0     1
 5 Azerbaijan     1.01e7  82658 4.80e4 144556.   4739.  14257.     0     0     0
 6 Belarus        9.45e6 202910 6.31e4 183461.   6676.  19415.     0     0     0
 7 Belgium        1.16e7  30280 5.30e5 597433.  45697.  51549.     0     0     1
 8 Bosnia and H…  3.28e6  51000 2.00e4  49733.   6111.  15159.     0     0     0
 9 Bulgaria       6.95e6 108560 6.79e4 156693.   9776.  22551.     0     0     0
10 Croatia        4.11e6  55960 6.04e4 114932.  14717.  27996.     0     0     0
# … with 40 more rows, 8 more variables: HDI_2018 &lt;dbl&gt;, Polity_Score &lt;dbl&gt;,
#   Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;, FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;,
#   FH_Status &lt;chr&gt;, Continent &lt;chr&gt;, and abbreviated variable names
#   ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita

$Oceania
# A tibble: 4 × 18
  Country Popul…¹   Area    GDP    PPP GDP_p…² PPP_p…³    G7   G20  OECD HDI_2…⁴
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Austra…  2.55e7 7.68e6 1.39e6 1.28e6  54615.  50001.     0     1     1   0.938
2 Fiji     8.96e5 1.83e4 5.54e3 1.25e4   6175.  13940.     0     0     0   0.724
3 New Ze…  4.84e6 2.64e5 2.07e5 2.04e5  42729.  42178.     0     0     1   0.921
4 Papua …  8.95e6 4.53e5 2.50e4 3.73e4   2791.   4171.     0     0     0   0.543
# … with 7 more variables: Polity_Score &lt;dbl&gt;, Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;,
#   FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;, FH_Status &lt;chr&gt;, Continent &lt;chr&gt;, and
#   abbreviated variable names ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita,
#   ⁴​HDI_2018</code></pre>
</div>
</div>
<p>それでは分割された各サンプルに対して<code>Polity_Score</code>と<code>FH_Total</code>の相関係数を計算してみましょう。その前に相関分析の方法について調べてみましょう。Rには相関分析の関数が2つ用意されています。単純に相関係数のみを計算するなら<code><a href="https://rdrr.io/r/stats/cor.html">cor()</a></code>、係数の不確実性（標準誤差、信頼区間など）まで計算し、検定を行うなら<code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code>を使用します。ここではより汎用性の高い<code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code>の使い方について紹介します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb108"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb108-1"><a href="#RN4Ecb108-1"></a><span class="co"># 相関分析: 方法1</span></span>
<span id="RN4Ecb108-2"><a href="#RN4Ecb108-2"></a><span class="fu">cor.test</span>(<span class="sc">~</span> 変数名1 <span class="sc">+</span> 変数名2, <span class="at">data =</span> データ名)</span>
<span id="RN4Ecb108-3"><a href="#RN4Ecb108-3"></a></span>
<span id="RN4Ecb108-4"><a href="#RN4Ecb108-4"></a><span class="co"># 相関分析: 方法2</span></span>
<span id="RN4Ecb108-5"><a href="#RN4Ecb108-5"></a><span class="fu">cor.test</span>(データ名<span class="sc">$</span>変数名1, データ名<span class="sc">$</span>変数名2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>それでは全サンプルに対して相関分析をしてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb109"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb109-1"><a href="#RN4Ecb109-1"></a>Cor_fit1 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, <span class="at">data =</span> Country_df)</span>
<span id="RN4Ecb109-2"><a href="#RN4Ecb109-2"></a>Cor_fit1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 19.494, df = 156, p-value &lt; 2.2e-16
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.7896829 0.8821647
sample estimates:
      cor 
0.8420031 </code></pre>
</div>
</div>
<p>ここから相関係数（0.8420031）のみを抽出するにはどうすれば良いでしょうか。それを確認するためには<code>Cor_fit1</code>というオブジェクトの構造を調べる必要があります。ここではR内蔵関数である<code><a href="https://rdrr.io/r/utils/str.html">str()</a></code>を使って確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb111"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb111-1"><a href="#RN4Ecb111-1"></a><span class="fu">str</span>(Cor_fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 9
 $ statistic  : Named num 19.5
  ..- attr(*, "names")= chr "t"
 $ parameter  : Named int 156
  ..- attr(*, "names")= chr "df"
 $ p.value    : num 1.16e-43
 $ estimate   : Named num 0.842
  ..- attr(*, "names")= chr "cor"
 $ null.value : Named num 0
  ..- attr(*, "names")= chr "correlation"
 $ alternative: chr "two.sided"
 $ method     : chr "Pearson's product-moment correlation"
 $ data.name  : chr "Polity_Score and FH_Total"
 $ conf.int   : num [1:2] 0.79 0.882
  ..- attr(*, "conf.level")= num 0.95
 - attr(*, "class")= chr "htest"</code></pre>
</div>
</div>
<p>相関係数は<code>$estimate</code>で抽出できそうですね。実際に<code>Cor_fit1</code>から相関係数のみ抽出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb113"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb113-1"><a href="#RN4Ecb113-1"></a>Cor_fit1<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      cor 
0.8420031 </code></pre>
</div>
</div>
<p>それでは<code>map()</code>関数を利用して分割された各サンプルを対象に<code>Polity_Score</code>と<code>FH_Total</code>の相関係数を計算してみましょう。<code>map()</code>のデータは<code>Split_Data</code>とし、関数はラムダ式を書いてみましょう。<code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code>内<code>data</code>引数の実引数は<code>.x</code>、または<code>..1</code>となります。最後に<code>map_dbl("estimate")</code>を利用し、相関係数を抽出、numeric (double) 型ベクトルとして出力します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb115"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb115-1"><a href="#RN4Ecb115-1"></a>Cor_fit2 <span class="ot">&lt;-</span> Split_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb115-2"><a href="#RN4Ecb115-2"></a>  <span class="fu">map</span>(<span class="sc">~</span><span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, <span class="at">data =</span> .x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb116"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb116-1"><a href="#RN4Ecb116-1"></a><span class="co"># Cor_fit2から相関係数のみ出力</span></span>
<span id="RN4Ecb116-2"><a href="#RN4Ecb116-2"></a><span class="fu">map_dbl</span>(Cor_fit2, <span class="st">"estimate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Africa   America      Asia    Europe   Oceania 
0.7612138 0.8356899 0.8338172 0.8419547 0.9960776 </code></pre>
</div>
</div>
<p>もし、小数点3位までの<em>p</em>値が欲しい場合は以下のように入力します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb118"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb118-1"><a href="#RN4Ecb118-1"></a><span class="co"># Cor_fit2から相関係数のp値を抽出し、小数点3位に丸める</span></span>
<span id="RN4Ecb118-2"><a href="#RN4Ecb118-2"></a><span class="fu">map_dbl</span>(Cor_fit2, <span class="st">"p.value"</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Africa America    Asia  Europe Oceania 
  0.000   0.000   0.000   0.000   0.004 </code></pre>
</div>
</div>
</section><section id="RN4Esec-iteration-split2" class="level3" data-number="27.4.2"><h3 data-number="27.4.2" class="anchored" data-anchor-id="RN4Esec-iteration-split2">
<span class="header-section-number">27.4.2</span> サンプルの分割とモデル推定（<code>nest()</code>利用）</h3>
<p>それではデータフレーム内にデータフレームが格納可能なtibble構造の長所を活かした方法について解説します。ある変数に応じてデータをグループ化する方法については第<a href="#RN4Esec-handling2-group"><span>13.2</span></a>章で解説しました。{tidyr}パッケージにはグループごとにデータを分割し、分割されたデータを各セルに埋め込む<code>nest()</code>関数を提供しています。具体的な動きを見るために、とりあえず、<code>Country_df</code>を大陸（<code>Continent</code>）ごとに分割し、それぞれがデータが一つのセルに埋め込まれた新しいデータセット、<code>Nested_Data</code>を作ってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb120"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb120-1"><a href="#RN4Ecb120-1"></a>Nested_Data <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span> </span>
<span id="RN4Ecb120-2"><a href="#RN4Ecb120-2"></a>  <span class="fu">group_by</span>(Continent) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb120-3"><a href="#RN4Ecb120-3"></a>  <span class="fu">nest</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ちなみに<code>group_by()</code>と<code>nest()</code>は<code>group_nest()</code>を使って以下のようにまとめることも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb121"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb121-1"><a href="#RN4Ecb121-1"></a>Nested_Data <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span> </span>
<span id="RN4Ecb121-2"><a href="#RN4Ecb121-2"></a>  <span class="fu">group_nest</span>(Continent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb122"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb122-1"><a href="#RN4Ecb122-1"></a>Nested_Data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
# Groups:   Continent [5]
  Continent data              
  &lt;chr&gt;     &lt;list&gt;            
1 Asia      &lt;tibble [42 × 17]&gt;
2 Europe    &lt;tibble [50 × 17]&gt;
3 Africa    &lt;tibble [54 × 17]&gt;
4 America   &lt;tibble [36 × 17]&gt;
5 Oceania   &lt;tibble [4 × 17]&gt; </code></pre>
</div>
</div>
<p>2列目の<code>data</code>変数の各セルにtibbleが埋め込まれたことがわかります。<code>Nested_Data</code>の<code>data</code>列から5つ目の要素（オセアニアのデータ）を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb124"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb124-1"><a href="#RN4Ecb124-1"></a><span class="co"># Nested_Data$data[5]の場合、長さ1のリストが出力される</span></span>
<span id="RN4Ecb124-2"><a href="#RN4Ecb124-2"></a><span class="co"># tibble構造で出力する場合は[5]でなく、[[5]]で抽出</span></span>
<span id="RN4Ecb124-3"><a href="#RN4Ecb124-3"></a>Nested_Data<span class="sc">$</span>data[[<span class="dv">5</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 17
  Country Popul…¹   Area    GDP    PPP GDP_p…² PPP_p…³    G7   G20  OECD HDI_2…⁴
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Austra…  2.55e7 7.68e6 1.39e6 1.28e6  54615.  50001.     0     1     1   0.938
2 Fiji     8.96e5 1.83e4 5.54e3 1.25e4   6175.  13940.     0     0     0   0.724
3 New Ze…  4.84e6 2.64e5 2.07e5 2.04e5  42729.  42178.     0     0     1   0.921
4 Papua …  8.95e6 4.53e5 2.50e4 3.73e4   2791.   4171.     0     0     0   0.543
# … with 6 more variables: Polity_Score &lt;dbl&gt;, Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;,
#   FH_CL &lt;dbl&gt;, FH_Total &lt;dbl&gt;, FH_Status &lt;chr&gt;, and abbreviated variable
#   names ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita, ⁴​HDI_2018</code></pre>
</div>
</div>
<p><code>Continent</code>がOceaniaの行の<code>data</code>列にオセアニアのみのデータが格納されていることが分かります。このようなデータ構造を入れ子型データ（nested data）と呼びます。この入れ子型データは<code>unnest()</code>関数を使って解除することも可能です。<code>unnest()</code>関数を使う際はどの列を解除するかを指定する必要があり、今回は<code>data</code>列となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb126"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb126-1"><a href="#RN4Ecb126-1"></a><span class="co"># 入れ子型データの解除</span></span>
<span id="RN4Ecb126-2"><a href="#RN4Ecb126-2"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb126-3"><a href="#RN4Ecb126-3"></a>  <span class="fu">unnest</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 186 × 18
# Groups:   Continent [5]
   Continent Country    Popul…¹   Area    GDP    PPP GDP_p…² PPP_p…³    G7   G20
   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Asia      Afghanist…  3.89e7 6.53e5 1.91e4 8.27e4    491.   2125.     0     0
 2 Asia      Bahrain     1.70e6 7.6 e2 3.86e4 7.42e4  22670.  43624.     0     0
 3 Asia      Bangladesh  1.65e8 1.30e5 3.03e5 7.34e5   1837.   4458.     0     0
 4 Asia      Bhutan      7.72e5 3.81e4 2.45e3 8.77e3   3171.  11363.     0     0
 5 Asia      Brunei      4.37e5 5.27e3 1.35e4 2.65e4  30789.  60656.     0     0
 6 Asia      Burma       5.44e7 6.53e5 7.61e4 2.68e5   1398.   4932.     0     0
 7 Asia      Cambodia    1.67e7 1.77e5 2.71e4 6.93e4   1620.   4142.     0     0
 8 Asia      China       1.45e9 9.39e6 1.48e7 2.20e7  10199.  15177.     0     1
 9 Asia      India       1.38e9 2.97e6 2.88e6 9.06e6   2083.   6564.     0     1
10 Asia      Indonesia   2.74e8 1.81e6 1.12e6 3.12e6   4092.  11397.     0     1
# … with 176 more rows, 8 more variables: OECD &lt;dbl&gt;, HDI_2018 &lt;dbl&gt;,
#   Polity_Score &lt;dbl&gt;, Polity_Type &lt;chr&gt;, FH_PR &lt;dbl&gt;, FH_CL &lt;dbl&gt;,
#   FH_Total &lt;dbl&gt;, FH_Status &lt;chr&gt;, and abbreviated variable names
#   ¹​Population, ²​GDP_per_capita, ³​PPP_per_capita</code></pre>
</div>
</div>
<p>{dplyr}の<code>group_by()</code>関数と{tidyr}の<code>nest()</code>、<code>unnest()</code>関数を組み合わせることでデータを入れ子型データへ変換したり、解除することができます。以上の流れを図式化したものが以下の <a href="#RN4Efig-nested_data">図&nbsp;<span>27.2</span></a> です。</p>
<div id="RN4Efig-nested_data" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="Figs/Iteration/nested_data.png" class="img-fluid figure-img" style="width:85.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.2: 入れ子型データの生成過程</figcaption><p></p>
</figure>
</div>
<p>それではこの入れ子型データを使用して大陸ごとの<code>Polity_Score</code>と<code>FH_Total</code>の相関係数を計算してみましょう。<code>data</code>列をデータとした相関係数のラムダ式はどう書けば良いでしょうか。これまでの内容が理解できましたら、答えは難しくないでしょう。<code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code>関数の<code>data</code>引数の実引数として<code>.x</code>を指定するだけです。この結果を<code>Cor_test</code>という列として追加し、<code>Nested_Data2</code>という名のオブジェクトとして保存します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb128"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb128-1"><a href="#RN4Ecb128-1"></a>Nested_Data2 <span class="ot">&lt;-</span> Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb128-2"><a href="#RN4Ecb128-2"></a>  <span class="fu">mutate</span>(<span class="at">Cor_test =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, <span class="at">data =</span> .x)))</span>
<span id="RN4Ecb128-3"><a href="#RN4Ecb128-3"></a></span>
<span id="RN4Ecb128-4"><a href="#RN4Ecb128-4"></a>Nested_Data2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   Continent [5]
  Continent data               Cor_test
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;  
1 Asia      &lt;tibble [42 × 17]&gt; &lt;htest&gt; 
2 Europe    &lt;tibble [50 × 17]&gt; &lt;htest&gt; 
3 Africa    &lt;tibble [54 × 17]&gt; &lt;htest&gt; 
4 America   &lt;tibble [36 × 17]&gt; &lt;htest&gt; 
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;htest&gt; </code></pre>
</div>
</div>
<p><code>Cor_test</code>という列が追加され、htestというクラス（S3クラス）オブジェクトが格納されていることが分かります。ちゃんと相関分析のオブジェクトが格納されているか、確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb130"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb130-1"><a href="#RN4Ecb130-1"></a>Nested_Data2<span class="sc">$</span>Cor_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 9.0626, df = 36, p-value = 8.05e-11
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.7009872 0.9107368
sample estimates:
      cor 
0.8338172 


[[2]]

    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 9.7452, df = 39, p-value = 5.288e-12
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.7210854 0.9130896
sample estimates:
      cor 
0.8419547 


[[3]]

    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 7.9611, df = 46, p-value = 3.375e-10
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.6087424 0.8594586
sample estimates:
      cor 
0.7612138 


[[4]]

    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 7.6082, df = 25, p-value = 5.797e-08
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.6677292 0.9226837
sample estimates:
      cor 
0.8356899 


[[5]]

    Pearson's product-moment correlation

data:  Polity_Score and FH_Total
t = 15.92, df = 2, p-value = 0.003922
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.8197821 0.9999220
sample estimates:
      cor 
0.9960776 </code></pre>
</div>
</div>
<p>5つの相関分析結果が格納されています。続いて、ここから相関係数のみを抽出してみましょう。相関分析オブジェクトから相関係数を抽出するには<code>オブジェクト名$estimate</code>だけで十分です。<code>mpa_*()</code>関数を使うなら第2引数として関数やラムダ式を指定せず、<code>"estimate"</code>のみ入力するだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb132"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb132-1"><a href="#RN4Ecb132-1"></a>Nested_Data2 <span class="ot">&lt;-</span> Nested_Data2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb132-2"><a href="#RN4Ecb132-2"></a>  <span class="fu">mutate</span>(<span class="at">Cor_coef =</span> <span class="fu">map</span>(Cor_test, <span class="st">"estimate"</span>))</span>
<span id="RN4Ecb132-3"><a href="#RN4Ecb132-3"></a></span>
<span id="RN4Ecb132-4"><a href="#RN4Ecb132-4"></a>Nested_Data2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
# Groups:   Continent [5]
  Continent data               Cor_test Cor_coef 
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;   &lt;list&gt;   
1 Asia      &lt;tibble [42 × 17]&gt; &lt;htest&gt;  &lt;dbl [1]&gt;
2 Europe    &lt;tibble [50 × 17]&gt; &lt;htest&gt;  &lt;dbl [1]&gt;
3 Africa    &lt;tibble [54 × 17]&gt; &lt;htest&gt;  &lt;dbl [1]&gt;
4 America   &lt;tibble [36 × 17]&gt; &lt;htest&gt;  &lt;dbl [1]&gt;
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;htest&gt;  &lt;dbl [1]&gt;</code></pre>
</div>
</div>
<p><code>Cor_coef</code>列が追加され、それぞれのセルにnumeric型の値が格納されていることが分かります。<code>map()</code>関数はリスト型でデータを返すため、このように出力されます。この<code>Cor_coef</code>列の入れ子構造を解除してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb134"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb134-1"><a href="#RN4Ecb134-1"></a>Nested_Data2 <span class="ot">&lt;-</span> Nested_Data2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb134-2"><a href="#RN4Ecb134-2"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Cor_coef)</span>
<span id="RN4Ecb134-3"><a href="#RN4Ecb134-3"></a></span>
<span id="RN4Ecb134-4"><a href="#RN4Ecb134-4"></a>Nested_Data2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
# Groups:   Continent [5]
  Continent data               Cor_test Cor_coef
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;      &lt;dbl&gt;
1 Asia      &lt;tibble [42 × 17]&gt; &lt;htest&gt;     0.834
2 Europe    &lt;tibble [50 × 17]&gt; &lt;htest&gt;     0.842
3 Africa    &lt;tibble [54 × 17]&gt; &lt;htest&gt;     0.761
4 America   &lt;tibble [36 × 17]&gt; &lt;htest&gt;     0.836
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;htest&gt;     0.996</code></pre>
</div>
</div>
<p><code>Cor_coef</code>の各列に格納された値が出力されました。以上の作業を一つのコードとしてまとめることも出来ます。また、相関係数の抽出の際に<code>map()</code>でなく、<code>map_dbl()</code>を使えば、numeric型ベクトルが返されるので<code>unnest()</code>も不要となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb136"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb136-1"><a href="#RN4Ecb136-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb136-2"><a href="#RN4Ecb136-2"></a>  <span class="fu">group_by</span>(Continent) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb136-3"><a href="#RN4Ecb136-3"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb136-4"><a href="#RN4Ecb136-4"></a>  <span class="fu">mutate</span>(<span class="at">Cor_test =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb136-5"><a href="#RN4Ecb136-5"></a>         <span class="at">Cor_coef =</span> <span class="fu">map_dbl</span>(Cor_test, <span class="st">"estimate"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
# Groups:   Continent [5]
  Continent data               Cor_test Cor_coef
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;      &lt;dbl&gt;
1 Asia      &lt;tibble [42 × 17]&gt; &lt;htest&gt;     0.834
2 Europe    &lt;tibble [50 × 17]&gt; &lt;htest&gt;     0.842
3 Africa    &lt;tibble [54 × 17]&gt; &lt;htest&gt;     0.761
4 America   &lt;tibble [36 × 17]&gt; &lt;htest&gt;     0.836
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;htest&gt;     0.996</code></pre>
</div>
</div>
<p>たった5行のコードで大陸ごとの相関分析が出来ました。これを<code>map_*()</code>を使わずに処理するなら以下のようなコードとなります<a href="#RN4Efn6" class="footnote-ref" id="RN4Efnref6" role="doc-noteref"><sup>6</sup></a>。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb138"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb138-1"><a href="#RN4Ecb138-1"></a>Cor_Test1 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, </span>
<span id="RN4Ecb138-2"><a href="#RN4Ecb138-2"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Asia"</span>))</span>
<span id="RN4Ecb138-3"><a href="#RN4Ecb138-3"></a>Cor_Test2 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, </span>
<span id="RN4Ecb138-4"><a href="#RN4Ecb138-4"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Europe"</span>))</span>
<span id="RN4Ecb138-5"><a href="#RN4Ecb138-5"></a>Cor_Test3 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, </span>
<span id="RN4Ecb138-6"><a href="#RN4Ecb138-6"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Africa"</span>))</span>
<span id="RN4Ecb138-7"><a href="#RN4Ecb138-7"></a>Cor_Test4 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, </span>
<span id="RN4Ecb138-8"><a href="#RN4Ecb138-8"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"America"</span>))</span>
<span id="RN4Ecb138-9"><a href="#RN4Ecb138-9"></a>Cor_Test5 <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(<span class="sc">~</span> Polity_Score <span class="sc">+</span> FH_Total, </span>
<span id="RN4Ecb138-10"><a href="#RN4Ecb138-10"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Oceania"</span>))</span>
<span id="RN4Ecb138-11"><a href="#RN4Ecb138-11"></a></span>
<span id="RN4Ecb138-12"><a href="#RN4Ecb138-12"></a>Cor_Result <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Asia"</span> <span class="ot">=</span> Cor_Test1<span class="sc">$</span>estimate, <span class="st">"Europe"</span> <span class="ot">=</span> Cor_Test2<span class="sc">$</span>estimate,</span>
<span id="RN4Ecb138-13"><a href="#RN4Ecb138-13"></a>                <span class="st">"Africa"</span> <span class="ot">=</span> Cor_Test3<span class="sc">$</span>estimate, <span class="st">"America"</span> <span class="ot">=</span> Cor_Test4<span class="sc">$</span>estimate,</span>
<span id="RN4Ecb138-14"><a href="#RN4Ecb138-14"></a>                <span class="st">"Oceania"</span> <span class="ot">=</span> Cor_Test5<span class="sc">$</span>estimate)</span>
<span id="RN4Ecb138-15"><a href="#RN4Ecb138-15"></a></span>
<span id="RN4Ecb138-16"><a href="#RN4Ecb138-16"></a><span class="fu">print</span>(Cor_Result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Asia.cor  Europe.cor  Africa.cor America.cor Oceania.cor 
  0.8338172   0.8419547   0.7612138   0.8356899   0.9960776 </code></pre>
</div>
</div>
<p>それでは応用例として回帰分析をしてみましょう。今回も<code>Nested_Data</code>を使用し、<code>PPP_per_capita</code>を応答変数に、<code>FH_Total</code>と<code>Population</code>を説明変数とした重回帰分析を行い、政治的自由度（<code>FH_Total</code>）の係数や標準誤差などを抽出してみましょう。まずは、ステップごとにコードを分けて説明し、最後には一つのコードとしてまとめたものをお見せします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb140"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb140-1"><a href="#RN4Ecb140-1"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb140-2"><a href="#RN4Ecb140-2"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">map</span>(data, </span>
<span id="RN4Ecb140-3"><a href="#RN4Ecb140-3"></a>                     <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb140-4"><a href="#RN4Ecb140-4"></a>                         <span class="at">data =</span> .x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
# Groups:   Continent [5]
  Continent data               Model 
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt;
1 Asia      &lt;tibble [42 × 17]&gt; &lt;lm&gt;  
2 Europe    &lt;tibble [50 × 17]&gt; &lt;lm&gt;  
3 Africa    &lt;tibble [54 × 17]&gt; &lt;lm&gt;  
4 America   &lt;tibble [36 × 17]&gt; &lt;lm&gt;  
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;lm&gt;  </code></pre>
</div>
</div>
<p><code>Model</code>列からから推定結果の要約を抽出するにはどうすれば良いでしょうか。1つ目の方法は<code>summary(lmオブジェクト名)$coefficients</code>で抽出する方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb142"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb142-1"><a href="#RN4Ecb142-1"></a>lm_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, <span class="at">data =</span> Country_df)</span>
<span id="RN4Ecb142-2"><a href="#RN4Ecb142-2"></a></span>
<span id="RN4Ecb142-3"><a href="#RN4Ecb142-3"></a><span class="fu">summary</span>(lm_fit1)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate   Std. Error    t value     Pr(&gt;|t|)
(Intercept)  1.929308e+03 3.229792e+03  0.5973473 5.510476e-01
FH_Total     3.256660e+02 4.871626e+01  6.6849553 2.979474e-10
Population  -2.217793e-06 9.193256e-06 -0.2412413 8.096505e-01</code></pre>
</div>
</div>
<p>もっと簡単な方法は{broom}の<code>tidy()</code>関数を使う方法です。<code>tidy()</code>関数は推定値に関する様々な情報をデータフレームとして返す便利な関数です。デフォルトだと95%信頼区間は出力されませんが、<code>conf.int = TRUE</code>を指定すると信頼区間も出力されます。<code>tidy()</code>関数を提供する{broom}パッケージは{tidyverse}の一部ですが、{tidyverse}読み込みの際に一緒に読み込まれるものではないため、予め{broom}パッケージを読み込んでおくか、<code><a href="https://generics.r-lib.org/reference/tidy.html">broom::tidy()</a></code>で使うことができます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb144"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb144-1"><a href="#RN4Ecb144-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(lm_fit1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  term             estimate     std.error statistic  p.value    conf.low conf.…¹
  &lt;chr&gt;               &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;
1 (Intercept) 1929.         3230.             0.597 5.51e- 1    -4.45e+3 8.30e+3
2 FH_Total     326.           48.7            6.68  2.98e-10     2.30e+2 4.22e+2
3 Population    -0.00000222    0.00000919    -0.241 8.10e- 1    -2.04e-5 1.59e-5
# … with abbreviated variable name ¹​conf.high</code></pre>
</div>
</div>
<p>それでは<code>Model</code>列にあるlmオブジェクトから推定値の情報を抽出し、<code>Model2</code>という列に格納してみましょう。今回はラムダ式を使う必要がありません。なぜなら、<code>tidy()</code>の第一引数がデータだからです（<code>?tidy.lm</code>参照）。他にも必要な引数（<code>conf.int = TRUE</code>など）があれば、<code>map()</code>の第3引数以降で指定します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb146"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb146-1"><a href="#RN4Ecb146-1"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb146-2"><a href="#RN4Ecb146-2"></a>  <span class="fu">mutate</span>(<span class="at">Model  =</span> <span class="fu">map</span>(data, </span>
<span id="RN4Ecb146-3"><a href="#RN4Ecb146-3"></a>                      <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb146-4"><a href="#RN4Ecb146-4"></a>                          <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb146-5"><a href="#RN4Ecb146-5"></a>         <span class="at">Model2 =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
# Groups:   Continent [5]
  Continent data               Model  Model2          
  &lt;chr&gt;     &lt;list&gt;             &lt;list&gt; &lt;list&gt;          
1 Asia      &lt;tibble [42 × 17]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt;
2 Europe    &lt;tibble [50 × 17]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt;
3 Africa    &lt;tibble [54 × 17]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt;
4 America   &lt;tibble [36 × 17]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt;
5 Oceania   &lt;tibble [4 × 17]&gt;  &lt;lm&gt;   &lt;tibble [3 × 7]&gt;</code></pre>
</div>
</div>
<p><code>Model2</code>列の各セルに7列のtibbleが格納されているようです。ここからは<code>data</code>と<code>Model</code>列は不要ですので<code>select()</code>関数を使って除去し、<code>Model2</code>の入れ子構造を解除してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb148"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb148-1"><a href="#RN4Ecb148-1"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb148-2"><a href="#RN4Ecb148-2"></a>  <span class="fu">mutate</span>(<span class="at">Model  =</span> <span class="fu">map</span>(data, </span>
<span id="RN4Ecb148-3"><a href="#RN4Ecb148-3"></a>                      <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb148-4"><a href="#RN4Ecb148-4"></a>                          <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb148-5"><a href="#RN4Ecb148-5"></a>         <span class="at">Model2 =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb148-6"><a href="#RN4Ecb148-6"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, Model)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb148-7"><a href="#RN4Ecb148-7"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 8
# Groups:   Continent [5]
   Continent term        estimate     std.error stati…¹ p.value conf.low conf.…²
   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;         &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 Asia      (Intercept)  2.13e+4  7376.          2.89  6.32e-3  6.39e+3 3.63e+4
 2 Asia      FH_Total     6.99e+1   156.          0.449 6.56e-1 -2.45e+2 3.85e+2
 3 Asia      Population  -1.26e-5     0.0000126  -1.00  3.23e-1 -3.81e-5 1.29e-5
 4 Europe    (Intercept) -1.40e+4  9407.         -1.48  1.45e-1 -3.29e+4 5.00e+3
 5 Europe    FH_Total     6.29e+2   108.          5.80  7.07e-7  4.10e+2 8.48e+2
 6 Europe    Population   1.17e-4     0.0000845   1.39  1.73e-1 -5.33e-5 2.88e-4
 7 Africa    (Intercept)  3.83e+3  1836.          2.09  4.20e-2  1.44e+2 7.52e+3
 8 Africa    FH_Total     5.11e+1    34.2         1.49  1.42e-1 -1.77e+1 1.20e+2
 9 Africa    Population  -1.43e-5     0.0000231  -0.619 5.39e-1 -6.07e-5 3.21e-5
10 America   (Intercept) -7.50e+3  5926.         -1.27  2.15e-1 -1.96e+4 4.57e+3
11 America   FH_Total     3.12e+2    77.3         4.03  3.20e-4  1.54e+2 4.69e+2
12 America   Population   9.13e-5     0.0000235   3.89  4.77e-4  4.35e-5 1.39e-4
13 Oceania   (Intercept) -5.10e+4 23351.         -2.18  2.73e-1 -3.48e+5 2.46e+5
14 Oceania   FH_Total     9.76e+2   326.          2.99  2.05e-1 -3.17e+3 5.12e+3
15 Oceania   Population   1.52e-4     0.000627    0.242 8.49e-1 -7.81e-3 8.12e-3
# … with abbreviated variable names ¹​statistic, ²​conf.high</code></pre>
</div>
</div>
<p>各大陸ごとの回帰分析の推定結果が一つのデータフレームとして展開されました。ここでは<code>FH_Total</code>の推定値のみがほしいので、<code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>関数を使用し、<code>term</code>の値が<code>"FH_Total"</code>の行のみを残します。また、<code>term</code>列も必要なくなるので除外しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb150"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb150-1"><a href="#RN4Ecb150-1"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb150-2"><a href="#RN4Ecb150-2"></a>  <span class="fu">mutate</span>(<span class="at">Model  =</span> <span class="fu">map</span>(data, </span>
<span id="RN4Ecb150-3"><a href="#RN4Ecb150-3"></a>                      <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb150-4"><a href="#RN4Ecb150-4"></a>                          <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb150-5"><a href="#RN4Ecb150-5"></a>         <span class="at">Model2 =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb150-6"><a href="#RN4Ecb150-6"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, Model)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb150-7"><a href="#RN4Ecb150-7"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Model2) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb150-8"><a href="#RN4Ecb150-8"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"FH_Total"</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb150-9"><a href="#RN4Ecb150-9"></a>  <span class="fu">select</span>(<span class="sc">-</span>term)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
# Groups:   Continent [5]
  Continent estimate std.error statistic     p.value conf.low conf.high
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 Asia          69.9     156.      0.449 0.656         -245.       385.
2 Europe       629.      108.      5.80  0.000000707    410.       848.
3 Africa        51.1      34.2     1.49  0.142          -17.7      120.
4 America      312.       77.3     4.03  0.000320       154.       469.
5 Oceania      976.      326.      2.99  0.205        -3166.      5117.</code></pre>
</div>
</div>
<p>これで終わりです。政治的自由度と所得水準の関係はアジアとアフリカでは連関の程度が小さく、統計的有意ではありません。オセアニアの場合、連関の程度は大きいと考えられますが、サンプルサイズが小さいため統計的有意な結果は得られませんでした。一方、ヨーロッパとアメリカでは連関の程度も大きく、統計的有意な連関が確認されました。</p>
<p>以上のコードをよりコンパクトにまとめると以下のようなコードとなります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb152"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb152-1"><a href="#RN4Ecb152-1"></a><span class="co"># {purrr}使用</span></span>
<span id="RN4Ecb152-2"><a href="#RN4Ecb152-2"></a>Nested_Data <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb152-3"><a href="#RN4Ecb152-3"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb152-4"><a href="#RN4Ecb152-4"></a>         <span class="at">Model =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb152-5"><a href="#RN4Ecb152-5"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Model) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb152-6"><a href="#RN4Ecb152-6"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"FH_Total"</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb152-7"><a href="#RN4Ecb152-7"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Data, term))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>{purrr}パッケージを使用しない例も紹介します。むろん、以下のコードは可能な限り面倒な書き方をしています。<code>for()</code>文や<code><a href="https://rdrr.io/r/base/split.html">split()</a></code>と<code>*apply()</code>関数を組み合わせると以下の例よりも簡潔なコードは作成できます。R上級者になるためには{tidyverse}的な書き方だけでなく、ネイティブRの書き方にも慣れる必要があります。ぜひ挑戦してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb153"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb153-1"><a href="#RN4Ecb153-1"></a><span class="co"># {purrr}を使用しない場合</span></span>
<span id="RN4Ecb153-2"><a href="#RN4Ecb153-2"></a><span class="co"># FH_Totalの係数と標準誤差のみを抽出する例</span></span>
<span id="RN4Ecb153-3"><a href="#RN4Ecb153-3"></a>lm_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb153-4"><a href="#RN4Ecb153-4"></a>              <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Asia"</span>))</span>
<span id="RN4Ecb153-5"><a href="#RN4Ecb153-5"></a>lm_fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb153-6"><a href="#RN4Ecb153-6"></a>              <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Europe"</span>))</span>
<span id="RN4Ecb153-7"><a href="#RN4Ecb153-7"></a>lm_fit3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb153-8"><a href="#RN4Ecb153-8"></a>              <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Africa"</span>))</span>
<span id="RN4Ecb153-9"><a href="#RN4Ecb153-9"></a>lm_fit4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb153-10"><a href="#RN4Ecb153-10"></a>              <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"America"</span>))</span>
<span id="RN4Ecb153-11"><a href="#RN4Ecb153-11"></a>lm_fit5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total <span class="sc">+</span> Population, </span>
<span id="RN4Ecb153-12"><a href="#RN4Ecb153-12"></a>              <span class="at">data =</span> <span class="fu">subset</span>(Country_df, Country_df<span class="sc">$</span>Continent <span class="sc">==</span> <span class="st">"Oceania"</span>))</span>
<span id="RN4Ecb153-13"><a href="#RN4Ecb153-13"></a></span>
<span id="RN4Ecb153-14"><a href="#RN4Ecb153-14"></a>lm_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Continent =</span> <span class="fu">c</span>(<span class="st">"Asia"</span>, <span class="st">"Europe"</span>, <span class="st">"Africa"</span>, <span class="st">"America"</span>, <span class="st">"Oceania"</span>),</span>
<span id="RN4Ecb153-15"><a href="#RN4Ecb153-15"></a>                    <span class="at">estimate  =</span> <span class="fu">c</span>(<span class="fu">summary</span>(lm_fit1)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>],</span>
<span id="RN4Ecb153-16"><a href="#RN4Ecb153-16"></a>                                  <span class="fu">summary</span>(lm_fit2)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>],</span>
<span id="RN4Ecb153-17"><a href="#RN4Ecb153-17"></a>                                  <span class="fu">summary</span>(lm_fit3)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>],</span>
<span id="RN4Ecb153-18"><a href="#RN4Ecb153-18"></a>                                  <span class="fu">summary</span>(lm_fit4)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>],</span>
<span id="RN4Ecb153-19"><a href="#RN4Ecb153-19"></a>                                  <span class="fu">summary</span>(lm_fit5)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>]),</span>
<span id="RN4Ecb153-20"><a href="#RN4Ecb153-20"></a>                    <span class="at">se        =</span> <span class="fu">c</span>(<span class="fu">summary</span>(lm_fit1)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="RN4Ecb153-21"><a href="#RN4Ecb153-21"></a>                                  <span class="fu">summary</span>(lm_fit2)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="RN4Ecb153-22"><a href="#RN4Ecb153-22"></a>                                  <span class="fu">summary</span>(lm_fit3)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="RN4Ecb153-23"><a href="#RN4Ecb153-23"></a>                                  <span class="fu">summary</span>(lm_fit4)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="RN4Ecb153-24"><a href="#RN4Ecb153-24"></a>                                  <span class="fu">summary</span>(lm_fit5)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="RN4Esec-iteration-range" class="level3" data-number="27.4.3"><h3 data-number="27.4.3" class="anchored" data-anchor-id="RN4Esec-iteration-range">
<span class="header-section-number">27.4.3</span> データの範囲を指定したモデル推定</h3>
<p>これまでの例は名目変数でグループ化を行いましたが、連続変数を使うことも可能です。たとえば、人口1千万未満の国、1千万以上5千万未満、5千万以上1億未満、1億以上でサンプルを分割することです。まず、<code>Country_df</code>から<code>PPP_per_capita</code>、<code>FH_Total</code>、<code>Population</code>列のみを抽出し、<code>Country_df2</code>に格納します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb154"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb154-1"><a href="#RN4Ecb154-1"></a>Country_df2 <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb154-2"><a href="#RN4Ecb154-2"></a>  <span class="fu">select</span>(PPP_per_capita, FH_Total, Population)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>続いて、<code>case_when()</code>関数を使用し、<code>Population</code>の値を基準にケースがどの範囲内に属するかを表す変数<code>Group</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb155"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb155-1"><a href="#RN4Ecb155-1"></a>Country_df2 <span class="ot">&lt;-</span> Country_df2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb155-2"><a href="#RN4Ecb155-2"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="fu">case_when</span>(Population <span class="sc">&lt;</span>  <span class="dv">10000000</span>  <span class="sc">~</span> <span class="st">"1千万未満"</span>,</span>
<span id="RN4Ecb155-3"><a href="#RN4Ecb155-3"></a>                           Population <span class="sc">&lt;</span>  <span class="dv">50000000</span>  <span class="sc">~</span> <span class="st">"1千万以上5千万未満"</span>,</span>
<span id="RN4Ecb155-4"><a href="#RN4Ecb155-4"></a>                           Population <span class="sc">&lt;</span>  <span class="dv">100000000</span> <span class="sc">~</span> <span class="st">"5千万以上1億未満"</span>,</span>
<span id="RN4Ecb155-5"><a href="#RN4Ecb155-5"></a>                           Population <span class="sc">&gt;=</span> <span class="dv">100000000</span> <span class="sc">~</span> <span class="st">"1億以上"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>中身を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb156"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb156-1"><a href="#RN4Ecb156-1"></a>Country_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 186 × 4
   PPP_per_capita FH_Total Population Group             
            &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;             
 1          2125.       27   38928346 1千万以上5千万未満
 2         13781.       67    2877797 1千万未満         
 3         11324.       34   43851044 1千万以上5千万未満
 4            NA        94      77265 1千万未満         
 5          6649.       32   32866272 1千万以上5千万未満
 6         21267.       85      97929 1千万未満         
 7         22938.       85   45195774 1千万以上5千万未満
 8         12974.       53    2963243 1千万未満         
 9         50001.       97   25499884 1千万以上5千万未満
10         55824.       93    9006398 1千万未満         
# … with 176 more rows</code></pre>
</div>
</div>
<p>あとはこれまでの例と同じ手順となります。まず、データを<code>Group</code>変数でグループ化し、入れ子構造に変換します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb158"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb158-1"><a href="#RN4Ecb158-1"></a>Country_df2 <span class="ot">&lt;-</span> Country_df2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb158-2"><a href="#RN4Ecb158-2"></a>  <span class="fu">group_by</span>(Group) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb158-3"><a href="#RN4Ecb158-3"></a>  <span class="fu">nest</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>変換後のデータを確認してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb159"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb159-1"><a href="#RN4Ecb159-1"></a>Country_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
# Groups:   Group [4]
  Group              data             
  &lt;chr&gt;              &lt;list&gt;           
1 1千万以上5千万未満 &lt;tibble [61 × 3]&gt;
2 1千万未満          &lt;tibble [96 × 3]&gt;
3 1億以上            &lt;tibble [14 × 3]&gt;
4 5千万以上1億未満   &lt;tibble [15 × 3]&gt;</code></pre>
</div>
</div>
<p>続いて、<code>data</code>列をデータとし、<code>map()</code>関数でモデルの推定をしてみましょう。目的変数は所得水準、説明変数は政治的自由度とします。推定後、{broom}の<code>tidy()</code>変数で推定値の情報のみを抽出し、入れ子構造を解除します。最後に<code>term</code>がFH_Totalの行のみを残します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb161"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb161-1"><a href="#RN4Ecb161-1"></a>Country_df2 <span class="ot">&lt;-</span> Country_df2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb161-2"><a href="#RN4Ecb161-2"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total, <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb161-3"><a href="#RN4Ecb161-3"></a>         <span class="at">Est   =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb161-4"><a href="#RN4Ecb161-4"></a>  <span class="fu">unnest</span>(Est) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb161-5"><a href="#RN4Ecb161-5"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"FH_Total"</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb161-6"><a href="#RN4Ecb161-6"></a>  <span class="fu">select</span>(<span class="sc">!</span>term)</span>
<span id="RN4Ecb161-7"><a href="#RN4Ecb161-7"></a></span>
<span id="RN4Ecb161-8"><a href="#RN4Ecb161-8"></a>Country_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
# Groups:   Group [4]
  Group           data     Model estim…¹ std.e…² stati…³ p.value conf.…⁴ conf.…⁵
  &lt;chr&gt;           &lt;list&gt;   &lt;lis&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 1千万以上5千万… &lt;tibble&gt; &lt;lm&gt;     366.    59.6    6.14 9.07e-8   246.     485.
2 1千万未満       &lt;tibble&gt; &lt;lm&gt;     246.    83.0    2.96 3.94e-3    80.8    411.
3 1億以上         &lt;tibble&gt; &lt;lm&gt;     325.   158.     2.06 6.23e-2   -19.5    669.
4 5千万以上1億未… &lt;tibble&gt; &lt;lm&gt;     487.   101.     4.80 3.46e-4   268.     706.
# … with abbreviated variable names ¹​estimate, ²​std.error, ³​statistic,
#   ⁴​conf.low, ⁵​conf.high</code></pre>
</div>
</div>
<p>せっかくなので推定結果を可視化してみましょう。横軸は人口規模（<code>Group</code>）とし、縦軸は推定値とします。係数の点推定値と95%信頼区間を同時に出力するために、<code>geom_pointrange()</code>幾何オブジェクトを使用します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb163"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb163-1"><a href="#RN4Ecb163-1"></a>Country_df2 <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb163-2"><a href="#RN4Ecb163-2"></a>  <span class="fu">mutate</span>(</span>
<span id="RN4Ecb163-3"><a href="#RN4Ecb163-3"></a>    <span class="co"># 横軸の表示順番を指定するために、Group変数をfactor化する</span></span>
<span id="RN4Ecb163-4"><a href="#RN4Ecb163-4"></a>    <span class="at">Group =</span> <span class="fu">factor</span>(Group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1千万未満"</span>, <span class="st">"1千万以上5千万未満"</span>,</span>
<span id="RN4Ecb163-5"><a href="#RN4Ecb163-5"></a>                                     <span class="st">"5千万以上1億未満"</span>, <span class="st">"1億以上"</span>)),</span>
<span id="RN4Ecb163-6"><a href="#RN4Ecb163-6"></a>    <span class="co"># 統計的有意か否かを表すSig変数の作成</span></span>
<span id="RN4Ecb163-7"><a href="#RN4Ecb163-7"></a>    <span class="at">Sig   =</span> <span class="fu">if_else</span>(conf.low <span class="sc">*</span> conf.high <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"統計的有意"</span>, <span class="st">"統計的非有意"</span>)</span>
<span id="RN4Ecb163-8"><a href="#RN4Ecb163-8"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb163-9"><a href="#RN4Ecb163-9"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="RN4Ecb163-10"><a href="#RN4Ecb163-10"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="RN4Ecb163-11"><a href="#RN4Ecb163-11"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Group, <span class="at">y =</span> estimate, </span>
<span id="RN4Ecb163-12"><a href="#RN4Ecb163-12"></a>                      <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">color =</span> Sig), </span>
<span id="RN4Ecb163-13"><a href="#RN4Ecb163-13"></a>                  <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="RN4Ecb163-14"><a href="#RN4Ecb163-14"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"人口"</span>, <span class="at">y =</span> <span class="st">"政治的自由度が所得に与える影響"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="RN4Ecb163-15"><a href="#RN4Ecb163-15"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"統計的有意"</span> <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="RN4Ecb163-16"><a href="#RN4Ecb163-16"></a>                                <span class="st">"統計的非有意"</span> <span class="ot">=</span> <span class="st">"gray70"</span>)) <span class="sc">+</span></span>
<span id="RN4Ecb163-17"><a href="#RN4Ecb163-17"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size   =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="RN4Ecb163-18"><a href="#RN4Ecb163-18"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="RN4Efig-iteration1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="iteration_files/figure-html/fig-iteration1-1.png" class="img-fluid figure-img" width="2100"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.3: 政治的自由度が所得に与える影響 (人口規模別)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>政治的自由度が高くなるほど所得水準も高くなる傾向が確認されますが、人口が1億人以上の国においてはそのような傾向が見られないことが分かります。</p>
<p>上記の例は、ある行は一つのグループに属するケースです。しかし、ある行が複数のグループに属するケースもあるでしょう。たとえば、ある変数の値が一定値以上である行のみでグループ化する場合です。<code>FH_Score</code>が一定値以上のSub-sampleに対して回帰分析を行う場合、<code>FH_Score</code>が最大値（100）である国はすべてのSub-sampleに属することになります。この場合は<code>group_by()</code>でグループ化することが難しいかも知れません。しかし、{dplyr}の<code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>を使えば簡単に処理することができます。</p>
<p>ここでは人口を説明変数に、所得水準を応答変数とした単回帰分析を行います。データは政治的自由度が一定値以上の国家のみに限定します。<code>FH_Score</code>が0以上の国（すべてのケース）、10以上の国、20以上の国、…などにサンプルを分割してみましょう。まずは<code>FH_Score</code>の最小値のみを格納した<code>Rnage_df</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb164"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb164-1"><a href="#RN4Ecb164-1"></a>Range_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Min_FH =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="at">by =</span> <span class="dv">10</span>))</span>
<span id="RN4Ecb164-2"><a href="#RN4Ecb164-2"></a></span>
<span id="RN4Ecb164-3"><a href="#RN4Ecb164-3"></a>Range_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 1
  Min_FH
   &lt;dbl&gt;
1      0
2     10
3     20
4     30
5     40
6     50
7     60
8     70
9     80</code></pre>
</div>
</div>
<p>9行1列のtibbleが出来ました。続いて、<code>Subset</code>という列を生成し、ここにデータを入れてみましょう。ある変数の値を基準にサンプルを絞るには{dplyr}の<code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>関数を使用します。たとえば、<code>Counter_df</code>の<code>FH_Total</code>が50以上のケースに絞るには<code>filter(Country_df, FH_Total &gt;= 50)</code>となります。パイプ演算子を使った場合は<code>Country_df %&gt;% filter(FH_Total &gt;= 50)</code>になりますが、ラムダ式とパイプ演算子の相性はあまり良くありませんので、ここではパイプ演算子なしとします。重要なのは<code>Min_FH</code>の値をデータとした<code>map()</code>関数を実行し、実行内容を「<code>Country_df</code>から<code>FH_Total</code>が<code>Min_FH</code>以上のケースのみを抽出せよ」にすることです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb166"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb166-1"><a href="#RN4Ecb166-1"></a>Range_df <span class="ot">&lt;-</span> Range_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb166-2"><a href="#RN4Ecb166-2"></a>  <span class="fu">mutate</span>(<span class="at">Subset =</span> <span class="fu">map</span>(Min_FH, <span class="sc">~</span><span class="fu">filter</span>(Country_df, FH_Total <span class="sc">&gt;=</span> .x)))</span>
<span id="RN4Ecb166-3"><a href="#RN4Ecb166-3"></a></span>
<span id="RN4Ecb166-4"><a href="#RN4Ecb166-4"></a>Range_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Min_FH Subset               
   &lt;dbl&gt; &lt;list&gt;               
1      0 &lt;spc_tbl_ [185 × 18]&gt;
2     10 &lt;spc_tbl_ [176 × 18]&gt;
3     20 &lt;spc_tbl_ [158 × 18]&gt;
4     30 &lt;spc_tbl_ [142 × 18]&gt;
5     40 &lt;spc_tbl_ [126 × 18]&gt;
6     50 &lt;spc_tbl_ [112 × 18]&gt;
7     60 &lt;spc_tbl_ [99 × 18]&gt; 
8     70 &lt;spc_tbl_ [76 × 18]&gt; 
9     80 &lt;spc_tbl_ [61 × 18]&gt; </code></pre>
</div>
</div>
<p>入れ子構造になっているのは確認できましたが、ちゃんとフィルタリングされているかどうかも確認してみましょう。たとえば、<code>Range_df$Subset[[9]]</code>だと<code>FH_Total</code>が80以上の国に絞られていると考えられます。18列の表ですから<code>Country</code>と<code>FH_Total</code>列のみを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb168"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb168-1"><a href="#RN4Ecb168-1"></a>Range_df<span class="sc">$</span>Subset[[<span class="dv">9</span>]] <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb168-2"><a href="#RN4Ecb168-2"></a>  <span class="fu">select</span>(Country, FH_Total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 61 × 2
   Country             FH_Total
   &lt;chr&gt;                  &lt;dbl&gt;
 1 Andorra                   94
 2 Antigua and Barbuda       85
 3 Argentina                 85
 4 Australia                 97
 5 Austria                   93
 6 Bahamas                   91
 7 Barbados                  95
 8 Belgium                   96
 9 Belize                    86
10 Bulgaria                  80
# … with 51 more rows</code></pre>
</div>
</div>
<p>問題なくフィルタリングされているようですね。ここまで出来ればあとはこれまでの内容の復習でしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb170"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb170-1"><a href="#RN4Ecb170-1"></a>Range_df <span class="ot">&lt;-</span> Range_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb170-2"><a href="#RN4Ecb170-2"></a>  <span class="fu">mutate</span>(<span class="at">Model  =</span> <span class="fu">map</span>(Subset, <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> Population, <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb170-3"><a href="#RN4Ecb170-3"></a>         <span class="at">Model  =</span> <span class="fu">map</span>(Model,  broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb170-4"><a href="#RN4Ecb170-4"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> Model) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb170-5"><a href="#RN4Ecb170-5"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"Population"</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb170-6"><a href="#RN4Ecb170-6"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Subset, term))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>今回も可視化してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb171"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb171-1"><a href="#RN4Ecb171-1"></a>Range_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb171-2"><a href="#RN4Ecb171-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="RN4Ecb171-3"><a href="#RN4Ecb171-3"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="RN4Ecb171-4"><a href="#RN4Ecb171-4"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Min_FH, <span class="at">y =</span> estimate, </span>
<span id="RN4Ecb171-5"><a href="#RN4Ecb171-5"></a>                      <span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high)) <span class="sc">+</span></span>
<span id="RN4Ecb171-6"><a href="#RN4Ecb171-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"データ内FH_Scoreの最小値"</span>, <span class="at">y =</span> <span class="st">"Populationの係数"</span>) <span class="sc">+</span></span>
<span id="RN4Ecb171-7"><a href="#RN4Ecb171-7"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="at">by =</span> <span class="dv">10</span>),</span>
<span id="RN4Ecb171-8"><a href="#RN4Ecb171-8"></a>                     <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="at">by =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="RN4Ecb171-9"><a href="#RN4Ecb171-9"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="RN4Efig-iteration2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="iteration_files/figure-html/fig-iteration2-1.png" class="img-fluid figure-img" width="2100"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.4: Populationの係数の推定値</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>以上の例は実際の分析では多く使われる方法ではないかも知れません。しかし、ノンパラメトリック回帰不連続デザイン（Regression Discontinuity Design; RDD）の場合、感度分析を行う際、バンド幅を色々と調整しながら局所処置効果を推定します。RDDの詳細については<a href="https://yukiyanai.github.io/econometrics2/regression-discontinuity.html" target="_blank" rel="external">矢内の授業資料</a>、および<a href="https://www.jaysong.net/post/kobe2020-qpm1/" target="_blank" rel="external">SONGの授業資料</a>などに譲りますが、ハンド幅の調整はデータの範囲を少しずつ拡張（縮小）させながら同じ分析を繰り返すことです。以下ではアメリカ上院選挙のデータを例に、方法を紹介します。</p>
<p>使用するデータは{rdrobust}パッケージが提供する<code>rdrobust_RDsenate</code>というデータセットです。{pacman}パッケージの<code>p_load()</code>関数を使ってパッケージのインストールと読み込みを行い、<code><a href="https://rdrr.io/r/utils/data.html">data()</a></code>関数を使って、データを読み込みます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb172"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb172-1"><a href="#RN4Ecb172-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(rdrobust)  <span class="co"># {rdrobust}のインストール &amp; 読み込み</span></span>
<span id="RN4Ecb172-2"><a href="#RN4Ecb172-2"></a><span class="fu">data</span>(<span class="st">"rdrobust_RDsenate"</span>) <span class="co"># rdrobust_RDsenateデータの読み込み</span></span>
<span id="RN4Ecb172-3"><a href="#RN4Ecb172-3"></a></span>
<span id="RN4Ecb172-4"><a href="#RN4Ecb172-4"></a><span class="co"># データをSenate_dfという名で格納</span></span>
<span id="RN4Ecb172-5"><a href="#RN4Ecb172-5"></a>Senate_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(rdrobust_RDsenate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Senate_df</code>の中身を確認してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb173"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb173-1"><a href="#RN4Ecb173-1"></a>Senate_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,390 × 2
    margin  vote
     &lt;dbl&gt; &lt;dbl&gt;
 1  -7.69   36.1
 2  -3.92   45.5
 3  -6.87   45.6
 4 -27.7    48.5
 5  -8.26   51.7
 6   0.732  39.8
 7   3.49   53.2
 8  -3.09   52.0
 9   4.70   51.7
10  -8.12   57.5
# … with 1,380 more rows</code></pre>
</div>
</div>
<p>本データの詳細は <span class="citation" data-cites="Cattaneo_Frandsen_Titiunik:2015">Cattaneo, Frandsen, and Titiunik (<a href="references.html#RN4Eref-Cattaneo_Frandsen_Titiunik:2015" role="doc-biblioref">2015</a>)</span> に譲りますが、ここでは簡単に説明します。<code>margin</code>はある選挙区の民主党候補者の得票率から共和党候補者の投票率を引いたものです。100なら民主党候補者の圧勝、-100なら共和党候補者の圧勝です。これが0に近いと辛勝または惜敗となり、この辺の民主党候補者と共和党候補者は候補者としての資質や資源が近いと考えられます。<code>vote</code>は次回の選挙における民主党候補者の得票率です。ある候補者が現職であることによるアドバンテージを調べる際、「民主党が勝った選挙区における次回選挙での民主党候補者の得票率」から「民主党が負けた選挙区における次回選挙での民主党候補者の得票率」を引くだけでは不十分でしょう。圧勝できた選挙区は次回でも得票率が高いと考えられますが、これは現職というポジションによるアドバンテージ以外にも、候補者がもともと備えている高い能力・資源にも起因するからです。だから辛勝・惜敗の選挙区のみに限定することで、現職と新人の能力・資源などを出来る限り均質にし、「現職」というポジションだけが異なる状況を見つけることになります。</p>
<p>問題は辛勝と惜敗の基準をどう決めるかですが、広く使われている方法としては <span class="citation" data-cites="Imbens_Kalyanaraman:2012">Imbens and Kalyanaraman (<a href="references.html#RN4Eref-Imbens_Kalyanaraman:2012" role="doc-biblioref">2012</a>)</span> の最適バンド幅（optimal bandwidth）が広く使われます。しかし、最適バンド幅を使うとしても感度分析（sensitivity analysis）を行うケースも多く、この場合、バンド幅を少しずつ変えながら現職の効果を推定することになります。推定式は以下のようになります。<span class="math inline">\(I(\text{margin} &gt; 0)\)</span>は<code>margin</code>が0より大きい場合、1となる指示関数（indicator function）であす。</p>
<p><span class="math display">\[
\hat{\text{vote}} = \beta_0 + \beta_1 \cdot \text{margin} + \tau \cdot I(\text{margin} &gt; 0) \quad \text{where} \quad -h \leq \text{margin} \leq -h
\]</span></p>
<p>それではまずは<span class="math inline">\(h\)</span>が100、つまり全データを使った分析を試しにやってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb175"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb175-1"><a href="#RN4Ecb175-1"></a>RDD_Fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(vote <span class="sc">~</span> margin <span class="sc">+</span> <span class="fu">I</span>(margin <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="at">data =</span> Senate_df)</span>
<span id="RN4Ecb175-2"><a href="#RN4Ecb175-2"></a></span>
<span id="RN4Ecb175-3"><a href="#RN4Ecb175-3"></a><span class="fu">summary</span>(RDD_Fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = vote ~ margin + I(margin &gt; 0), data = Senate_df)

Residuals:
    Min      1Q  Median      3Q     Max 
-46.930  -6.402   0.132   7.191  46.443 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       47.33084    0.54192  87.340  &lt; 2e-16 ***
margin             0.34806    0.01335  26.078  &lt; 2e-16 ***
I(margin &gt; 0)TRUE  4.78461    0.92290   5.184 2.51e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 11.78 on 1294 degrees of freedom
  (93 observations deleted due to missingness)
Multiple R-squared:  0.5781,    Adjusted R-squared:  0.5774 
F-statistic: 886.4 on 2 and 1294 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><code>I(margin &gt; 0)TRUE</code>の係数4.785が現職効果です。この作業を<span class="math inline">\(h = 100\)</span>から<span class="math inline">\(h = 10\)</span>まで、5ずつ変えながら分析を繰り返してみます。まずは、<code>RDD_df</code>というtibbleを作成し、<code>BW</code>列には<code>c(100, 95, 90, ... 10)</code>を入れます。続いて、<code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>関数を利用して<code>Senate_df</code>から<code>margin</code>が<code>-BW</code>以上、<code>BW</code>以下のデータを抽出し、<code>Subset</code>という名の列として格納します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb177"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb177-1"><a href="#RN4Ecb177-1"></a>RDD_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">BW =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">5</span>))</span>
<span id="RN4Ecb177-2"><a href="#RN4Ecb177-2"></a></span>
<span id="RN4Ecb177-3"><a href="#RN4Ecb177-3"></a>RDD_df <span class="ot">&lt;-</span> RDD_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb177-4"><a href="#RN4Ecb177-4"></a>  <span class="fu">mutate</span>(<span class="at">Subset =</span> <span class="fu">map</span>(BW, <span class="sc">~</span><span class="fu">filter</span>(Senate_df, </span>
<span id="RN4Ecb177-5"><a href="#RN4Ecb177-5"></a>                                  margin <span class="sc">&gt;=</span> <span class="sc">-</span>.x <span class="sc">&amp;</span> margin <span class="sc">&lt;=</span> .x)))</span>
<span id="RN4Ecb177-6"><a href="#RN4Ecb177-6"></a></span>
<span id="RN4Ecb177-7"><a href="#RN4Ecb177-7"></a>RDD_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 2
      BW Subset              
   &lt;dbl&gt; &lt;list&gt;              
 1   100 &lt;tibble [1,390 × 2]&gt;
 2    95 &lt;tibble [1,327 × 2]&gt;
 3    90 &lt;tibble [1,319 × 2]&gt;
 4    85 &lt;tibble [1,308 × 2]&gt;
 5    80 &lt;tibble [1,303 × 2]&gt;
 6    75 &lt;tibble [1,294 × 2]&gt;
 7    70 &lt;tibble [1,287 × 2]&gt;
 8    65 &lt;tibble [1,270 × 2]&gt;
 9    60 &lt;tibble [1,256 × 2]&gt;
10    55 &lt;tibble [1,237 × 2]&gt;
11    50 &lt;tibble [1,211 × 2]&gt;
12    45 &lt;tibble [1,178 × 2]&gt;
13    40 &lt;tibble [1,128 × 2]&gt;
14    35 &lt;tibble [1,077 × 2]&gt;
15    30 &lt;tibble [995 × 2]&gt;  
16    25 &lt;tibble [901 × 2]&gt;  
17    20 &lt;tibble [778 × 2]&gt;  
18    15 &lt;tibble [639 × 2]&gt;  
19    10 &lt;tibble [471 × 2]&gt;  </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb179"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb179-1"><a href="#RN4Ecb179-1"></a>RDD_df <span class="ot">&lt;-</span> RDD_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb179-2"><a href="#RN4Ecb179-2"></a>  <span class="fu">mutate</span>(</span>
<span id="RN4Ecb179-3"><a href="#RN4Ecb179-3"></a>    <span class="co"># 各Subsetに対し、回帰分析を実施し、Model列に格納</span></span>
<span id="RN4Ecb179-4"><a href="#RN4Ecb179-4"></a>    <span class="at">Model  =</span> <span class="fu">map</span>(Subset, <span class="sc">~</span><span class="fu">lm</span>(vote <span class="sc">~</span> margin <span class="sc">*</span> <span class="fu">I</span>(margin <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="at">data =</span> .x)),</span>
<span id="RN4Ecb179-5"><a href="#RN4Ecb179-5"></a>    <span class="co"># Model列の各セルから{broom}のtidy()で推定値のみ抽出</span></span>
<span id="RN4Ecb179-6"><a href="#RN4Ecb179-6"></a>    <span class="at">Est    =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="RN4Ecb179-7"><a href="#RN4Ecb179-7"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb179-8"><a href="#RN4Ecb179-8"></a>  <span class="co"># Est列の入れ子構造を解除</span></span>
<span id="RN4Ecb179-9"><a href="#RN4Ecb179-9"></a>  <span class="fu">unnest</span>(Est) <span class="sc">%&gt;%</span> </span>
<span id="RN4Ecb179-10"><a href="#RN4Ecb179-10"></a>  <span class="co"># 現職効果に該当する行のみを抽出</span></span>
<span id="RN4Ecb179-11"><a href="#RN4Ecb179-11"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"I(margin &gt; 0)TRUE"</span>) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb179-12"><a href="#RN4Ecb179-12"></a>  <span class="co"># 不要な列を削除</span></span>
<span id="RN4Ecb179-13"><a href="#RN4Ecb179-13"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">c</span>(Subset, Model, term, statistic, p.value))</span>
<span id="RN4Ecb179-14"><a href="#RN4Ecb179-14"></a></span>
<span id="RN4Ecb179-15"><a href="#RN4Ecb179-15"></a>RDD_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 5
      BW estimate std.error conf.low conf.high
   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1   100     6.04     0.942     4.20      7.89
 2    95     5.76     0.975     3.85      7.67
 3    90     5.90     0.981     3.98      7.83
 4    85     5.80     0.993     3.85      7.75
 5    80     5.10     0.999     3.14      7.06
 6    75     5.18     1.01      3.21      7.15
 7    70     5.57     1.01      3.58      7.55
 8    65     5.21     1.03      3.20      7.23
 9    60     4.89     1.04      2.86      6.93
10    55     5.23     1.05      3.17      7.29
11    50     5.73     1.07      3.64      7.82
12    45     5.94     1.09      3.80      8.09
13    40     6.12     1.12      3.92      8.33
14    35     6.34     1.15      4.09      8.59
15    30     7.18     1.18      4.86      9.50
16    25     7.38     1.21      5.00      9.76
17    20     7.03     1.32      4.43      9.62
18    15     6.96     1.50      4.01      9.92
19    10     6.90     1.75      3.46     10.3 </code></pre>
</div>
</div>
<p>19回の回帰分析が数行のコードで簡単に実施でき、必要な情報も素早く抽出することができました。</p>
<p>以上の例は、交互作用なしの線形回帰分析による局所処置効果の推定例です。しかし、ノンパラメトリックRDDでは、割当変数（running variable）処置変数の交差項や割当変数の二乗項を入れる場合が多いです。今回の割当変数は<code>margin</code>です。また、閾値（cutpoint）に近いケースには高い重みを付けることが一般的な作法であり、多く使われるのが三角（triangular）カーネルです。上記の例はすべてのケースに同じ重みを付ける矩形（rectagular）カーネルを使った例です。</p>
<p>以上の理由により、やはりRDDは専用のパッケージを使った方が良いかも知れません。既に読み込んである{rdrobust}も推定可能ですが、ここでは{rdd}パッケージを使ってみましょう。{rdd}パッケージによるRDDは<code>RDestimate()</code>関数を使います。実際の例を確認してみましょう。<code>map()</code>を使う前に、オブジェクトの構造を把握しておくことは重要です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb181"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb181-1"><a href="#RN4Ecb181-1"></a><span class="co"># cutpoint引数の既定値は0であるため、今回の例では省略可能</span></span>
<span id="RN4Ecb181-2"><a href="#RN4Ecb181-2"></a><span class="fu">RDestimate</span>(応答変数 <span class="sc">~</span> 割当変数, <span class="at">data =</span> データオブジェクト, <span class="at">cutpoint =</span> 閾値, <span class="at">bw =</span> バンド幅)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb182"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb182-1"><a href="#RN4Ecb182-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(rdd) <span class="co"># パッケージの読み込み</span></span>
<span id="RN4Ecb182-2"><a href="#RN4Ecb182-2"></a></span>
<span id="RN4Ecb182-3"><a href="#RN4Ecb182-3"></a><span class="co"># バンド幅を指定したRDD推定</span></span>
<span id="RN4Ecb182-4"><a href="#RN4Ecb182-4"></a>RDD_Fit <span class="ot">&lt;-</span> <span class="fu">RDestimate</span>(vote <span class="sc">~</span> margin, <span class="at">data =</span> Senate_df, <span class="at">bw =</span> <span class="dv">100</span>)</span>
<span id="RN4Ecb182-5"><a href="#RN4Ecb182-5"></a></span>
<span id="RN4Ecb182-6"><a href="#RN4Ecb182-6"></a><span class="co"># RDDの推定結果を見る</span></span>
<span id="RN4Ecb182-7"><a href="#RN4Ecb182-7"></a><span class="fu">summary</span>(RDD_Fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
RDestimate(formula = vote ~ margin, data = Senate_df, bw = 100)

Type:
sharp 

Estimates:
           Bandwidth  Observations  Estimate  Std. Error  z value  Pr(&gt;|z|) 
LATE       100        1258          5.637     0.8845      6.374    1.842e-10
Half-BW     50        1127          6.480     1.0040      6.455    1.084e-10
Double-BW  200        1297          5.842     0.8568      6.818    9.210e-12
              
LATE       ***
Half-BW    ***
Double-BW  ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

F-statistics:
           F      Num. DoF  Denom. DoF  p
LATE       316.0  3         1254        0
Half-BW    179.7  3         1123        0
Double-BW  506.0  3         1293        0</code></pre>
</div>
</div>
<p>現職効果は5.637、その標準誤差は0.884です。これらの情報はどこから抽出できるか確認してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb184"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb184-1"><a href="#RN4Ecb184-1"></a><span class="co"># 推定値の情報がどこに格納されているかを確認</span></span>
<span id="RN4Ecb184-2"><a href="#RN4Ecb184-2"></a><span class="fu">str</span>(RDD_Fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 12
 $ type     : chr "sharp"
 $ call     : language RDestimate(formula = vote ~ margin, data = Senate_df, bw = 100)
 $ est      : Named num [1:3] 5.64 6.48 5.84
  ..- attr(*, "names")= chr [1:3] "LATE" "Half-BW" "Double-BW"
 $ bw       : num [1:3] 100 50 200
 $ se       : num [1:3] 0.884 1.004 0.857
 $ z        : num [1:3] 6.37 6.45 6.82
 $ p        : num [1:3] 1.84e-10 1.08e-10 9.21e-12
 $ obs      : num [1:3] 1258 1127 1297
 $ ci       : num [1:3, 1:2] 3.9 4.51 4.16 7.37 8.45 ...
 $ model    : list()
 $ frame    : list()
 $ na.action: int [1:93] 28 29 57 58 86 113 114 142 143 168 ...
 - attr(*, "class")= chr "RD"</code></pre>
</div>
</div>
<p><code>$est</code>と<code>$se</code>に私たちが探している数値が入っていますね。それぞれ抽出してみると長さ3のnumericベクトルが出力され、その中で1番目の要素がLATEということが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb186"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb186-1"><a href="#RN4Ecb186-1"></a><span class="co"># est要素の1番目の要素がLATE</span></span>
<span id="RN4Ecb186-2"><a href="#RN4Ecb186-2"></a>RDD_Fit<span class="sc">$</span>est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     LATE   Half-BW Double-BW 
 5.637474  6.480344  5.842049 </code></pre>
</div>
<div class="sourceCode cell-code" id="RN4Ecb188"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb188-1"><a href="#RN4Ecb188-1"></a><span class="co"># se要素の1番目の要素がLATEの標準誤差</span></span>
<span id="RN4Ecb188-2"><a href="#RN4Ecb188-2"></a>RDD_Fit<span class="sc">$</span>se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8844541 1.0039734 0.8568150</code></pre>
</div>
</div>
<p>それでは分析に入ります。今回も<span class="math inline">\(h\)</span>を予め<code>BW</code>という名の列で格納した<code>RDD_df</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb190"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb190-1"><a href="#RN4Ecb190-1"></a>RDD_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">BW =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="sc">-</span><span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>今回はラムダ式を使わず、事前に関数を定義しておきましょう。関数の自作については第<a href="#RN4Esec-functions"><span>11</span></a>章を参照してください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb191"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb191-1"><a href="#RN4Ecb191-1"></a><span class="co"># 引数をxとするRDD_Func()の定義</span></span>
<span id="RN4Ecb191-2"><a href="#RN4Ecb191-2"></a>RDD_Func <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="RN4Ecb191-3"><a href="#RN4Ecb191-3"></a>  <span class="co"># バンド幅をxにしたRDD推定</span></span>
<span id="RN4Ecb191-4"><a href="#RN4Ecb191-4"></a>  Temp_Est <span class="ot">&lt;-</span> <span class="fu">RDestimate</span>(vote <span class="sc">~</span> margin, <span class="at">data =</span> Senate_df, <span class="at">bw =</span> x)</span>
<span id="RN4Ecb191-5"><a href="#RN4Ecb191-5"></a>  <span class="co"># LATEとその標準誤差をtibbleとして返す</span></span>
<span id="RN4Ecb191-6"><a href="#RN4Ecb191-6"></a>  <span class="fu">tibble</span>(<span class="at">LATE =</span> Temp_Est<span class="sc">$</span>est[<span class="dv">1</span>],</span>
<span id="RN4Ecb191-7"><a href="#RN4Ecb191-7"></a>         <span class="at">SE   =</span> Temp_Est<span class="sc">$</span>se[<span class="dv">1</span>])</span>
<span id="RN4Ecb191-8"><a href="#RN4Ecb191-8"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>問題なく動くかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb192"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb192-1"><a href="#RN4Ecb192-1"></a><span class="fu">RDD_Func</span>(<span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   LATE    SE
  &lt;dbl&gt; &lt;dbl&gt;
1  5.64 0.884</code></pre>
</div>
</div>
<p>それでは分析をやってみましょう。今回の場合、<code>map()</code>の第二引数はラムダ式ではないため<code>~</code>で始める必要ありません。関数名だけで十分です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb194"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb194-1"><a href="#RN4Ecb194-1"></a>RDD_df <span class="ot">&lt;-</span> RDD_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb194-2"><a href="#RN4Ecb194-2"></a>  <span class="fu">mutate</span>(<span class="at">RDD  =</span> <span class="fu">map</span>(BW, RDD_Func)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb194-3"><a href="#RN4Ecb194-3"></a>  <span class="fu">unnest</span>(RDD)</span>
<span id="RN4Ecb194-4"><a href="#RN4Ecb194-4"></a></span>
<span id="RN4Ecb194-5"><a href="#RN4Ecb194-5"></a>RDD_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 3
      BW  LATE    SE
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1   100  5.64 0.884
 2    95  5.64 0.890
 3    90  5.63 0.897
 4    85  5.61 0.905
 5    80  5.65 0.913
 6    75  5.75 0.922
 7    70  5.81 0.934
 8    65  5.91 0.949
 9    60  6.07 0.963
10    55  6.29 0.982
11    50  6.48 1.00 
12    45  6.67 1.03 
13    40  6.91 1.07 
14    35  7.19 1.11 
15    30  7.28 1.17 
16    25  7.10 1.26 
17    20  7.27 1.38 
18    15  7.49 1.57 
19    10  7.98 1.84 </code></pre>
</div>
</div>
<p>せっかくなので可視化してみましょう。今回は<code>geom_pointrange()</code>を使わず、<code>geom_line()</code>と<code>geom_ribbon()</code>を組み合わせます。<code>geom_line()</code>はLATEを、<code>geom_ribbion()</code>は95%信頼区間を表します。作図の前に95%信頼区間を計算しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb196"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb196-1"><a href="#RN4Ecb196-1"></a>RDD_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb196-2"><a href="#RN4Ecb196-2"></a>  <span class="fu">mutate</span>(<span class="at">CI_lwr =</span> LATE <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> SE,</span>
<span id="RN4Ecb196-3"><a href="#RN4Ecb196-3"></a>         <span class="at">CI_upr =</span> LATE <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> SE) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb196-4"><a href="#RN4Ecb196-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="RN4Ecb196-5"><a href="#RN4Ecb196-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="RN4Ecb196-6"><a href="#RN4Ecb196-6"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x =</span> BW, <span class="at">ymin =</span> CI_lwr, <span class="at">ymax =</span> CI_upr), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="RN4Ecb196-7"><a href="#RN4Ecb196-7"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> BW, <span class="at">y =</span> LATE), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="RN4Ecb196-8"><a href="#RN4Ecb196-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Bandwidth"</span>, <span class="at">y =</span> <span class="st">"Local Average Treatment Effect (%p)"</span>) <span class="sc">+</span></span>
<span id="RN4Ecb196-9"><a href="#RN4Ecb196-9"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div id="RN4Efig-iteration3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="iteration_files/figure-html/fig-iteration3-1.png" class="img-fluid figure-img" width="2100"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.5: LATEの推定値 (バンド幅別)</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="RN4Esec-iteration-variables" class="level3" data-number="27.4.4"><h3 data-number="27.4.4" class="anchored" data-anchor-id="RN4Esec-iteration-variables">
<span class="header-section-number">27.4.4</span> 説明・応答変数を指定したモデル推定</h3>
<p>続いて、同じデータに対して推定式のみを変えた反復推定をやってみましょう。たとえば、応答変数は固定し、グループ変数のみを変えながらt検定を繰り返すケースを考えてみましょう。たとえば、OECDに加盟しているかどうか（<code>OECD</code>）で購買力平価GDP（<code>PPP</code>）の差があるかを検定してみましょう。使用する関数は<code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>です。第一引数には<code>応答変数 ~ 説明変数</code>とし、<code>data</code>引数にはデータフレームやtibbleオブジェクトを指定します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb198"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb198-1"><a href="#RN4Ecb198-1"></a>Diff_test <span class="ot">&lt;-</span> <span class="fu">t.test</span>(PPP <span class="sc">~</span> G20, <span class="at">data =</span> Country_df)</span>
<span id="RN4Ecb198-2"><a href="#RN4Ecb198-2"></a></span>
<span id="RN4Ecb198-3"><a href="#RN4Ecb198-3"></a>Diff_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  PPP by G20
t = -3.4137, df = 18.012, p-value = 0.003094
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -7667830 -1825482
sample estimates:
mean in group 0 mean in group 1 
         211287         4957943 </code></pre>
</div>
</div>
<p>ここからいくつかの情報が読み取れます。まず、OECD加盟国のPPPは4957943、非加盟国は211287です。その差分は-4746656です。また、t値は-3.4136、p値は0.003です。これらの情報を効率よく抽出するには<code><a href="https://generics.r-lib.org/reference/tidy.html">broom::tidy()</a></code>が便利です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb200"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb200-1"><a href="#RN4Ecb200-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(Diff_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  estim…¹ estim…² estim…³ stati…⁴ p.value param…⁵ conf.…⁶ conf.…⁷ method alter…⁸
    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  
1 -4.75e6 211287.  4.96e6   -3.41 0.00309    18.0 -7.67e6 -1.83e6 Welch… two.si…
# … with abbreviated variable names ¹​estimate, ²​estimate1, ³​estimate2,
#   ⁴​statistic, ⁵​parameter, ⁶​conf.low, ⁷​conf.high, ⁸​alternative</code></pre>
</div>
</div>
<p>差分、t値、p値、95%信頼区間などが抽出できます。これをOECDだけでなく、G7やG20に対しても同じ検定を繰り返してみましょう。</p>
<p><code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>の第一引数だけを変えながら推定をすれば良いでしょう。この第一引数、たとえば<code>PPP ~ G20</code>の方はformula型と呼ばれるRにおけるデータ型の一つです。これはcharacter型でないことに注意してください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb202"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb202-1"><a href="#RN4Ecb202-1"></a>Formula1 <span class="ot">&lt;-</span> <span class="st">"PPP ~ G20"</span></span>
<span id="RN4Ecb202-2"><a href="#RN4Ecb202-2"></a><span class="fu">t.test</span>(Formula1, <span class="at">data =</span> Country_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in mean.default(x): argument is not numeric or logical: returning NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in var(x): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>Error in t.test.default(Formula1, data = Country_df): not enough 'x' observations</code></pre>
</div>
</div>
<p>このようにエラーが出ます。この<code>Formula</code>を<code><a href="https://rdrr.io/r/stats/formula.html">as.formula()</a></code>関数を使ってformula型に変換し、推定をやってみると問題なく推定できることが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb206"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb206-1"><a href="#RN4Ecb206-1"></a>Formula2 <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(Formula1)</span>
<span id="RN4Ecb206-2"><a href="#RN4Ecb206-2"></a><span class="fu">t.test</span>(Formula2, <span class="at">data =</span> Country_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  PPP by G20
t = -3.4137, df = 18.012, p-value = 0.003094
alternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0
95 percent confidence interval:
 -7667830 -1825482
sample estimates:
mean in group 0 mean in group 1 
         211287         4957943 </code></pre>
</div>
</div>
<p>これから私たちがやるのは<code>"PPP ~ "</code>の次に<code>"G7"</code>、<code>"G20"</code>、<code>"OECD"</code>を<code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code>や<code><a href="https://rdrr.io/r/base/paste.html">paste0()</a></code>関数を結合し、formula型に変換することです。formula型の列さえ生成できれば、あとは<code>map()</code>関数にformulaを渡し、データは<code>Country_df</code>に固定するだけです。</p>
<p>まずはどの変数を説明変数にするかを<code>Group</code>列として格納した<code>Diff_df</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb208"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb208-1"><a href="#RN4Ecb208-1"></a>Diff_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Group =</span> <span class="fu">c</span>(<span class="st">"G7"</span>, <span class="st">"G20"</span>, <span class="st">"OECD"</span>))</span>
<span id="RN4Ecb208-2"><a href="#RN4Ecb208-2"></a></span>
<span id="RN4Ecb208-3"><a href="#RN4Ecb208-3"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 1
  Group
  &lt;chr&gt;
1 G7   
2 G20  
3 OECD </code></pre>
</div>
</div>
<p>続いて、<code>Formula</code>列を作成し、<code>"PPP ~ "</code>の次に<code>Group</code>列の文字列を結合します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb210"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb210-1"><a href="#RN4Ecb210-1"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb210-2"><a href="#RN4Ecb210-2"></a>  <span class="fu">mutate</span>(<span class="at">Formula =</span> <span class="fu">paste0</span>(<span class="st">"PPP ~ "</span>, Group))</span>
<span id="RN4Ecb210-3"><a href="#RN4Ecb210-3"></a></span>
<span id="RN4Ecb210-4"><a href="#RN4Ecb210-4"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  Group Formula   
  &lt;chr&gt; &lt;chr&gt;     
1 G7    PPP ~ G7  
2 G20   PPP ~ G20 
3 OECD  PPP ~ OECD</code></pre>
</div>
</div>
<p>今の<code>Formula</code>列のデータ型を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb212"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb212-1"><a href="#RN4Ecb212-1"></a><span class="fu">class</span>(Diff_df<span class="sc">$</span>Formula[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>character型ですね。続いて、<code>map()</code>関数を使用してFormula列をformula型に変換します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb214"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb214-1"><a href="#RN4Ecb214-1"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb214-2"><a href="#RN4Ecb214-2"></a>  <span class="fu">mutate</span>(<span class="at">Formula =</span> <span class="fu">map</span>(Formula, as.formula))</span>
<span id="RN4Ecb214-3"><a href="#RN4Ecb214-3"></a></span>
<span id="RN4Ecb214-4"><a href="#RN4Ecb214-4"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  Group Formula  
  &lt;chr&gt; &lt;list&gt;   
1 G7    &lt;formula&gt;
2 G20   &lt;formula&gt;
3 OECD  &lt;formula&gt;</code></pre>
</div>
</div>
<p>データ型も確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb216"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb216-1"><a href="#RN4Ecb216-1"></a><span class="fu">class</span>(Diff_df<span class="sc">$</span>Formula[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "formula"</code></pre>
</div>
</div>
<p>formula型になっていることが分かります。それではt検定を行います。ここでもラムダ式を使います。式が入る場所には<code>.x</code>を指定し、データは<code>Country_df</code>に固定します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb218"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb218-1"><a href="#RN4Ecb218-1"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb218-2"><a href="#RN4Ecb218-2"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">map</span>(Formula, <span class="sc">~</span><span class="fu">t.test</span>(.x, <span class="at">data =</span> Country_df)))</span>
<span id="RN4Ecb218-3"><a href="#RN4Ecb218-3"></a></span>
<span id="RN4Ecb218-4"><a href="#RN4Ecb218-4"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Group Formula   Model  
  &lt;chr&gt; &lt;list&gt;    &lt;list&gt; 
1 G7    &lt;formula&gt; &lt;htest&gt;
2 G20   &lt;formula&gt; &lt;htest&gt;
3 OECD  &lt;formula&gt; &lt;htest&gt;</code></pre>
</div>
</div>
<p><code><a href="https://generics.r-lib.org/reference/tidy.html">broom::tidy()</a></code>で推定値の要約を抽出し、入れ子構造を解除します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb220"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb220-1"><a href="#RN4Ecb220-1"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb220-2"><a href="#RN4Ecb220-2"></a>  <span class="fu">mutate</span>(<span class="at">Tidy =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb220-3"><a href="#RN4Ecb220-3"></a>  <span class="fu">unnest</span>(Tidy)</span>
<span id="RN4Ecb220-4"><a href="#RN4Ecb220-4"></a></span>
<span id="RN4Ecb220-5"><a href="#RN4Ecb220-5"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 13
  Group Formula   Model    estimate estimate1 estimate2 statis…¹ p.value param…²
  &lt;chr&gt; &lt;list&gt;    &lt;list&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 G7    &lt;formula&gt; &lt;htest&gt; -5363390.   507033.  5870423.    -2.14 0.0759     6.04
2 G20   &lt;formula&gt; &lt;htest&gt; -4746656.   211287.  4957943.    -3.41 0.00309   18.0 
3 OECD  &lt;formula&gt; &lt;htest&gt; -1166591.   475459.  1642050.    -1.96 0.0564    42.8 
# … with 4 more variables: conf.low &lt;dbl&gt;, conf.high &lt;dbl&gt;, method &lt;chr&gt;,
#   alternative &lt;chr&gt;, and abbreviated variable names ¹​statistic, ²​parameter</code></pre>
</div>
</div>
<p>いくつか使用しない情報もあるので、適宜列を削除します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb222"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb222-1"><a href="#RN4Ecb222-1"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb222-2"><a href="#RN4Ecb222-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Formula, Model, estimate1, estimate2, </span>
<span id="RN4Ecb222-3"><a href="#RN4Ecb222-3"></a>            p.value, method, alternative))</span>
<span id="RN4Ecb222-4"><a href="#RN4Ecb222-4"></a></span>
<span id="RN4Ecb222-5"><a href="#RN4Ecb222-5"></a>Diff_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  Group  estimate statistic parameter   conf.low conf.high
  &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
1 G7    -5363390.     -2.14      6.04 -11486296.   759515.
2 G20   -4746656.     -3.41     18.0   -7667830. -1825482.
3 OECD  -1166591.     -1.96     42.8   -2366187.    33005.</code></pre>
</div>
</div>
<p>以上のコードをパイプ演算子を使用し、簡潔にまとめると以下のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb224"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb224-1"><a href="#RN4Ecb224-1"></a>Diff_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Group =</span> <span class="fu">c</span>(<span class="st">"G7"</span>, <span class="st">"G20"</span>, <span class="st">"OECD"</span>))</span>
<span id="RN4Ecb224-2"><a href="#RN4Ecb224-2"></a></span>
<span id="RN4Ecb224-3"><a href="#RN4Ecb224-3"></a>Diff_df <span class="ot">&lt;-</span> Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb224-4"><a href="#RN4Ecb224-4"></a>  <span class="fu">mutate</span>(<span class="at">Formula =</span> <span class="fu">paste0</span>(<span class="st">"PPP ~ "</span>, Group),</span>
<span id="RN4Ecb224-5"><a href="#RN4Ecb224-5"></a>         <span class="at">Formula =</span> <span class="fu">map</span>(Formula, as.formula),</span>
<span id="RN4Ecb224-6"><a href="#RN4Ecb224-6"></a>         <span class="at">Model   =</span> <span class="fu">map</span>(Formula, <span class="sc">~</span><span class="fu">t.test</span>(.x, <span class="at">data =</span> Country_df)),</span>
<span id="RN4Ecb224-7"><a href="#RN4Ecb224-7"></a>         <span class="at">Tidy    =</span> <span class="fu">map</span>(Model, broom<span class="sc">::</span>tidy)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb224-8"><a href="#RN4Ecb224-8"></a>  <span class="fu">unnest</span>(Tidy) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb224-9"><a href="#RN4Ecb224-9"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Formula, Model, estimate1, estimate2, </span>
<span id="RN4Ecb224-10"><a href="#RN4Ecb224-10"></a>            p.value, method, alternative))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>推定結果を可視化してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="RN4Ecb225"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="RN4Ecb225-1"><a href="#RN4Ecb225-1"></a>Diff_df <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb225-2"><a href="#RN4Ecb225-2"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="fu">fct_inorder</span>(Group),</span>
<span id="RN4Ecb225-3"><a href="#RN4Ecb225-3"></a>         <span class="at">Sig   =</span> <span class="fu">if_else</span>(conf.low <span class="sc">*</span> conf.high <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"統計的有意"</span>,</span>
<span id="RN4Ecb225-4"><a href="#RN4Ecb225-4"></a>                         <span class="st">"統計的非有意"</span>)) <span class="sc">%&gt;%</span></span>
<span id="RN4Ecb225-5"><a href="#RN4Ecb225-5"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="RN4Ecb225-6"><a href="#RN4Ecb225-6"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="RN4Ecb225-7"><a href="#RN4Ecb225-7"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high,</span>
<span id="RN4Ecb225-8"><a href="#RN4Ecb225-8"></a>                      <span class="at">y =</span> Group, <span class="at">color =</span> Sig), <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="RN4Ecb225-9"><a href="#RN4Ecb225-9"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"統計的有意"</span>   <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="RN4Ecb225-10"><a href="#RN4Ecb225-10"></a>                                <span class="st">"統計的非有意"</span> <span class="ot">=</span> <span class="st">"gray70"</span>)) <span class="sc">+</span></span>
<span id="RN4Ecb225-11"><a href="#RN4Ecb225-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"非加盟国のPPP - 加盟国のPPP"</span>, <span class="at">y =</span> <span class="st">"グループ"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="RN4Ecb225-12"><a href="#RN4Ecb225-12"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size   =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="RN4Ecb225-13"><a href="#RN4Ecb225-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="RN4Efig-iteration4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="iteration_files/figure-html/fig-iteration4-1.png" class="img-fluid figure-img" width="2100"></p>
<p></p><figcaption class="figure-caption">図&nbsp;27.6: 非加盟国と加盟国の一人当たりPPP-GDPの差分 (OECD/G20/G7)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>以上の方法を応用すると応答変数を変えながら分析を繰り返すこともできます。他にも説明変数が2つ以上のケースにも応用可能です。</p>
<div id="RN4Equarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">私たちのR</span> <span class="hidden" data-render-id="quarto-int-navbar-title">私たちのR</span> <span class="hidden" data-render-id="quarto-int-next"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></span> <span class="hidden" data-render-id="quarto-int-prev"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">分析環境の管理</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/index.html">紹介</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-1">Rの導入</span> <span class="hidden" data-render-id="quarto-int-sidebar:/aboutr.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R?</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/installation.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Rのインストール</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/ide.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">IDEの導入</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/r_customize.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">分析環境のカスタマイズ</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/packages.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Rパッケージ</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-2">Rの基礎</span> <span class="hidden" data-render-id="quarto-int-sidebar:/r_basic.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">基本的な操作</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/io.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">データの入出力</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/datatype.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データ型</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/datastructure.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">データ構造</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/programming.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Rプログラミングの基礎</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/functions.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">関数の自作</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-3">データハンドリング</span> <span class="hidden" data-render-id="quarto-int-sidebar:/datahandling1.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/datahandling2.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/factor.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [factor型]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/tidydata.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">整然データ構造</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/string.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">文字列の処理</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-4">可視化</span> <span class="hidden" data-render-id="quarto-int-sidebar:/visualization1.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">可視化 [理論]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/visualization2.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">可視化 [基礎]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/visualization3.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">可視化 [応用]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/visualization4.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">可視化 [発展]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/visualization5.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">モデルの可視化</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-5">再現可能な研究</span> <span class="hidden" data-render-id="quarto-int-sidebar:/rmarkdown.html"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">R Markdown [基礎]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/rmarkdown2.html"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">R Markdown [応用]</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/quarto.html"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Quarto入門</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/table.html"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">表の作成</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/renv.html"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">分析環境の管理</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-6">中級者向け</span> <span class="hidden" data-render-id="quarto-int-sidebar:/iteration.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/oop.html"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/monte.html"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">モンテカルロ・シミュレーション</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/scraping.html"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">スクレイピング</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/api.html"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">API</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-7">付録</span> <span class="hidden" data-render-id="quarto-int-sidebar:/tips.html">R Tips</span> <span class="hidden" data-render-id="quarto-int-sidebar:/session.html">本書の執筆環境</span> <span class="hidden" data-render-id="quarto-int-sidebar:/references.html">参考文献</span> <span class="hidden" data-render-id="footer-center">Copyright 2022, Jaehyun Song and Yuki Yanai</span></p>
</div>
<div id="RN4Equarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">私たちのR - <span id="RN4Esec-iteration" class="quarto-section-identifier"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></span></span> <span class="hidden" data-render-id="quarto-twittercardtitle">私たちのR: ベストプラクティスの探求</span> <span class="hidden" data-render-id="quarto-ogcardtitle">私たちのR: ベストプラクティスの探求</span> <span class="hidden" data-render-id="quarto-metasitename">私たちのR</span></p>
</div>
<div id="RN4Erefs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="RN4Eref-Cattaneo_Frandsen_Titiunik:2015" class="csl-entry" role="doc-biblioentry">
Cattaneo, Matias D., Brigham R. Frandsen, and Rocío Titiunik. 2015. <span>“Randomization Inference in the Regression Discontinuity Design: An Application to the Study of Party Advantages in the u.s. Senate.”</span> <em>Journal of Causal Inference</em> 3: 1–24.
</div>
<div id="RN4Eref-Imbens_Kalyanaraman:2012" class="csl-entry" role="doc-biblioentry">
Imbens, Guido, and Karthik Kalyanaraman. 2012. <span>“Optimal Bandwidth Choice for the Regression Discontinuity Estimator.”</span> <em>The Review of Economic Studies</em> 79: 933–59.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="RN4Efn1"><p>引数が2つなら<code>.x</code>と<code>.y</code>を使用します。もし3つ以上なら<code>..1</code>、<code>..2</code>、<code>..3</code>、…と表記します。<a href="#RN4Efnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="RN4Efn2"><p>実は今回の例のように要素を抽出する場合、<code>`[`</code>すら要りません。<code>map_dbl(num_list, 3)</code>だけで十分です。<a href="#RN4Efnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="RN4Efn3"><p><code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code>関数は<code>sep =</code>以外はすべて結合の対象となります。引数が4つ以上になることもあります。たとえば、<code>paste("We", "love", "cats!", sep = " ")</code>です。<a href="#RN4Efnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="RN4Efn4"><p>ただしtibbleは<code>tibble名[3, 2:4] &lt;- c("A", "B", "C")</code>のような、列をまたがった値の代入は出来ません。これによってtibbleに対応しない関数もまだあります。この場合、<code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code>を使って一旦データフレームに変換する必要があります。<a href="#RN4Efnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="RN4Efn5"><p>{tidyverse}のコア・パッケージであるため、別途読み込む必要はございません。<a href="#RN4Efnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="RN4Efn6"><p><code>cor.test()$estimate</code>で直接相関係数を抽出することも可能ですが、コードの可読性が著しく低下します。またオブジェクトの再利用（例えば、「今度は<em>p</em>値を抽出しよう！」）が出来なくなります。<a href="#RN4Efnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/www\.jaysong\.net\/RBook\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./renv.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">分析環境の管理</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./oop.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
      <div class="nav-footer-center">
        <div class="footer-contents">Copyright 2022, Jaehyun Song and Yuki Yanai</div>  
      </div>
  </div>
</footer>


</body></html>