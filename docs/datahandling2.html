<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>私たちのR - 14&nbsp; データハンドリング [要約]</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./datahandling3.html" rel="next">
<link href="./datahandling1.html" rel="prev">
<link href="./Figs/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "サーチ"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CEHS4C056W"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CEHS4C056W', { 'anonymize_ip': false});
</script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&amp;display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono&amp;display=swap" rel="stylesheet"> 


<meta property="og:title" content="私たちのR: ベストプラクティスの探求">
<meta property="og:description" content="R Not for Everyone: An Esoteric Guide">
<meta property="og:image" content="https://www.jaysong.net/RBook/Figs/favicon.png">
<meta property="og:site_name" content="私たちのR">
<meta property="og:image:height" content="260">
<meta property="og:image:width" content="260">
<meta name="twitter:title" content="私たちのR: ベストプラクティスの探求">
<meta name="twitter:description" content="R Not for Everyone: An Esoteric Guide">
<meta name="twitter:image" content="https://www.jaysong.net/RBook/Figs/favicon.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="260">
<meta name="twitter:image-width" content="260">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./datahandling1.html">データハンドリング</a></li><li class="breadcrumb-item"><a href="./datahandling2.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [要約]</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">私たちのR</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/JaehyunSong/RBook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="サーチ"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">紹介</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Rの導入</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aboutr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Rのインストール</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">IDEの導入</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_customize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">分析環境のカスタマイズ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Rパッケージ</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Rの基礎</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">プロジェクト管理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基本的な操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./io.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データの入出力</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datatype.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">データ型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datastructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">データ構造</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Rプログラミングの基礎</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">関数の自作</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">データハンドリング</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [要約]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">データハンドリング [factor型]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidydata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">整然データ構造</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./string.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">文字列の処理</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">可視化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">可視化 [理論]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">可視化 [基礎]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">可視化 [応用]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">可視化 [発展]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">表の作成</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">再現可能な研究</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">R Markdown [基礎]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">R Markdown [応用]</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Quarto入門</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./renv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">分析環境の管理</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">中級者向け</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">反復処理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./oop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./monte.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">モンテカルロ・シミュレーション</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">スクレイピング</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">付録</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dataset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">データセット</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./filesystem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">ファイルシステム</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tips.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">R Tips</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">本書の執筆環境</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">参考文献</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#sec-handling2-summarise" id="toc-sec-handling2-summarise" class="nav-link active" data-scroll-target="#sec-handling2-summarise"><span class="header-section-number">14.1</span> 記述統計量の計算</a>
  <ul class="collapse">
  <li><a href="#summariseによる記述統計量の計算" id="toc-summariseによる記述統計量の計算" class="nav-link" data-scroll-target="#summariseによる記述統計量の計算"><span class="header-section-number">14.1.1</span> <code>summarise()</code>による記述統計量の計算</a></li>
  <li><a href="#summariseに使える便利な関数" id="toc-summariseに使える便利な関数" class="nav-link" data-scroll-target="#summariseに使える便利な関数"><span class="header-section-number">14.1.2</span> <code>summarise()</code>に使える便利な関数</a></li>
  </ul></li>
  <li><a href="#sec-handling2-group" id="toc-sec-handling2-group" class="nav-link" data-scroll-target="#sec-handling2-group"><span class="header-section-number">14.2</span> グルーピング</a>
  <ul class="collapse">
  <li><a href="#group_byによるグループ化" id="toc-group_byによるグループ化" class="nav-link" data-scroll-target="#group_byによるグループ化"><span class="header-section-number">14.2.1</span> <code>group_by()</code>によるグループ化</a></li>
  <li><a href="#複数の変数を用いたグループ化" id="toc-複数の変数を用いたグループ化" class="nav-link" data-scroll-target="#複数の変数を用いたグループ化"><span class="header-section-number">14.2.2</span> 複数の変数を用いたグループ化</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./datahandling1.html">データハンドリング</a></li><li class="breadcrumb-item"><a href="./datahandling2.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [要約]</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-datahandling2" class="quarto-section-identifier"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [要約]</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>前章ではデータの一部（subset）を抽出する方法について説明しましたが、本章はデータを拡張する、あるいは全く別のデータが得られるような処理について解説します。後者は主に元のデータを要約し（記述統計量）、その結果を出力する方法で、前者はデータ内の変数に基づき、指定された計算を行った結果を新しい列として追加する方法です。今回も<a href="Data/Ramen.csv">前章と同じデータ</a>を使用します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># データのパスは適宜修正すること</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># 文字化けが生じる場合、以下のコードに書き換える。</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># df &lt;- read_csv("Data/Ramen.csv", locale = locale(encoding = "utf8"))</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データの詳細については第<a href="datahandling1.html#sec-handling1-select" class="quarto-xref"><span>13.3</span></a>章を参照してください。</p>
<section id="sec-handling2-summarise" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="sec-handling2-summarise"><span class="header-section-number">14.1</span> 記述統計量の計算</h2>
<section id="summariseによる記述統計量の計算" class="level3" data-number="14.1.1">
<h3 data-number="14.1.1" class="anchored" data-anchor-id="summariseによる記述統計量の計算"><span class="header-section-number">14.1.1</span> <code>summarise()</code>による記述統計量の計算</h3>
<p>ある変数の平均値や標準偏差、最小値、最大値などの記述統計量（要約統計量）を計算することも可能です。これは<code>summarize()</code>または<code>summarise()</code>関数を使いますが、この関数は後で紹介する<code>group_by()</code>関数と組み合わせることで力を発揮します。ここではグルーピングを考えずに、全データの記述統計量を計算する方法を紹介します。</p>
<p><code>summarise()</code>関数の使い方は以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># summarise()関数の使い方</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>データフレーム名 <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">summarise</span>(新しい変数名 <span class="ot">=</span> 関数名(計算の対象となる変数名))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>もし、<code>Score</code>変数の平均値を計算し、その結果を<code>Mean</code>という列にしたい場合は以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1    NA</code></pre>
</div>
</div>
<p>ただし、<code>mean()</code>関数は欠損値が含まれるベクトルの場合、<code>NA</code>を返します。この場合方法は2つ考えられます。</p>
<ol type="1">
<li><code>filter()</code>関数を使って<code>Score</code>が欠損しているケースを予め除去する。</li>
<li><code>na.rm</code>引数を指定し、欠損値を除去した平均値を求める。</li>
</ol>
<p>ここでは2番目の方法を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
</div>
<p><code>df</code>の<code>Score</code>変数の平均値はNAであることが分かります。また、<code>summarise()</code>関数は複数の記述統計量を同時に計算することも可能です。以下は<code>Score</code>変数の平均値、中央値、標準偏差、最小値、最大値、第一四分位点、第三四分位点を計算し、<code>Score.Desc</code>という名のデータフレームに格納するコードです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>Score.Desc <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">summarize</span>(<span class="at">Mean   =</span>     <span class="fu">mean</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 平均値</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>            <span class="at">Median =</span>   <span class="fu">median</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 中央値</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>            <span class="at">SD     =</span>       <span class="fu">sd</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 標準偏差</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>            <span class="at">Min    =</span>      <span class="fu">min</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最小値</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>            <span class="at">Max    =</span>      <span class="fu">max</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最大値</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>            <span class="at">Q1     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 第一四分位点</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>            <span class="at">Q3     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))  <span class="co"># 第三四分位点</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>Score.Desc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
   Mean Median    SD   Min   Max    Q1    Q3
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  3.66   3.58 0.719     1     5     3     4</code></pre>
</div>
</div>
<p>むろん、複数の変数に対して記述統計量を計算することも可能です。たとえば、平均予算 (<code>Budget</code>)、口コミ数 (<code>ScoreN</code>)、口コミ評価 (<code>Score</code>)の平均値を求めるとしたら、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 平均予算の平均値</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>            <span class="at">SocreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 口コミ数の平均値</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="co"># 評価の平均値</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget_Mean SocreN_Mean Score_Mean
        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
1       1232.       0.537       3.66</code></pre>
</div>
</div>
<p>のように書きます。実は<code>summarise()</code>はこれくらいで十分便利です。ただし、以上の操作はもっと簡単なコードに置換できます。ただし、ラムダ関数など、やや高度な内容になるため、以下の内容は飛ばして、次の節 (グルーピング)を読んでいただいても構いません。</p>
<p>まずは、複数の変数に対して同じ記述統計量を求める例を考えてみましょう。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に対して平均値を求める例です。これは<code>across()</code>関数を使うとよりコードが短くなります。まずは<code>across()</code>関数の書き方から見ましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># across()の使い方</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>データフレーム名 <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, ラムダ関数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>変数名のベクトル</strong>は長さ1以上のベクトルです。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の場合<code>c(Budget, ScoreN, Score)</code>になります。これは<code>df</code>内で隣接する変数ですから<code>Budget:Score</code>の書き方も使えます。また、<code>where()</code>や<code>any_of()</code>、<code>starts_with()</code>のような関数を使って変数を指定することも可能です。<strong>ラムダ関数</strong>（lambda function; ラムダ式）は<code>~</code>で始まる関数であり、無名関数とも呼ばれます。たとえば、平均値を計算するラムダ関数は<code>~mean()</code>であり、第一引数は<code>.x</code>となります。この<code>.x</code>に<code>across()</code>の第一引数（変数たち）が入ります。また、<code>()</code>内には更に引数を指定することもでき、たとえば欠損値を除外して計算する<code>na.rm = TRUE</code>などが追加できます。ラムダ関数の詳細は後でもう一度解説するとし、とりあえず<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の平均値を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget ScoreN Score
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1  1232.  0.537  3.66</code></pre>
</div>
</div>
<p><code>across()</code>使わない場合、4行必要だったコードが2行になりました。変数が少ない場合は<code>across()</code>を使わない方が、可読性が高くなる場合もあります。しかし、変数が多くなる場合、可読性がやや落ちても<code>across()</code>を使った方が効率的でしょう。</p>
<p>次は、ある変数に対して複数の記述統計量を計算したい場合について考えます。<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>変数の第一四分位点と第三四分位点を<code>across()</code>を使わずに計算すると家のような7行のコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Q1 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-3"><a href="#cb15-3"></a>            <span class="at">Budget_Q3 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-4"><a href="#cb15-4"></a>            <span class="at">ScoreN_Q1 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-5"><a href="#cb15-5"></a>            <span class="at">ScoreN_Q3 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-6"><a href="#cb15-6"></a>            <span class="at">Score_Q1  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-7"><a href="#cb15-7"></a>            <span class="at">Score_Q3  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>この作業も<code>across()</code>を使ってより短縮することができます。ここではラムダ関数の知識が必要になります。ラムダ関数とは関数名を持たない<a href="https://ja.wikipedia.org/wiki/無名関数">無名関数 (anonymous functions)</a>を意味しますが、詳細は割愛します。興味のある読者は<a href="https://ja.wikipedia.org/wiki/無名関数">Wikipedia</a>などを参照してください。簡単にいうとその場で即席に関数を作成し、計算が終わったら破棄する関数です。ラムダ関数の書き方にはバリエーションがありますが、ここでは{purrr}パッケージのラムダ関数スタイルを使用します<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。まずは、書き方から確認します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># ラムダ関数を用いたacross()の使い方</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>データフレーム名 <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, <span class="at">.fns =</span> <span class="fu">list</span>(結果の変数名 <span class="ot">=</span> ラムダ関数)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ラムダ関数の3つの書き方
</div>
</div>
<div class="callout-body-container callout-body">
<p>　ここでは<code>~mean(.x, na.rm = TRUE)</code>と書いたが、他の書き方もある。昔からのやり方では<code>function(x) mean(x, na.rm = TRUE)</code>のような書き方がある。関数内の内容が複数行に渡る場合は<code>function(x) { mean(x, na.rm = TRUE) }</code>と表記する。そしてR 4.1から追加された<code>\(x) mean(x, na.rm = TRUE)</code>のような書き方もある。以下のコードはすべて同じ結果を返す。Rネイティブの書き方の場合、引数は<code>.x</code>でなく、<code>x</code>であることに注意しよう（<code>\(y)</code>なら<code>y</code>が引数となる）。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># purrrスタイル</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co"># R nativeスタイル</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>df <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co"># R nativeスタイル</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>df <span class="sc">|&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="cf">function</span>(x) { <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) }))</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co"># R nativeスタイル（R 4.1以降）</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="co"># function を \ に省略したもの</span></span>
<span id="cb18-15"><a href="#cb18-15"></a>df <span class="sc">|&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, \(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>先ほどの書き方と似ていますが、関数を複数書く必要があるため、今回は関数名をlist型にまとめ、<code>.fns</code>引数に指定します。そして、<em>結果の変数名</em>は結果として出力されるデータフレームの列名を指定する引数です。たとえば、<code>Mean</code>にすると結果は<code>元の変数名1_Mean</code>、<code>元の変数名2_Mean</code>…のように出力されます。そして、ラムダ関数が実際の関数が入る箇所です。とりあえず今回はコードを走らせ、結果から確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, </span>
<span id="cb19-3"><a href="#cb19-3"></a>                   <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">Q1 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-4"><a href="#cb19-4"></a>                               <span class="at">Q3 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>結果の列名が<code>Budget_Q1</code>、<code>Budget_Q3</code>、<code>ScoreN_Q1</code>…のようになり、それぞれの変数の第一四分位点と第三四分位点が出力されます。問題はラムダ関数の方ですが、普通の関数に非常に近いことが分かります。<code>across()</code>内のラムダ関数は<code>~関数名(.x, その他の引数)</code>のような書き方になります。関数名の前に<code>~</code>が付いていることに注意してください。分位数を求める関数は<code>quantile()</code>であり、<code>quantile(ベクトル, 分位数)</code>であり、必要に応じて<code>na.rm</code>を付けます。この分位数が0.25なら第一四分位点、0.5なら第二四分位点 (=中央値)、0.75なら第三四分位点になります。それではラムダ関数<code>~quantile(.x, 0.25, na.rm = TRUE)</code>はどういう意味でしょうか。これは<code>.x</code>の箇所に<code>Budget</code>や<code>ScoreN</code>、<code>Score</code>が入ることを意味します。<code>.x</code>という書き方は決まりです。<code>.y</code>とか<code>.Song-san-Daisuki</code>などはダメです。そして、<code>0.25</code>を付けることによって第一四分位点を出力するように指定します。また、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に欠損値がある場合、無視するように<code>na.rm = TRUE</code>を付けます。</p>
<p>ラムダ関数を第<a href="programming.html" class="quarto-xref"><span>11</span></a>章で解説した自作関数で表現すると、以下のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># 以下の3つは同じ機能をする関数である</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co"># ラムダ関数</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co"># 一般的な関数の書き方1</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-9"><a href="#cb21-9"></a>}</span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co"># 一般的な関数の書き方2</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この3つは全て同じですが、ラムダ関数は関数名を持たず、その場で使い捨てる関数です。むろん、ラムダ関数を使わずに事前に第一四分位点と第三四分位点を求める関数を予め作成し、ラムダ関数の代わりに使うことも可能です。まずは第一四分位点と第三四分位点を求める自作関数<code>FuncQ1</code>と<code>FuncQ2</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># ラムダ関数を使わない場合は事前に関数を定義しておく必要がある</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>FuncQ1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a>}</span>
<span id="cb22-5"><a href="#cb22-5"></a>FuncQ3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-7"><a href="#cb22-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>後は先ほどのほぼ同じ書き方ですが、今回はラムダ関数を使わないため関数名に<code>~</code>を付けず、関数名のみで十分です。<code>()</code>も不要です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># やっておくと、summarise()文は簡潔になる</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="fu">list</span>(<span class="at">Q1 =</span> FuncQ1, <span class="at">Q3 =</span> FuncQ3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>事前に関数を用意するのが面倒ですが、<code>across()</code>の中身はかなりスッキリしますね。もし、このような作業を何回も行うなら、ラムダ関数を使わず、自作関数を用いることも可能です。ただし、自作関数であっても引数が2つ以上必要な場合はラムダ関数を使います。</p>
</section>
<section id="summariseに使える便利な関数" class="level3" data-number="14.1.2">
<h3 data-number="14.1.2" class="anchored" data-anchor-id="summariseに使える便利な関数"><span class="header-section-number">14.1.2</span> <code>summarise()</code>に使える便利な関数</h3>
<p>以下の内容は後で説明する<code>group_by()</code>関数を使っているため、まだ<code>group_by()</code>に馴染みのない読者はまずはここを読み飛ばし、グルーピングの節にお進みください。</p>
<p><strong><code>IQR()</code>: 四分位範囲を求める</strong></p>
<p>四分位範囲は第三四分位点から第一四分位点を引いた値であり、Rの内蔵関数である<code>IQR()</code>を使えば便利です。この関数は<code>mean</code>や<code>sd()</code>関数と同じ使い方となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">|&gt;</span> <span class="co"># 予め欠損したケースを除くと、後でna.rm = TRUEが不要</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean    =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb25-5"><a href="#cb25-5"></a>            <span class="at">SD      =</span> <span class="fu">sd</span>(Walk),</span>
<span id="cb25-6"><a href="#cb25-6"></a>            <span class="at">IQR     =</span> <span class="fu">IQR</span>(Walk),</span>
<span id="cb25-7"><a href="#cb25-7"></a>            <span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb25-8"><a href="#cb25-8"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="fu">arrange</span>(Mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref      Mean    SD   IQR     N
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
1 東京都    4.29  4.49     4   919
2 大阪府    5.92  6.08     6   932
3 神奈川県  8.21  7.91    10   878
4 京都府    8.38  6.95     9   339
5 兵庫県    8.52  7.27    10   484
6 奈良県   10.6   6.59    10   123
7 千葉県   10.6   8.21    12   776
8 埼玉県   11.6   8.99    14   817
9 和歌山県 12.8   6.83     9   107</code></pre>
</div>
</div>
<p><strong><code>first()</code>、<code>last()</code>、<code>nth()</code>: n番目の要素を求める</strong></p>
<p>稀なケースかも知れませんが、データ内、またはグループ内の<code>n</code>番目の行を抽出する時があります。たとえば、市区町村の情報が格納されているデータセットで、人口が大きい順でデータがソートされているとします。各都道府県ごとに最も人口が大きい市区町村のデータ、あるいは最も少ない市区町村のデータが必要な際、<code>first()</code>と<code>last()</code>関数が有効です。</p>
<p>それでは各都道府県ごとに「最も駅から遠いラーメン屋」の店舗名と最寄りの駅からの徒歩距離を出力したいとします。まずは、徒歩距離のデータが欠損しているケースを除去し、データを徒歩距離順でソートします。これは<code>filter()</code>と<code>arrange()</code>関数を使えば簡単です。続いて、<code>group_by()</code>を使って都府県単位でデータをグループ化します。最後に<code>summarise()</code>関数内に<code>last()</code>関数を使います。データは駅から近い順に鳴っているため、各都府県内の最後の行は駅から最も遠い店舗になるからです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">arrange</span>(Walk) <span class="sc">|&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">summarise</span>(<span class="at">Farthest  =</span> <span class="fu">last</span>(Name),</span>
<span id="cb27-6"><a href="#cb27-6"></a>            <span class="at">Distance  =</span> <span class="fu">last</span>(Walk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Farthest                           Distance
  &lt;chr&gt;    &lt;chr&gt;                                 &lt;dbl&gt;
1 京都府   熱烈らぁめん                             30
2 兵庫県   濃厚醤油 中華そば いせや 玉津店          43
3 千葉県   札幌ラーメン どさん子 佐原51号店         59
4 和歌山県 中華そば まる乃                          30
5 埼玉県   札幌ラーメン どさん子 小鹿野店          116
6 大阪府   河童ラーメン本舗 岸和田店                38
7 奈良県   博多長浜らーめん 夢街道 四条大路店       29
8 東京都   てんがら 青梅新町店                      30
9 神奈川県 札幌ラーメン どさん子 中津店             73</code></pre>
</div>
</div>
<p>この<code>last()</code>を<code>first()</code>に変えると、最寄りの駅から最も近い店舗情報が表示されます。また、「<code>n</code>番目の情報」が必要な際は<code>nth()</code>関数を使います。<code>nth(Name, 2)</code>に変えることで2番目の店舗名が抽出できます。</p>
<p><strong><code>n_distinct()</code>: ユニーク値の個数を求める</strong></p>
<p><code>n_distinct()</code>は何種類の要素が含まれているかを計算する関数であり、<code>length(unique())</code>関数と同じ機能をします。たとえば、以下の<code>myVec1</code>に対して何種類の要素があるかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"C"</span>, <span class="st">"A"</span>)</span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">unique</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "A" "B" "D" "C"</code></pre>
</div>
</div>
<p><code>myVec1</code>は<code>"A"</code>、<code>"B"</code>、<code>"D"</code>、<code>"C"</code>の要素で構成されていることが分かります。これが<code>myVec1</code>の<strong>ユニーク値 (unique values)</strong>です。そして、このユニーク値の個数を調べるために<code>length()</code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(myVec1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>これで<code>myVec1</code>は4種類の値が存在することが分かります。これと全く同じ機能をする関数が<code>n_distinct()</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">n_distinct</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>この関数を<code>summarise()</code>に使うことで、都府県ごとに駅の個数が分かります。あるいは「東京都内の選挙区に、これまでの衆院選において何人の候補者が存在したか」も分かります。ここでは<code>df</code>内の都府県ごとに駅の個数を計算してみましょう。最後の駅数が多い順でソートします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Station)) <span class="sc">|&gt;</span> <span class="co"># 最寄りの駅が欠損しているケースを除去</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="fu">summarise</span>(<span class="at">N_Station =</span> <span class="fu">n_distinct</span>(Station),</span>
<span id="cb35-5"><a href="#cb35-5"></a>            <span class="at">.groups   =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N_Station))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     N_Station
  &lt;chr&gt;        &lt;int&gt;
1 東京都         368
2 大阪府         341
3 千葉県         241
4 神奈川県       240
5 兵庫県         199
6 埼玉県         185
7 京都府         123
8 奈良県          52
9 和歌山県        46</code></pre>
</div>
</div>
<p>当たり前かも知れませんが、駅数が最も多いのは東京都で次が大阪府であることが分かります。</p>
<p><strong><code>any()</code>、<code>all()</code>: 条件に合致するか否かを求める</strong></p>
<p><code>any()</code>と<code>all()</code>はベクトル内の全要素に対して条件に合致するか否かを判定する関数です。ただし、<code>any()</code>は一つの要素でも条件に合致すれば<code>TRUE</code>を、全要素が合致しない場合<code>FALSE</code>を返します。一方、<code>all()</code>は全要素に対して条件を満たせば<code>TRUE</code>、一つでも満たさない要素があれば<code>FALSE</code>を返します。以下は<code>any()</code>と<code>all()</code>の例です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>myVec2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="fu">any</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、一つでも余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">all</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、全ての余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">all</span>(myVec2 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>) <span class="co"># myVec2を2で割った場合、全ての余りが0ではないか</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>それでは実際に<code>df</code>に対して<code>any()</code>と<code>all()</code>関数を使ってみましょう。一つ目は「ある都府県に最寄りの駅から徒歩60分以上の店舗が<strong>一つでも</strong>あるか」であり、二つ目は「ある都府県の店舗は<strong>全て</strong>最寄りの駅から徒歩30分以下か」です。それぞれの結果を<code>Over60</code>と<code>Within30</code>という列で出力してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">summarise</span>(<span class="at">Over60   =</span> <span class="fu">any</span>(Walk <span class="sc">&gt;=</span> <span class="dv">60</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-4"><a href="#cb43-4"></a>            <span class="at">Within30 =</span> <span class="fu">all</span>(Walk <span class="sc">&lt;=</span> <span class="dv">30</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-5"><a href="#cb43-5"></a>            <span class="at">.groups  =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Over60 Within30
  &lt;chr&gt;    &lt;lgl&gt;  &lt;lgl&gt;   
1 京都府   FALSE  TRUE    
2 兵庫県   FALSE  FALSE   
3 千葉県   FALSE  FALSE   
4 和歌山県 FALSE  TRUE    
5 埼玉県   TRUE   FALSE   
6 大阪府   FALSE  FALSE   
7 奈良県   FALSE  TRUE    
8 東京都   FALSE  TRUE    
9 神奈川県 TRUE   FALSE   </code></pre>
</div>
</div>
<p>埼玉県と神奈川県において、最寄りの駅から徒歩60以上の店がありました。また、京都府、東京都、奈良県、和歌山県の場合、全店舗が最寄りの駅から徒歩30分以下ということが分かります。当たり前ですが<code>Over60</code>が<code>TRUE</code>なら<code>Within30</code>は必ず<code>FALSE</code>になりますね。</p>
</section>
</section>
<section id="sec-handling2-group" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="sec-handling2-group"><span class="header-section-number">14.2</span> グルーピング</h2>
<section id="group_byによるグループ化" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="group_byによるグループ化"><span class="header-section-number">14.2.1</span> <code>group_by()</code>によるグループ化</h3>
<p>先ほどの<code>summarise()</code>関数は確かに便利ですが、特段に便利とも言いにくいです。<code>df</code>の<code>Score</code>の平均値を計算するだけなら、<code>summarise()</code>関数を使わない方が楽です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># これまでのやり方</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># 普通にこれでええんちゃう?</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.663457</code></pre>
</div>
</div>
<p>しかし、これをグループごとに計算するならどうでしょう。たとえば、<code>Score</code>の平均値を都府県ごとに計算するとします。この場合、以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"東京都"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.674256</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"神奈川県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.533931</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"千葉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.715983</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"埼玉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.641573</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"大阪府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.765194</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"京都府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.684976</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"兵庫県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.543936</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"奈良県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.854762</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"和歌山県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.96999</code></pre>
</div>
</div>
<p>変わったのは<code>df$Score</code>が<code>df$Score[df$Pref == "東京都"]</code>に変わっただけです。<code>df$Pref</code>が<code>"東京都"</code>であるか否かを<code>TRUE</code>と<code>FALSE</code>で判定し、これを基準に<code>df$Score</code>を抽出する仕組みです。<code>df$Score</code>と<code>df$Pref</code>は同じデータフレームですから、このような書き方で問題ありません。</p>
<p>これだけでもかなり書くのが面倒ですが、これが47都道府県なら、あるいは200ヶ国ならかなり骨の折れる作業でしょう。ここで大活躍するのが{dplyr}パッケージの<code>group_by()</code>関数です。引数はグループ化する変数名だけです。先ほどの作業を{dplyr}を使うなら<code>Pref</code>変数でグループ化し、<code>summarise()</code>関数で平均値を求めるだけです。今回は<code>Score</code>だけでなく、<code>ScoreN</code>の平均値も求めてみましょう。そして、評価が高い順にソートもしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb67-5"><a href="#cb67-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb67-6"><a href="#cb67-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.17        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
<p>評判が最も高い都府県は和歌山県、最も低いのは神奈川県ですね。Songも和歌山ラーメンは井出系も車庫前系も好きです。しかし、大事なのは「井出系」と「車庫前系」といった分類が正しいかどうかではありません。コードが非常に簡潔となり、ソートなども自由自在であることです。都府県ごとに<code>ScoreN</code>と<code>Score</code>の平均値を求める場合、{dplyr}を使わなかったら18行のコードとなり、ソートも自分でやる必要があります。一方、<code>group_by()</code>関数を使うことによってコードが5行になりました。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>group_by()</code>と同じ機能を持つ<code>.by</code>引数
</div>
</div>
<div class="callout-body-container callout-body">
<p>最新の{dplyr}を使う場合（2024年03月26日現在、{dplyr}1.1.4）、<code>group_by()</code>関数を使わず、<code>summarise()</code>関数内に<code>.by</code>引数を指定しても同じ動きをします。具体的には<code>.by = グルーピングする変数名</code>を追加するだけです。したがって、以下は上記のコードと同じ内容です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb69-3"><a href="#cb69-3"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb69-4"><a href="#cb69-4"></a>            <span class="at">.by         =</span> Pref) <span class="sc">|&gt;</span></span>
<span id="cb69-5"><a href="#cb69-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.17        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
</div>
</div>
<p>続いて、一つ便利な関数を紹介します。それはグループのサイズを計算する関数、<code>n()</code>です。この関数を<code>summarise()</code>内に使うと、各グループに属するケース数を出力します<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。先ほどのコードを修正し、各グループのサイズを<code>N</code>という名の列として追加してみましょう。そしてソートの順番は<code>N</code>を最優先とし、同じ場合は<code>Score_Mean</code>が高い方を上に出力させます。また、<code>ScoreN_Mean</code>の前に、口コミ数の合計も出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># Prefごとに口コミ数の合計、口コミ数の平均値、評価の平均値、店舗数を求める</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="co"># 店舗数-評価の平均値順でソートする</span></span>
<span id="cb71-3"><a href="#cb71-3"></a>df <span class="sc">|&gt;</span></span>
<span id="cb71-4"><a href="#cb71-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">|&gt;</span></span>
<span id="cb71-5"><a href="#cb71-5"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb71-6"><a href="#cb71-6"></a>            <span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb71-7"><a href="#cb71-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb71-8"><a href="#cb71-8"></a>            <span class="at">N           =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb71-9"><a href="#cb71-9"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     ScoreN_Sum ScoreN_Mean Score_Mean     N
  &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 大阪府          516       0.516       3.77  1000
2 千葉県          259       0.259       3.72  1000
3 東京都         1165       1.17        3.67  1000
4 埼玉県          278       0.278       3.64  1000
5 神奈川県        587       0.587       3.53  1000
6 兵庫県          230       0.389       3.54   591
7 京都府          216       0.522       3.68   414
8 奈良県           45       0.306       3.85   147
9 和歌山県         83       0.593       3.97   140</code></pre>
</div>
</div>
<p>記述統計をグループごとに求めるのは普通にあり得るケースですし、実験データの場合はほぼ必須の作業でう。統制群と処置群間においてグループサイズが均一か、共変量のバラツキが十分に小さいかなどを判断する際に<code>group_by()</code>と<code>summarise()</code>関数の組み合わせは非常に便利です。</p>
</section>
<section id="複数の変数を用いたグループ化" class="level3" data-number="14.2.2">
<h3 data-number="14.2.2" class="anchored" data-anchor-id="複数の変数を用いたグループ化"><span class="header-section-number">14.2.2</span> 複数の変数を用いたグループ化</h3>
<p>グループ化変数は2つ以上指定することも可能です。たとえば、都府県 (<code>Pref</code>)と最寄りの駅の路線 (<code>Line</code>)でグループ化することも可能です。それでは<code>Pref</code>と<code>Line</code>でグループ化し、店舗数と口コミ数、評価の平均値を計算し、ソートの順番は店舗数、店舗数が同じなら評価の平均値が高い順にしましょう。今回はTop 20まで出してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb73-2"><a href="#cb73-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb73-3"><a href="#cb73-3"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">|&gt;</span> <span class="co"># Lineが欠損していないケースのみ残す</span></span>
<span id="cb73-4"><a href="#cb73-4"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">|&gt;</span> <span class="co"># PrefとLineでグループ化</span></span>
<span id="cb73-5"><a href="#cb73-5"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb73-6"><a href="#cb73-6"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb73-7"><a href="#cb73-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb73-8"><a href="#cb73-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">|&gt;</span></span>
<span id="cb73-9"><a href="#cb73-9"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
# Groups:   Pref [9]
   Pref     Line                        N ScoreN_Sum Score_Mean
   &lt;chr&gt;    &lt;chr&gt;                   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 埼玉県   東武東上線                122         27       3.68
 2 東京都   ＪＲ                      104        231       3.56
 3 神奈川県 小田急小田原線             96         31       3.59
 4 埼玉県   東武伊勢崎線               96         18       3.51
 5 神奈川県 横浜市営ブルーライン       82         77       3.66
 6 千葉県   京成本線                   82         29       3.34
 7 神奈川県 京急本線                   68         40       3.33
 8 千葉県   東武野田線                 63          2       4.75
 9 神奈川県 小田急江ノ島線             62          8       3.79
10 大阪府   阪急京都本線               53         32       3.67
11 大阪府   南海本線                   52         11       4.22
12 兵庫県   阪神本線                   52         23       3.80
13 埼玉県   JR高崎線                   51          5       4   
14 兵庫県   山陽電鉄本線               51         15       2.98
15 千葉県   JR総武本線（東京-銚子）    47          8       4   
16 埼玉県   西武新宿線                 45          8       4.17
17 埼玉県   秩父鉄道線                 43         10       3.82
18 大阪府   京阪本線                   43         10       3.69
19 千葉県   新京成電鉄                 43          6       3.6 
20 京都府   阪急京都本線               43         27       3.5 
# ℹ 503 more rows</code></pre>
</div>
</div>
<p>結果としては問題ないように見えますが、気になるメッセージが出力されます。</p>
<pre><code>`summarise()` has grouped output by 'Pref'. You can override using the `.groups` argument.</code></pre>
<p>これは<code>Line</code>はグルーピング変数として機能しなくなり、<code>Pref</code>変数のみグループ変数になったという意味です。なぜ<code>Line</code>が解除され、<code>Pref</code>が残るかというと、それは<code>group_by()</code>関数内で<code>Pref</code>を先に指定したからです。<code>group_by(Line, Pref)</code>でグルーピングすると、<code>Pref</code>が解除され、<code>Line</code>のみがグルーピング変数となります。<code>summarise()</code>後のグルーピング変数の扱いは<code>summarise()</code>関数の<code>.groups</code>引数で指定できます。既定値は<code>.groups = "drop_last"</code>で「最後のグルーピング変数を解除する」という意味です（場合によっては既定値が<code>"keep"</code>になりますが、後述します）。多くの場合、<code>summarise()</code>後は全グルーピングを解除するのが一般的なので、この場合は<code>.groups = "drop"</code>と指定します。もし、グルーピングを維持したい場合は<code>.groups = "keep"</code>と指定します。今回の例は<code>summarise()</code>内に<code>.group = "drop"</code>を指定し、グループ化を解除します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">|&gt;</span></span>
<span id="cb77-3"><a href="#cb77-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">|&gt;</span></span>
<span id="cb77-4"><a href="#cb77-4"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb77-5"><a href="#cb77-5"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-6"><a href="#cb77-6"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-7"><a href="#cb77-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> <span class="co"># グルーピングをすべて解除する</span></span>
<span id="cb77-8"><a href="#cb77-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">|&gt;</span></span>
<span id="cb77-9"><a href="#cb77-9"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
   Pref     Line                        N ScoreN_Sum Score_Mean
   &lt;chr&gt;    &lt;chr&gt;                   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 埼玉県   東武東上線                122         27       3.68
 2 東京都   ＪＲ                      104        231       3.56
 3 神奈川県 小田急小田原線             96         31       3.59
 4 埼玉県   東武伊勢崎線               96         18       3.51
 5 神奈川県 横浜市営ブルーライン       82         77       3.66
 6 千葉県   京成本線                   82         29       3.34
 7 神奈川県 京急本線                   68         40       3.33
 8 千葉県   東武野田線                 63          2       4.75
 9 神奈川県 小田急江ノ島線             62          8       3.79
10 大阪府   阪急京都本線               53         32       3.67
11 大阪府   南海本線                   52         11       4.22
12 兵庫県   阪神本線                   52         23       3.80
13 埼玉県   JR高崎線                   51          5       4   
14 兵庫県   山陽電鉄本線               51         15       2.98
15 千葉県   JR総武本線（東京-銚子）    47          8       4   
16 埼玉県   西武新宿線                 45          8       4.17
17 埼玉県   秩父鉄道線                 43         10       3.82
18 大阪府   京阪本線                   43         10       3.69
19 千葉県   新京成電鉄                 43          6       3.6 
20 京都府   阪急京都本線               43         27       3.5 
# ℹ 503 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>group_by()</code>と同じ機能を持つ<code>.by</code>引数
</div>
</div>
<div class="callout-body-container callout-body">
<p>ちなみに<code>.by</code>引数でグルーピングを行う場合は自動的にグルーピングが解除されるので、<code>.groups = "drop"</code>は不要です。したがって、以下は上記のコードと同じ内容となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb79-2"><a href="#cb79-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">|&gt;</span> </span>
<span id="cb79-3"><a href="#cb79-3"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb79-4"><a href="#cb79-4"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb79-5"><a href="#cb79-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb79-6"><a href="#cb79-6"></a>            <span class="at">.by         =</span> <span class="fu">c</span>(Pref, Line)) <span class="sc">|&gt;</span></span>
<span id="cb79-7"><a href="#cb79-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">|&gt;</span></span>
<span id="cb79-8"><a href="#cb79-8"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
   Pref     Line                        N ScoreN_Sum Score_Mean
   &lt;chr&gt;    &lt;chr&gt;                   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 埼玉県   東武東上線                122         27       3.68
 2 東京都   ＪＲ                      104        231       3.56
 3 神奈川県 小田急小田原線             96         31       3.59
 4 埼玉県   東武伊勢崎線               96         18       3.51
 5 神奈川県 横浜市営ブルーライン       82         77       3.66
 6 千葉県   京成本線                   82         29       3.34
 7 神奈川県 京急本線                   68         40       3.33
 8 千葉県   東武野田線                 63          2       4.75
 9 神奈川県 小田急江ノ島線             62          8       3.79
10 大阪府   阪急京都本線               53         32       3.67
11 大阪府   南海本線                   52         11       4.22
12 兵庫県   阪神本線                   52         23       3.80
13 埼玉県   JR高崎線                   51          5       4   
14 兵庫県   山陽電鉄本線               51         15       2.98
15 千葉県   JR総武本線（東京-銚子）    47          8       4   
16 埼玉県   西武新宿線                 45          8       4.17
17 埼玉県   秩父鉄道線                 43         10       3.82
18 大阪府   京阪本線                   43         10       3.69
19 千葉県   新京成電鉄                 43          6       3.6 
20 京都府   阪急京都本線               43         27       3.5 
# ℹ 503 more rows</code></pre>
</div>
</div>
</div>
</div>
<p>ぐるなびに登録されているラーメン屋が最も多い路線は埼玉県内の東武東上線で122店舗があります。東武東上線は東京都と埼玉県をまたがる路線ですので、東武東上線だけならもっと多いかも知れませんね。</p>
<p>ここで<code>.groups</code>引数についてもう少し考えてみたいと思います。多くの場合、<code>.groups</code>引数の既定値は<code>"drop_last"</code>ですが、場合によっては<code>"keep"</code>になるケースもあります。それは記述統計量の結果が長さ2以上のベクトルである場合です。平均値を求める<code>mean()</code>、標準偏差を求める<code>sd()</code>などは、結果として長さ1のベクトルを返します。しかし、長さ2以上ののベクトルを返す関数もあります。たとえば、分位数を求める<code>quantile()</code>関数があります。<code>quantile(ベクトル名, 0.25)</code>の場合、第一四分位点のみ返すため、結果は長さ1のベクトルです。しかし、<code>quantile(ベクトル名, c(0.25, 0.5, 0.75))</code>のように第一四分位点から第三四分位点を同時に計算し、長さ3のベクトルが返されるケースもありますし、第二引数を省略すると、最小値・第一四分位点・第二四分位点・第三四分位点・最大値、つまり、長さ5のベクトルが返される場合があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="co"># 第一四分位点のみを求める (長さ1のベクトル)</span></span>
<span id="cb81-2"><a href="#cb81-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25% 
  2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="co"># 引数を省略する (長さ5のベクトル)</span></span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%  25%  50%  75% 100% 
   1    2    5   12  116 </code></pre>
</div>
</div>
<p><code>.groups</code>のデフォルト値が<code>"keep"</code>になるのは、このように長さ2以上のベクトルが返されるケースです。たとえば、都府県と最寄りの駅の路線でグループ化し、店舗までの徒歩距離の平均値を求めるとします。デフォルト値の変化を見るために、ここではあえて<code>.groups</code>引数を省略しました。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">|&gt;</span></span>
<span id="cb85-3"><a href="#cb85-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">|&gt;</span></span>
<span id="cb85-4"><a href="#cb85-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Walk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 509 × 3
# Groups:   Pref [9]
   Pref   Line                       Mean
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;
 1 京都府 JR奈良線                   3.33
 2 京都府 JR小浜線                  16.5 
 3 京都府 JR山陰本線（京都-米子）    8.67
 4 京都府 JR東海道本線（米原-神戸） 16.3 
 5 京都府 JR片町線〔学研都市線〕     9.4 
 6 京都府 JR舞鶴線                  19   
 7 京都府 京福北野線                 8.36
 8 京都府 京福嵐山本線               6.5 
 9 京都府 京福電気鉄道嵐山本線       6   
10 京都府 京都丹後鉄道宮福線         7.44
# ℹ 499 more rows</code></pre>
</div>
</div>
<p>最初は<code>Pref</code>と<code>Line</code>でグループ化しましたが、<code>summarise()</code>の後、<code>Line</code>がグループ化変数から外されました。つまり、引数が<code>"drop_last"</code>になっていることです。</p>
<p>それでは、平均値に加えて、第一四分位点と第三四分位点も計算し、<code>Quantile</code>という名で格納してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">|&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">|&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean     =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb88-5"><a href="#cb88-5"></a>            <span class="at">Quantile =</span> <span class="fu">quantile</span>(Walk, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in
dplyr 1.1.0.
ℹ Please use `reframe()` instead.
ℹ When switching from `summarise()` to `reframe()`, remember that `reframe()`
  always returns an ungrouped data frame and adjust accordingly.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref', 'Line'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,018 × 4
# Groups:   Pref, Line [509]
   Pref   Line                       Mean Quantile
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;    &lt;dbl&gt;
 1 京都府 JR奈良線                   3.33     2   
 2 京都府 JR奈良線                   3.33     5   
 3 京都府 JR小浜線                  16.5      9.75
 4 京都府 JR小浜線                  16.5     23.2 
 5 京都府 JR山陰本線（京都-米子）    8.67     2   
 6 京都府 JR山陰本線（京都-米子）    8.67    15   
 7 京都府 JR東海道本線（米原-神戸） 16.3     16   
 8 京都府 JR東海道本線（米原-神戸） 16.3     17   
 9 京都府 JR片町線〔学研都市線〕     9.4      2   
10 京都府 JR片町線〔学研都市線〕     9.4      9   
# ℹ 1,008 more rows</code></pre>
</div>
</div>
<p>同じ<code>Pref</code>、<code>Line</code>のケースが2つずつ出来ています。最初に来る数値は第一四分位点、次に来るのが第三四分位点です。そして最初のグループ化変数であった<code>Pref</code>と<code>Line</code>が、<code>summarise()</code>後もグループ化変数として残っていることが分かります。</p>
<p>しかし、気になる警告（warning）が表示されますね。</p>
<pre><code>Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in
dplyr 1.1.0.
ℹ Please use `reframe()` instead.
ℹ When switching from `summarise()` to `reframe()`, remember that `reframe()`
  always returns an ungrouped data frame and adjust accordingly.</code></pre>
<p>これは「長さ2以上のベクトルを返す場合、<code>summarise()</code>を使うな！」という意味です。今は警告が出るだけで結果としては問題なく動いてますが、{dplyr}1.1.0以降は<code>reframe()</code>関数の仕様を推奨しています。これは<code>summarise()</code>を<code>reframe()</code>に変えるだけで対応可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb93-2"><a href="#cb93-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">|&gt;</span></span>
<span id="cb93-3"><a href="#cb93-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">|&gt;</span></span>
<span id="cb93-4"><a href="#cb93-4"></a>  <span class="fu">reframe</span>(<span class="at">Mean     =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb93-5"><a href="#cb93-5"></a>          <span class="at">Quantile =</span> <span class="fu">quantile</span>(Walk, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,018 × 4
   Pref   Line                       Mean Quantile
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;    &lt;dbl&gt;
 1 京都府 JR奈良線                   3.33     2   
 2 京都府 JR奈良線                   3.33     5   
 3 京都府 JR小浜線                  16.5      9.75
 4 京都府 JR小浜線                  16.5     23.2 
 5 京都府 JR山陰本線（京都-米子）    8.67     2   
 6 京都府 JR山陰本線（京都-米子）    8.67    15   
 7 京都府 JR東海道本線（米原-神戸） 16.3     16   
 8 京都府 JR東海道本線（米原-神戸） 16.3     17   
 9 京都府 JR片町線〔学研都市線〕     9.4      2   
10 京都府 JR片町線〔学研都市線〕     9.4      9   
# ℹ 1,008 more rows</code></pre>
</div>
</div>
<p><code>reframe()</code>の場合、自動的にグルーピングが解除されます（<code>.groups</code>引数の指定はできません）。長さ2以上のベクトルを返す関数を使用する場合は、なるべく<code>summarise()</code>のかわりに<code>reframe()</code>を使いましょう。</p>


</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>ただし、<code>~関数名()</code>のような書き方のラムダ式は{purrr}パッケージが提供しているわけではない。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>今回の例のように記述統計量とケース数を同時に計算する場合は<code>n()</code>を使いますが、ケース数<strong>のみ</strong>を計算する場合は<code>group_by()</code>と<code>summarise()</code>と組み合わせず、<code>count()</code>関数だけ使うことも可能です。グループ化変数（ここでは<code>Pref</code>）を<code>count()</code>の引数として指定すると、<code>Pref</code>の値ごとのケース数が表示されます。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jaysong\.net\/RBook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./datahandling1.html" class="pagination-link" aria-label="データハンドリング [抽出]">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./datahandling3.html" class="pagination-link" aria-label="データハンドリング [拡張]">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, <a href="https://www.jaysong.net">Jaehyun Song</a> and <a href="https://yukiyanai.github.io/">Yuki Yanai</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>