<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>私たちのR - 13&nbsp; データハンドリング [拡張]</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./factor.html" rel="next">
<link href="./datahandling1.html" rel="prev">
<link href="./Figs/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CEHS4C056W"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CEHS4C056W', { 'anonymize_ip': false});
</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta property="og:title" content="私たちのR: ベストプラクティスの探求">
<meta property="og:description" content="R Not for Everyone: An Esoteric Guide">
<meta property="og:image" content="https://www.jaysong.net/RBook/Figs/favicon.png">
<meta property="og:site-name" content="私たちのR">
<meta property="og:image:height" content="260">
<meta property="og:image:width" content="260">
<meta name="twitter:title" content="私たちのR: ベストプラクティスの探求">
<meta name="twitter:description" content="R Not for Everyone: An Esoteric Guide">
<meta name="twitter:image" content="https://www.jaysong.net/RBook/Figs/favicon.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="260">
<meta name="twitter:image-width" content="260">
</head>

<body class="nav-sidebar docked">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">私たちのR</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/JaehyunSong/RBook/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">紹介</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Rの導入</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aboutr.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./installation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Rのインストール</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ide.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">IDEの導入</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_customize.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">分析環境のカスタマイズ</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./packages.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Rパッケージ</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Rの基礎</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_basic.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">基本的な操作</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./io.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">データの入出力</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datatype.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データ型</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datastructure.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">データ構造</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Rプログラミングの基礎</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">関数の自作</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">データハンドリング</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datahandling2.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factor.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [factor型]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidydata.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">整然データ構造</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./string.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">文字列の処理</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">可視化</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">可視化 [理論]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">可視化 [基礎]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">可視化 [応用]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">可視化 [発展]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">モデルの可視化</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">再現可能な研究</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">R Markdown [基礎]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">R Markdown [応用]</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Quarto入門</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./table.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">表の作成</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./renv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">分析環境の管理</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">中級者向け</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">反復処理</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./oop.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">オブジェクト指向プログラミング</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./monte.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">モンテカルロ・シミュレーション</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scraping.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">スクレイピング</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./api.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">API</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">付録</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dataset.html" class="sidebar-item-text sidebar-link">データセット</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tips.html" class="sidebar-item-text sidebar-link">R Tips</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link">本書の執筆環境</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">参考文献</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#sec-handling2-summarise" id="toc-sec-handling2-summarise" class="nav-link active" data-scroll-target="#sec-handling2-summarise"><span class="toc-section-number">13.1</span>  記述統計量の計算</a>
  <ul class="collapse">
  <li><a href="#summariseによる記述統計量の計算" id="toc-summariseによる記述統計量の計算" class="nav-link" data-scroll-target="#summariseによる記述統計量の計算"><span class="toc-section-number">13.1.1</span>  <code>summarise()</code>による記述統計量の計算</a></li>
  <li><a href="#summariseに使える便利な関数" id="toc-summariseに使える便利な関数" class="nav-link" data-scroll-target="#summariseに使える便利な関数"><span class="toc-section-number">13.1.2</span>  <code>summarise()</code>に使える便利な関数</a></li>
  </ul></li>
  <li><a href="#sec-handling2-group" id="toc-sec-handling2-group" class="nav-link" data-scroll-target="#sec-handling2-group"><span class="toc-section-number">13.2</span>  グルーピング</a>
  <ul class="collapse">
  <li><a href="#group_byによるグループ化" id="toc-group_byによるグループ化" class="nav-link" data-scroll-target="#group_byによるグループ化"><span class="toc-section-number">13.2.1</span>  <code>group_by()</code>によるグループ化</a></li>
  <li><a href="#複数の変数を用いたグループ化" id="toc-複数の変数を用いたグループ化" class="nav-link" data-scroll-target="#複数の変数を用いたグループ化"><span class="toc-section-number">13.2.2</span>  複数の変数を用いたグループ化</a></li>
  </ul></li>
  <li><a href="#sec-handling2-mutate" id="toc-sec-handling2-mutate" class="nav-link" data-scroll-target="#sec-handling2-mutate"><span class="toc-section-number">13.3</span>  変数の計算</a>
  <ul class="collapse">
  <li><a href="#mutate関数の使い方" id="toc-mutate関数の使い方" class="nav-link" data-scroll-target="#mutate関数の使い方"><span class="toc-section-number">13.3.1</span>  <code>mutate()</code>関数の使い方</a></li>
  </ul></li>
  <li><a href="#sec-handling2-rowwise" id="toc-sec-handling2-rowwise" class="nav-link" data-scroll-target="#sec-handling2-rowwise"><span class="toc-section-number">13.4</span>  行単位の操作</a></li>
  <li><a href="#sec-handling2-merge" id="toc-sec-handling2-merge" class="nav-link" data-scroll-target="#sec-handling2-merge"><span class="toc-section-number">13.5</span>  データの結合</a>
  <ul class="collapse">
  <li><a href="#行の結合" id="toc-行の結合" class="nav-link" data-scroll-target="#行の結合"><span class="toc-section-number">13.5.1</span>  行の結合</a></li>
  <li><a href="#列の結合" id="toc-列の結合" class="nav-link" data-scroll-target="#列の結合"><span class="toc-section-number">13.5.2</span>  列の結合</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-datahandling2" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データハンドリング [拡張]</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>前章ではデータの一部 (subset)を抽出する方法について説明しましたが、本章はデータを拡張する、あるいは全く別のデータが得られるような処理について解説します。後者は主に元のデータを要約し (記述統計量)、その結果を出力する方法で、前者はデータ内の変数に基づき、指定された計算を行った結果を新しい列として追加する方法です。今回も<a href="Data/Ramen.csv">前章と同じデータ</a>を使用します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># データのパスは適宜修正すること</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># 文字化けが生じる場合、以下のコードに書き換える。</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># df &lt;- read_csv("Data/Ramen.csv", locale = locale(encoding = "utf8"))</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データの詳細については第<a href="datahandling1.html#sec-handling1-select"><span>12.3</span></a>章を参照してください。</p>
<section id="sec-handling2-summarise" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="sec-handling2-summarise"><span class="header-section-number">13.1</span> 記述統計量の計算</h2>
<section id="summariseによる記述統計量の計算" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="summariseによる記述統計量の計算"><span class="header-section-number">13.1.1</span> <code>summarise()</code>による記述統計量の計算</h3>
<p>ある変数の平均値や標準偏差、最小値、最大値などの記述統計量 (要約統計量)を計算することも可能です。これは<code>summarize()</code>または<code>summarise()</code>関数を使いますが、この関数は後で紹介する<code>group_by()</code>関数と組み合わせることで力を発揮します。ここではグルーピングを考えずに、全データの記述統計量を計算する方法を紹介します。</p>
<p><code>summarise()</code>関数の使い方は以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># summarise()関数の使い方</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">summarise</span>(新しい変数名 <span class="ot">=</span> 関数名(計算の対象となる変数名))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>もし、<code>Score</code>変数の平均値を計算し、その結果を<code>Mean</code>という列にしたい場合は以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1    NA</code></pre>
</div>
</div>
<p>ただし、<code>mean()</code>関数は欠損値が含まれるベクトルの場合、<code>NA</code>を返します。この場合方法は2つ考えられます。</p>
<ol type="1">
<li><code>filter()</code>関数を使って<code>Score</code>が欠損しているケースを予め除去する。</li>
<li><code>na.rm</code>引数を指定し、欠損値を除去した平均値を求める。</li>
</ol>
<p>ここでは2番目の方法を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
</div>
<p><code>df</code>の<code>Score</code>変数の平均値はNAであることが分かります。また、<code>summarise()</code>関数は複数の記述統計量を同時に計算することも可能です。以下は<code>Score</code>変数の平均値、中央値、標準偏差、最小値、最大値、第一四分位点、第三四分位点を計算し、<code>Score.Desc</code>という名のデータフレームに格納するコードです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>Score.Desc <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">summarize</span>(<span class="at">Mean   =</span>     <span class="fu">mean</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 平均値</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>            <span class="at">Median =</span>   <span class="fu">median</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 中央値</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>            <span class="at">SD     =</span>       <span class="fu">sd</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 標準偏差</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>            <span class="at">Min    =</span>      <span class="fu">min</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最小値</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>            <span class="at">Max    =</span>      <span class="fu">max</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最大値</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>            <span class="at">Q1     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 第一四分位点</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>            <span class="at">Q3     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))  <span class="co"># 第三四分位点</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>Score.Desc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
   Mean Median    SD   Min   Max    Q1    Q3
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  3.66   3.58 0.719     1     5     3     4</code></pre>
</div>
</div>
<p>むろん、複数の変数に対して記述統計量を計算することも可能です。たとえば、平均予算 (<code>Budget</code>)、口コミ数 (<code>ScoreN</code>)、口コミ評価 (<code>Score</code>)の平均値を求めるとしたら、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 平均予算の平均値</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>            <span class="at">SocreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 口コミ数の平均値</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="co"># 評価の平均値</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget_Mean SocreN_Mean Score_Mean
        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
1       1232.       0.537       3.66</code></pre>
</div>
</div>
<p>のように書きます。実は<code>summarise()</code>はこれくらいで十分便利です。ただし、以上の操作はもっと簡単なコードに置換できます。ただし、ラムダ式など、やや高度な内容になるため、以下の内容は飛ばして、次の節 (グルーピング)を読んでいただいても構いません。</p>
<p>まずは、複数の変数に対して同じ記述統計量を求める例を考えてみましょう。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に対して平均値を求める例です。これは<code>across()</code>関数を使うとよりコードが短くなります。まずは<code>across()</code>関数の書き方から見ましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># across()の使い方</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, 記述統計を計算する関数名, 関数の引数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>変数名のベクトル</em>は長さ1以上のベクトルです。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の場合<code>c(Budget, ScoreN, Score)</code>になります。これは<code>df</code>内で隣接する変数ですから<code>Budget:Score</code>の書き方も使えます。また、<code>where()</code>や<code>any_of()</code>、<code>starts_with()</code>のような関数を使って変数を指定することも可能です。<em>関数名</em>は<code>mean</code>や<code>sd</code>などの関数名です。ここは<code>関数名()</code>でななく、<code>関数名</code>であることに注意してください。<em>引数</em>は前の関数に必要な引数です。引数を必要としない関数なら省略可能ですが、<code>na.rm = TRUE</code>などの引数が必要な場合は指定する必要があります。それでは<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の平均値を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `summarize()`.
ℹ In argument: `across(Budget:Score, mean, na.rm = TRUE)`.
Caused by warning:
! The `...` argument of `across()` is deprecated as of dplyr 1.1.0.
Supply arguments directly to `.fns` through an anonymous function instead.

  # Previously
  across(a:b, mean, na.rm = TRUE)

  # Now
  across(a:b, \(x) mean(x, na.rm = TRUE))</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget ScoreN Score
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1  1232.  0.537  3.66</code></pre>
</div>
</div>
<p><code>across()</code>使わない場合、4行必要だったコードが2行になりました。変数が少ない場合は<code>across()</code>を使わない方が、可読性が高くなる場合もあります。しかし、変数が多くなる場合、可読性がやや落ちても<code>across()</code>を使った方が効率的でしょう。</p>
<p>次は、ある変数に対して複数の記述統計量を計算したい場合について考えます。<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>変数の第一四分位点と第三四分位点を<code>across()</code>を使わずに計算すると家のような7行のコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Q1 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-3"><a href="#cb16-3"></a>            <span class="at">Budget_Q3 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-4"><a href="#cb16-4"></a>            <span class="at">ScoreN_Q1 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-5"><a href="#cb16-5"></a>            <span class="at">ScoreN_Q3 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-6"><a href="#cb16-6"></a>            <span class="at">Score_Q1  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-7"><a href="#cb16-7"></a>            <span class="at">Score_Q3  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>この作業も<code>across()</code>を使ってより短縮することができます。ここではラムダ式の知識が必要になります。ラムダ関数とは関数名を持たない<a href="https://ja.wikipedia.org/wiki/無名関数">無名関数 (anonymous functions)</a>を意味しますが、詳細は割愛します。興味のある読者は<a href="https://ja.wikipedia.org/wiki/無名関数">Wikipedia</a>などを参照してください。簡単にいうとその場で即席に関数を作成し、計算が終わったら破棄する関数です。ただ、Rは基本的にラムダ式を提供しているのではなく、<code>purrr</code>パッケージのラムダ式スタイルを使用します。まずは、書き方から確認します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># ラムダ式を用いたacross()の使い方</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, <span class="at">.fns =</span> <span class="fu">list</span>(結果の変数名 <span class="ot">=</span> ラムダ式)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>先ほどの書き方と似ていますが、関数を複数書く必要があるため、今回は関数名をlist型にまとめ、<code>.fns</code>引数に指定します。そして、<em>結果の変数名</em>は結果として出力されるデータフレームの列名を指定する引数です。たとえば、<code>Mean</code>にすると結果は<code>元の変数名1_Mean</code>、<code>元の変数名2_Mean</code>…のように出力されます。そして、ラムダ式が実際の関数が入る箇所です。とりあえず今回はコードを走らせ、結果から確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, </span>
<span id="cb19-3"><a href="#cb19-3"></a>                   <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">Q1 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-4"><a href="#cb19-4"></a>                               <span class="at">Q3 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>結果の列名が<code>Budget_Q1</code>、<code>Budget_Q3</code>、<code>ScoreN_Q1</code>…のようになり、それぞれの変数の第一四分位点と第三四分位点が出力されます。問題はラムダ式の方ですが、普通の関数に非常に近いことが分かります。<code>across()</code>内のラムダ式は<code>~関数名(.x, その他の引数)</code>のような書き方になります。関数名の前に<code>~</code>が付いていることに注意してください。分位数を求める関数は<code>quantile()</code>であり、<code>quantile(ベクトル, 分位数)</code>であり、必要に応じて<code>na.rm</code>を付けます。この分位数が0.25なら第一四分位点、0.5なら第二四分位点 (=中央値)、0.75なら第三四分位点になります。それではラムダ式<code>~quantile(.x, 0.25, na.rm = TRUE)</code>はどういう意味でしょうか。これは<code>.x</code>の箇所に<code>Budget</code>や<code>ScoreN</code>、<code>Score</code>が入ることを意味します。<code>.x</code>という書き方は決まりです。<code>.y</code>とか<code>.Song-san-Daisuki</code>などはダメです。そして、<code>0.25</code>を付けることによって第一四分位点を出力するように指定します。また、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に欠損値がある場合、無視するように<code>na.rm = TRUE</code>を付けます。</p>
<p>ラムダ式を第<a href="programming.html"><span>10</span></a>章で解説した自作関数で表現すると、以下のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># 以下の3つは同じ機能をする関数である</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co"># ラムダ式</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co"># 一般的な関数の書き方1</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-9"><a href="#cb21-9"></a>}</span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co"># 一般的な関数の書き方2</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この3つは全て同じですが、ラムダ式は関数名を持たず、その場で使い捨てる関数です。むろん、ラムダ式を使わずに事前に第一四分位点と第三四分位点を求める関数を予め作成し、ラムダ式の代わりに使うことも可能です。まずは第一四分位点と第三四分位点を求める自作関数<code>FuncQ1</code>と<code>FuncQ2</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># ラムダ式を使わない場合は事前に関数を定義しておく必要がある</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>FuncQ1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a>}</span>
<span id="cb22-5"><a href="#cb22-5"></a>FuncQ3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-7"><a href="#cb22-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>後は先ほどのほぼ同じ書き方ですが、今回はラムダ式を使わないため関数名に<code>~</code>を付けず、関数名のみで十分です。<code>()</code>も不要です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># やっておくと、summarise()文は簡潔になる</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="fu">list</span>(<span class="at">Q1 =</span> FuncQ1, <span class="at">Q3 =</span> FuncQ3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>事前に関数を用意するのが面倒ですが、<code>across()</code>の中身はかなりスッキリしますね。もし、このような作業を何回も行うなら、ラムダ式を使わず、自作関数を用いることも可能です。ただし、自作関数であっても引数が2つ以上必要な場合はラムダ式を使います。</p>
</section>
<section id="summariseに使える便利な関数" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="summariseに使える便利な関数"><span class="header-section-number">13.1.2</span> <code>summarise()</code>に使える便利な関数</h3>
<p>以下の内容は後で説明する<code>group_by()</code>関数を使っているため、まだ<code>group_by()</code>に馴染みのない読者はまずはここを読み飛ばし、グルーピングの節にお進みください。</p>
<p><strong><code>IQR()</code>: 四分位範囲を求める</strong></p>
<p>四分位範囲は第三四分位点から第一四分位点を引いた値であり、Rの内蔵関数である<code>IQR()</code>を使えば便利です。この関数は<code>mean</code>や<code>sd()</code>関数と同じ使い方となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span> <span class="co"># 予め欠損したケースを除くと、後でna.rm = TRUEが不要</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean    =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb25-5"><a href="#cb25-5"></a>            <span class="at">SD      =</span> <span class="fu">sd</span>(Walk),</span>
<span id="cb25-6"><a href="#cb25-6"></a>            <span class="at">IQR     =</span> <span class="fu">IQR</span>(Walk),</span>
<span id="cb25-7"><a href="#cb25-7"></a>            <span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb25-8"><a href="#cb25-8"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="fu">arrange</span>(Mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref      Mean    SD   IQR     N
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
1 東京都    4.29  4.49     4   919
2 大阪府    5.92  6.08     6   932
3 神奈川県  8.21  7.91    10   878
4 京都府    8.38  6.95     9   339
5 兵庫県    8.52  7.27    10   484
6 奈良県   10.6   6.59    10   123
7 千葉県   10.6   8.21    12   776
8 埼玉県   11.6   8.99    14   817
9 和歌山県 12.8   6.83     9   107</code></pre>
</div>
</div>
<p><strong><code>first()</code>、<code>last()</code>、<code>nth()</code>: n番目の要素を求める</strong></p>
<p>稀なケースかも知れませんが、データ内、またはグループ内の<code>n</code>番目の行を抽出する時があります。たとえば、市区町村の情報が格納されているデータセットで、人口が大きい順でデータがソートされているとします。各都道府県ごとに最も人口が大きい市区町村のデータ、あるいは最も少ない市区町村のデータが必要な際、<code>first()</code>と<code>last()</code>関数が有効です。</p>
<p>それでは各都道府県ごとに「最も駅から遠いラーメン屋」の店舗名と最寄りの駅からの徒歩距離を出力したいとします。まずは、徒歩距離のデータが欠損しているケースを除去し、データを徒歩距離順でソートします。これは<code>filter()</code>と<code>arrange()</code>関数を使えば簡単です。続いて、<code>group_by()</code>を使って都府県単位でデータをグループ化します。最後に<code>summarise()</code>関数内に<code>last()</code>関数を使います。データは駅から近い順に鳴っているため、各都府県内の最後の行は駅から最も遠い店舗になるからです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">arrange</span>(Walk) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">summarise</span>(<span class="at">Farthest  =</span> <span class="fu">last</span>(Name),</span>
<span id="cb27-6"><a href="#cb27-6"></a>            <span class="at">Distance  =</span> <span class="fu">last</span>(Walk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Farthest                           Distance
  &lt;chr&gt;    &lt;chr&gt;                                 &lt;dbl&gt;
1 京都府   熱烈らぁめん                             30
2 兵庫県   濃厚醤油 中華そば いせや 玉津店          43
3 千葉県   札幌ラーメン どさん子 佐原51号店         59
4 和歌山県 中華そば まる乃                          30
5 埼玉県   札幌ラーメン どさん子 小鹿野店          116
6 大阪府   河童ラーメン本舗 岸和田店                38
7 奈良県   博多長浜らーめん 夢街道 四条大路店       29
8 東京都   てんがら 青梅新町店                      30
9 神奈川県 札幌ラーメン どさん子 中津店             73</code></pre>
</div>
</div>
<p>この<code>last()</code>を<code>first()</code>に変えると、最寄りの駅から最も近い店舗情報が表示されます。また、「<code>n</code>番目の情報」が必要な際は<code>nth()</code>関数を使います。<code>nth(Name, 2)</code>に変えることで2番目の店舗名が抽出できます。</p>
<p><strong><code>n_distinct()</code>: ユニーク値の個数を求める</strong></p>
<p><code>n_distinct()</code>は何種類の要素が含まれているかを計算する関数であり、<code>length(unique())</code>関数と同じ機能をします。たとえば、以下の<code>myVec1</code>に対して何種類の要素があるかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"C"</span>, <span class="st">"A"</span>)</span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">unique</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "A" "B" "D" "C"</code></pre>
</div>
</div>
<p><code>myVec1</code>は<code>"A"</code>、<code>"B"</code>、<code>"D"</code>、<code>"C"</code>の要素で構成されていることが分かります。これが<code>myVec1</code>の<strong>ユニーク値 (unique values)</strong>です。そして、このユニーク値の個数を調べるために<code>length()</code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(myVec1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>これで<code>myVec1</code>は4種類の値が存在することが分かります。これと全く同じ機能をする関数が<code>n_distinct()</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">n_distinct</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>この関数を<code>summarise()</code>に使うことで、都府県ごとに駅の個数が分かります。あるいは「東京都内の選挙区に、これまでの衆院選において何人の候補者が存在したか」も分かります。ここでは<code>df</code>内の都府県ごとに駅の個数を計算してみましょう。最後の駅数が多い順でソートします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Station)) <span class="sc">%&gt;%</span> <span class="co"># 最寄りの駅が欠損しているケースを除去</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="fu">summarise</span>(<span class="at">N_Station =</span> <span class="fu">n_distinct</span>(Station),</span>
<span id="cb35-5"><a href="#cb35-5"></a>            <span class="at">.groups   =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N_Station))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     N_Station
  &lt;chr&gt;        &lt;int&gt;
1 東京都         368
2 大阪府         341
3 千葉県         241
4 神奈川県       240
5 兵庫県         199
6 埼玉県         185
7 京都府         123
8 奈良県          52
9 和歌山県        46</code></pre>
</div>
</div>
<p>当たり前かも知れませんが、駅数が最も多いのは東京都で次が大阪府であることが分かります。</p>
<p><strong><code>any()</code>、<code>all()</code>: 条件に合致するか否かを求める</strong></p>
<p><code>any()</code>と<code>all()</code>はベクトル内の全要素に対して条件に合致するか否かを判定する関数です。ただし、<code>any()</code>は一つの要素でも条件に合致すれば<code>TRUE</code>を、全要素が合致しない場合<code>FALSE</code>を返します。一方、<code>all()</code>は全要素に対して条件を満たせば<code>TRUE</code>、一つでも満たさない要素があれば<code>FALSE</code>を返します。以下は<code>any()</code>と<code>all()</code>の例です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>myVec2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="fu">any</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、一つでも余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">all</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、全ての余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">all</span>(myVec2 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>) <span class="co"># myVec2を2で割った場合、全ての余りが0ではないか</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>それでは実際に<code>df</code>に対して<code>any()</code>と<code>all()</code>関数を使ってみましょう。一つ目は「ある都府県に最寄りの駅から徒歩60分以上の店舗が<strong>一つでも</strong>あるか」であり、二つ目は「ある都府県の店舗は<strong>全て</strong>最寄りの駅から徒歩30分以下か」です。それぞれの結果を<code>Over60</code>と<code>Within30</code>という列で出力してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">summarise</span>(<span class="at">Over60   =</span> <span class="fu">any</span>(Walk <span class="sc">&gt;=</span> <span class="dv">60</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-4"><a href="#cb43-4"></a>            <span class="at">Within30 =</span> <span class="fu">all</span>(Walk <span class="sc">&lt;=</span> <span class="dv">30</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-5"><a href="#cb43-5"></a>            <span class="at">.groups  =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Over60 Within30
  &lt;chr&gt;    &lt;lgl&gt;  &lt;lgl&gt;   
1 京都府   FALSE  TRUE    
2 兵庫県   FALSE  FALSE   
3 千葉県   FALSE  FALSE   
4 和歌山県 FALSE  TRUE    
5 埼玉県   TRUE   FALSE   
6 大阪府   FALSE  FALSE   
7 奈良県   FALSE  TRUE    
8 東京都   FALSE  TRUE    
9 神奈川県 TRUE   FALSE   </code></pre>
</div>
</div>
<p>埼玉県と神奈川県において、最寄りの駅から徒歩60以上の店がありました。また、京都府、東京都、奈良県、和歌山県の場合、全店舗が最寄りの駅から徒歩30分以下ということが分かります。当たり前ですが<code>Over60</code>が<code>TRUE</code>なら<code>Within30</code>は必ず<code>FALSE</code>になりますね。</p>
</section>
</section>
<section id="sec-handling2-group" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="sec-handling2-group"><span class="header-section-number">13.2</span> グルーピング</h2>
<section id="group_byによるグループ化" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="group_byによるグループ化"><span class="header-section-number">13.2.1</span> <code>group_by()</code>によるグループ化</h3>
<p>先ほどの<code>summarise()</code>関数は確かに便利ですが、特段に便利とも言いにくいです。<code>df</code>の<code>Score</code>の平均値を計算するだけなら、<code>summarise()</code>関数を使わない方が楽です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># これまでのやり方</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># 普通にこれでええんちゃう?</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.663457</code></pre>
</div>
</div>
<p>しかし、これをグループごとに計算するならどうでしょう。たとえば、<code>Score</code>の平均値を都府県ごとに計算するとします。この場合、以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"東京都"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.674256</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"神奈川県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.533931</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"千葉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.715983</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"埼玉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.641573</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"大阪府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.765194</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"京都府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.684976</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"兵庫県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.543936</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"奈良県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.854762</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"和歌山県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.96999</code></pre>
</div>
</div>
<p>変わったのは<code>df$Score</code>が<code>df$Score[df$Pref == "東京都"]</code>に変わっただけです。<code>df$Pref</code>が<code>"東京都"</code>であるか否かを<code>TRUE</code>と<code>FALSE</code>で判定し、これを基準に<code>df$Score</code>を抽出する仕組みです。<code>df$Score</code>と<code>df$Pref</code>は同じデータフレームですから、このような書き方で問題ありません。</p>
<p>これだけでもかなり書くのが面倒ですが、これが47都道府県なら、あるいは200ヶ国ならかなり骨の折れる作業でしょう。ここで大活躍するのが<code>dplyr</code>パッケージの<code>group_by()</code>関数です。引数はグループ化する変数名だけです。先ほどの作業を<code>dplyr</code>を使うなら<code>Pref</code>変数でグループ化し、<code>summarise()</code>関数で平均値を求めるだけです。今回は<code>Score</code>だけでなく、<code>ScoreN</code>の平均値も求めてみましょう。そして、評価が高い順にソートもしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb67-5"><a href="#cb67-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb67-6"><a href="#cb67-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.16        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
<p>評判が最も高い都府県は和歌山県、最も低いのは神奈川県ですね。Songも和歌山ラーメンは井出系も車庫前系も好きです。しかし、大事なのは「井出系」と「車庫前系」といった分類が正しいかどうかではありません。コードが非常に簡潔となり、ソートなども自由自在であることです。都府県ごとに<code>ScoreN</code>と<code>Score</code>の平均値を求める場合、<code>dplyr()</code>を使わなかったら18行のコードとなり、ソートも自分でやる必要があります。一方、<code>group_by()</code>関数を使うことによってコードが5行になりました。</p>
<p>また、これは2020年6月に公開された<code>dplyr</code>1.0.0からの問題ですが、<code>group_by()</code>の後に<code>summarise()</code>を使うと以下のようなメッセージが出力されます。</p>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<p>これは<code>group_by()</code>で指定された変数のグループ化が自動的に解除されたことを意味します。なぜなら<code>summarise()</code>をする際は<code>Pref</code>をグループ変数として使いましたが、出力された結果の<code>Pref</code>変数はもはやグループとして機能できなくなるからです。元の<code>df</code>には<code>Pref</code>が<code>"東京都"</code>だったケースが1000行、<code>"京都府"</code>だったのが414行あったので、<code>Pref</code>変数でグループ化する意味がありました。しかし、<code>summarise()</code>から得られたデータフレームは<code>Pref == "東京都"</code>の行が1つしかありません。これはグループ化する意味がなくなったことを意味します。したがって、自動的にグループを解除してくれます。自動的にやってくれるのはありがたいことですが、可能ならば関数内に自分で明記することが推奨されます。そこで使う引数が<code>.groups</code>であり、<code>"drop"</code>を指定すると<strong>全ての</strong>グループ化変数を解除します。以下のようなコードだと先ほどのメッセージが表示されません。今後、意識的に入れるようにしましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb70-3"><a href="#cb70-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb70-4"><a href="#cb70-4"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-5"><a href="#cb70-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-6"><a href="#cb70-6"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb70-7"><a href="#cb70-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.16        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
<p>続いて、一つ便利な関数を紹介します。それはグループのサイズを計算する関数、<code>n()</code>です。この関数を<code>summarise()</code>内に使うと、各グループに属するケース数を出力します<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。先ほどのコードを修正し、各グループのサイズを<code>N</code>という名の列として追加してみましょう。そしてソートの順番は<code>N</code>を最優先とし、同じ場合は<code>Score_Mean</code>が高い方を上に出力させます。また、<code>ScoreN_Mean</code>の前に、口コミ数の合計も出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># Prefごとに口コミ数の合計、口コミ数の平均値、評価の平均値、店舗数を求める</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="co"># 店舗数-評価の平均値順でソートする</span></span>
<span id="cb72-3"><a href="#cb72-3"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb72-5"><a href="#cb72-5"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb72-6"><a href="#cb72-6"></a>            <span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb72-7"><a href="#cb72-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb72-8"><a href="#cb72-8"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb72-9"><a href="#cb72-9"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-10"><a href="#cb72-10"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     ScoreN_Sum ScoreN_Mean Score_Mean     N
  &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 大阪府          516       0.516       3.77  1000
2 千葉県          259       0.259       3.72  1000
3 東京都         1165       1.16        3.67  1000
4 埼玉県          278       0.278       3.64  1000
5 神奈川県        587       0.587       3.53  1000
6 兵庫県          230       0.389       3.54   591
7 京都府          216       0.522       3.68   414
8 奈良県           45       0.306       3.85   147
9 和歌山県         83       0.593       3.97   140</code></pre>
</div>
</div>
<p>記述統計をグループごとに求めるのは普通にあり得るケースですし、実験データの場合はほぼ必須の作業でう。統制群と処置群間においてグループサイズが均一か、共変量のバラツキが十分に小さいかなどを判断する際に<code>group_by()</code>と<code>summarise()</code>関数の組み合わせは非常に便利です。</p>
</section>
<section id="複数の変数を用いたグループ化" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="複数の変数を用いたグループ化"><span class="header-section-number">13.2.2</span> 複数の変数を用いたグループ化</h3>
<p>グループ化変数は2つ以上指定することも可能です。たとえば、都府県 (<code>Pref</code>)と最寄りの駅の路線 (<code>Line</code>)でグループ化することも可能です。それでは<code>Pref</code>と<code>Line</code>でグループ化し、店舗数と口コミ数、評価の平均値を計算し、ソートの順番は店舗数、店舗数が同じなら評価の平均値が高い順にしましょう。今回も<code>summarise()</code>内に<code>.group = "drop"</code>を指定し、グループ化を解除します。今回はTop 20まで出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> <span class="co"># Lineが欠損していないケースのみ残す</span></span>
<span id="cb74-4"><a href="#cb74-4"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> <span class="co"># PrefとLineでグループ化</span></span>
<span id="cb74-5"><a href="#cb74-5"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb74-6"><a href="#cb74-6"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb74-7"><a href="#cb74-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb74-8"><a href="#cb74-8"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-9"><a href="#cb74-9"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb74-10"><a href="#cb74-10"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
   Pref     Line                        N ScoreN_Sum Score_Mean
   &lt;chr&gt;    &lt;chr&gt;                   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 埼玉県   東武東上線                122         27       3.68
 2 東京都   ＪＲ                      104        231       3.56
 3 神奈川県 小田急小田原線             96         31       3.59
 4 埼玉県   東武伊勢崎線               96         18       3.51
 5 神奈川県 横浜市営ブルーライン       82         77       3.66
 6 千葉県   京成本線                   82         29       3.34
 7 神奈川県 京急本線                   68         40       3.33
 8 千葉県   東武野田線                 63          2       4.75
 9 神奈川県 小田急江ノ島線             62          8       3.79
10 大阪府   阪急京都本線               53         32       3.67
11 大阪府   南海本線                   52         11       4.22
12 兵庫県   阪神本線                   52         23       3.80
13 埼玉県   JR高崎線                   51          5       4   
14 兵庫県   山陽電鉄本線               51         15       2.98
15 千葉県   JR総武本線（東京-銚子）    47          8       4   
16 埼玉県   西武新宿線                 45          8       4.17
17 埼玉県   秩父鉄道線                 43         10       3.82
18 大阪府   京阪本線                   43         10       3.69
19 千葉県   新京成電鉄                 43          6       3.6 
20 京都府   阪急京都本線               43         27       3.5 
# … with 503 more rows</code></pre>
</div>
</div>
<p>ぐるなびに登録されているラーメン屋が最も多い路線は埼玉県内の東武東上線で122店舗があります。東武東上線は東京都と埼玉県をまたがる路線ですので、東武東上線だけならもっと多いかも知れませんね。</p>
<p>ここで一つ考えたいのは<code>summarise()</code>内の<code>.groups</code>引数です。前回はグループ化に使った変数ごとに1行しか残っていなかったのでグループ化を全て解除しました。しかし、今回は状況がやや異なります。グループ化変数に使った<code>Pref</code>を考えると、まだ<code>Pref == "東京都"</code>であるケースがいくつかあります。やろうとすればまだグループ化出来る状態です。これは<code>Line</code>についても同じです。<code>Line == "東武東上線"</code>の行はここには表示されていないものの、まだデータに残っています。もし、これ以上グループ化しないなら今のように<code>.groups = "drop"</code>が正しいですが、もしもう一回グループ化したい場合はどうすればよいでしょうか。方法は2つ考えられます。</p>
<ol type="1">
<li>もう一度パイプ演算子を使って<code>group_by()</code>関数を使う (以下の9行目)。
<ul>
<li>結果を見ると<code>## # Groups:   Pref, Line [523]</code>で、ちゃんとグループ化されていることが分かります。</li>
</ul></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> </span>
<span id="cb76-4"><a href="#cb76-4"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb76-5"><a href="#cb76-5"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb76-6"><a href="#cb76-6"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb76-7"><a href="#cb76-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb76-8"><a href="#cb76-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb76-9"><a href="#cb76-9"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> <span class="co"># group_by()、もう一度</span></span>
<span id="cb76-10"><a href="#cb76-10"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
# Groups:   Pref, Line [523]
  Pref     Line                     N ScoreN_Sum Score_Mean
  &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 埼玉県   東武東上線             122         27       3.68
2 東京都   ＪＲ                   104        231       3.56
3 神奈川県 小田急小田原線          96         31       3.59
4 埼玉県   東武伊勢崎線            96         18       3.51
5 神奈川県 横浜市営ブルーライン    82         77       3.66
# … with 518 more rows</code></pre>
</div>
</div>
<ol start="2" type="1">
<li><code>.groups</code>引数を何とかする。</li>
</ol>
<p>推奨される方法は2番です。具体的には<code>.groups = "keep"</code>を指定するだけであり、こっちの方が無駄なコードを省けることができます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="#cb78-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> </span>
<span id="cb78-4"><a href="#cb78-4"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb78-5"><a href="#cb78-5"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-6"><a href="#cb78-6"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-7"><a href="#cb78-7"></a>            <span class="at">.groups     =</span> <span class="st">"keep"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-8"><a href="#cb78-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
# Groups:   Pref, Line [523]
  Pref     Line                     N ScoreN_Sum Score_Mean
  &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 埼玉県   東武東上線             122         27       3.68
2 東京都   ＪＲ                   104        231       3.56
3 神奈川県 小田急小田原線          96         31       3.59
4 埼玉県   東武伊勢崎線            96         18       3.51
5 神奈川県 横浜市営ブルーライン    82         77       3.66
# … with 518 more rows</code></pre>
</div>
</div>
<p><code>.groups</code>引数は<code>"drop"</code>と<code>"keep"</code>以外にも<code>"drop_last"</code>があります。実は<code>summarise()</code>に<code>.groups</code>引数を指定したい場合のデフォルト値は<code>.groups == "drop_last"</code>または<code>"keep"</code>ですが、ここがややこしいです。主なケースにおいてデフォルト値は<code>"drop"</code>となりますとなります。<code>.groups == "drop_last"</code>これは最後のグループ化変数のみ解除する意味です。今回の例だと、2番目のグループ化変数である<code>Line</code>がグループ化変数から外され、<code>Pref</code>のみがグループ化変数として残る仕組みです。</p>
<p>それではデフォルト値が<code>"keep"</code>になるのはいつでしょうか。それは記述統計量の結果が長さ2以上のベクトルである場合です。平均値を求める<code>mean()</code>、標準偏差を求める<code>sd()</code>などは、結果として長さ1のベクトルを返します。しかし、長さ2以上ののベクトルを返す関数もあります。たとえば、分位数を求める<code>quantile()</code>関数があります。<code>quantile(ベクトル名, 0.25)</code>の場合、第一四分位点のみ返すため、結果は長さ1のベクトルです。しかし、<code>quantile(ベクトル名, c(0.25, 0.5, 0.75))</code>のように第一四分位点から第三四分位点を同時に計算し、長さ3のベクトルが返されるケースもありますし、第二引数を省略すると、最小値・第一四分位点・第二四分位点・第三四分位点・最大値、つまり、長さ5のベクトルが返される場合があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a><span class="co"># 第一四分位点のみを求める (長さ1のベクトル)</span></span>
<span id="cb80-2"><a href="#cb80-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25% 
  2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a><span class="co"># 引数を省略する (長さ5のベクトル)</span></span>
<span id="cb82-2"><a href="#cb82-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%  25%  50%  75% 100% 
   1    2    5   12  116 </code></pre>
</div>
</div>
<p><code>.groups</code>のデフォルト値が<code>"keep"</code>になるのは、このように長さ2以上のベクトルが返されるケースです。たとえば、都府県と最寄りの駅の路線でグループ化し、店舗までの徒歩距離の平均値を求めるとします。デフォルト値の変化を見るために、ここではあえて<code>.groups</code>引数を省略しました。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span></span>
<span id="cb84-4"><a href="#cb84-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Walk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 509 × 3
# Groups:   Pref [9]
   Pref   Line                       Mean
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;
 1 京都府 JR奈良線                   3.33
 2 京都府 JR小浜線                  16.5 
 3 京都府 JR山陰本線（京都-米子）    8.67
 4 京都府 JR東海道本線（米原-神戸） 16.3 
 5 京都府 JR片町線〔学研都市線〕     9.4 
 6 京都府 JR舞鶴線                  19   
 7 京都府 京福北野線                 8.36
 8 京都府 京福嵐山本線               6.5 
 9 京都府 京福電気鉄道嵐山本線       6   
10 京都府 京都丹後鉄道宮福線         7.44
# … with 499 more rows</code></pre>
</div>
</div>
<p>最初は<code>Pref</code>と<code>Line</code>でグループ化しましたが、<code>summarise()</code>の後、<code>Line</code>がグループ化変数から外されました。つまり、引数が<code>"drop_last"</code>になっていることです。</p>
<p>それでは、平均値に加えて、第一四分位点と第三四分位点も計算し、<code>Quantile</code>という名で格納してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="#cb87-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span></span>
<span id="cb87-4"><a href="#cb87-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean     =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb87-5"><a href="#cb87-5"></a>            <span class="at">Quantile =</span> <span class="fu">quantile</span>(Walk, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in
dplyr 1.1.0.
ℹ Please use `reframe()` instead.
ℹ When switching from `summarise()` to `reframe()`, remember that `reframe()`
  always returns an ungrouped data frame and adjust accordingly.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref', 'Line'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,018 × 4
# Groups:   Pref, Line [509]
   Pref   Line                       Mean Quantile
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;    &lt;dbl&gt;
 1 京都府 JR奈良線                   3.33     2   
 2 京都府 JR奈良線                   3.33     5   
 3 京都府 JR小浜線                  16.5      9.75
 4 京都府 JR小浜線                  16.5     23.2 
 5 京都府 JR山陰本線（京都-米子）    8.67     2   
 6 京都府 JR山陰本線（京都-米子）    8.67    15   
 7 京都府 JR東海道本線（米原-神戸） 16.3     16   
 8 京都府 JR東海道本線（米原-神戸） 16.3     17   
 9 京都府 JR片町線〔学研都市線〕     9.4      2   
10 京都府 JR片町線〔学研都市線〕     9.4      9   
# … with 1,008 more rows</code></pre>
</div>
</div>
<p>同じ<code>Pref</code>、<code>Line</code>のケースが2つずつ出来ています。最初に来る数値は第一四分位点、次に来るのが第三四分位点です。そして最初のグループ化変数であった<code>Pref</code>と<code>Line</code>が、<code>summarise()</code>後もグループ化変数として残っていることが分かります。</p>
<p><code>.groups</code>引数は記述統計量だけを計算する意味ではあまり意識する必要がありません。しかし、得られた記述統計量から何らかの計算をしたり、さらにもう一回記述統計量を求めたりする際、予期せぬ結果が得られる可能性があるため注意する必要があります。出来る限り<code>.groups</code>引数は指定するようにしましょう。</p>
</section>
</section>
<section id="sec-handling2-mutate" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="sec-handling2-mutate"><span class="header-section-number">13.3</span> 変数の計算</h2>
<section id="mutate関数の使い方" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="mutate関数の使い方"><span class="header-section-number">13.3.1</span> <code>mutate()</code>関数の使い方</h3>
<p>続いて、データフレーム内の変数を用いて計算を行い、その結果を新しい列として格納する<code>mutate()</code>関数について紹介します。まず、<code>mutate()</code>関数の書き方からです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># mutate()関数の使い方</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> 処理内容)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これは何らかの処理を行い、その結果を新しい変数としてデータフレームに追加することを意味します。新しく出来た変数は、基本的に最後の列になります。ここでは分単位である<code>Walk</code>を時間単位に変換した<code>Walk_Hour</code>変数を作成するとします。処理内容は<code>Walk / 60</code>です。最後に、都府県名、店舗名、徒歩距離 (分)、徒歩距離 (時間)のみを残し、遠い順にソートします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb92-2"><a href="#cb92-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="#cb92-3"></a>  <span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-4"><a href="#cb92-4"></a>  <span class="fu">select</span>(Pref, Name, Walk, Walk_Hour) <span class="sc">%&gt;%</span></span>
<span id="cb92-5"><a href="#cb92-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Walk_Hour))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,375 × 4
   Pref     Name                               Walk Walk_Hour
   &lt;chr&gt;    &lt;chr&gt;                             &lt;dbl&gt;     &lt;dbl&gt;
 1 埼玉県   札幌ラーメン どさん子 小鹿野店      116     1.93 
 2 神奈川県 札幌ラーメン どさん子 中津店         73     1.22 
 3 千葉県   札幌ラーメン どさん子 佐原51号店     59     0.983
 4 神奈川県 札幌ラーメン どさん子 山際店         50     0.833
 5 千葉県   札幌ラーメン どさん子 関宿店         49     0.817
 6 兵庫県   濃厚醤油 中華そば いせや 玉津店      43     0.717
 7 大阪府   河童ラーメン本舗 岸和田店            38     0.633
 8 埼玉県   ラーメン山岡家 上尾店                35     0.583
 9 兵庫県   濃厚醤油 中華そば いせや 大蔵谷店    35     0.583
10 大阪府   河童ラーメン本舗 松原店              31     0.517
# … with 5,365 more rows</code></pre>
</div>
</div>
<p><code>mutate()</code>は3行目に登場しますが、これは<code>Walk</code>を60に割った結果を<code>Walk_Hour</code>としてデータフレームの最後の列として格納することを意味します。もし、最後の列でなく、ある変数の前、または後にしたい場合は、<code>.before</code>または<code>.after</code>引数を追加します。これは<code>select()</code>関数の<code>.before</code>と<code>.after</code>と同じ使い方です。たとえば、新しく出来た<code>Walk_Hour</code>を<code>ID</code>と<code>Name</code>の間に入れたい場合は</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># コードの3行名を修正 (.before使用)</span></span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb94-3"><a href="#cb94-3"></a>       <span class="at">.before   =</span> Name)</span>
<span id="cb94-4"><a href="#cb94-4"></a></span>
<span id="cb94-5"><a href="#cb94-5"></a><span class="co"># コードの3行名を修正 (.after使用)</span></span>
<span id="cb94-6"><a href="#cb94-6"></a><span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb94-7"><a href="#cb94-7"></a>       <span class="at">.after    =</span> ID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>のようにコードを修正します。</p>
<p>むろん、変数間同士の計算も可能です。たとえば、以下のような<code>df2</code>があり、1店舗当たりの平均口コミ数を計算し、<code>ScoreN_Mean</code>という変数名で<code>ScoreN_Sum</code>の後に格納うするとします。この場合、<code>ScoreN_Sum</code>変数を<code>N</code>で割るだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="#cb95-3"></a>  <span class="fu">summarise</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb95-4"><a href="#cb95-4"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb95-5"><a href="#cb95-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb95-6"><a href="#cb95-6"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb95-7"><a href="#cb95-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>df2 <span class="sc">%&gt;%</span></span>
<span id="cb96-2"><a href="#cb96-2"></a>  <span class="fu">mutate</span>(<span class="at">ScoreN_Mean =</span> ScoreN_Sum <span class="sc">/</span> N,</span>
<span id="cb96-3"><a href="#cb96-3"></a>         <span class="at">.after      =</span> ScoreN_Sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum ScoreN_Mean Score_Mean     N
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府         1399.        216       0.522       3.68   414
2 兵庫県         1197.        230       0.389       3.54   591
3 千葉県         1124.        259       0.259       3.72  1000
4 和歌山県       1252          83       0.593       3.97   140
5 埼玉県         1147.        278       0.278       3.64  1000
6 大阪府         1203.        516       0.516       3.77  1000
7 奈良県         1169.         45       0.306       3.85   147
8 東京都         1283.       1165       1.16        3.67  1000
9 神奈川県       1239.        587       0.587       3.53  1000</code></pre>
</div>
</div>
<p>このように、データ内の変数を用いた計算結果を新しい列として追加する場合は、<code>mutate()</code>が便利です。これを<code>mutate()</code>を使わずに処理する場合、以下のようなコードになりますが、可読性が相対的に低いことが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>df2<span class="sc">$</span>ScoreN_Mean <span class="ot">&lt;-</span> df2<span class="sc">$</span>ScoreN_Sum <span class="sc">/</span> df2<span class="sc">$</span>N</span>
<span id="cb98-2"><a href="#cb98-2"></a>df2 <span class="ot">&lt;-</span> df2[, <span class="fu">c</span>(<span class="st">"Pref"</span>, <span class="st">"Budget_Mean"</span>, <span class="st">"Walk_Mean"</span>, </span>
<span id="cb98-3"><a href="#cb98-3"></a>               <span class="st">"ScoreN_Sum"</span>, <span class="st">"ScoreN_Mean"</span>, <span class="st">"Score_Mean"</span>, <span class="st">"N"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>むろんですが、計算には<code>+</code>や<code>/</code>のような演算子だけでなく、関数を使うことも可能です。たとえば、<code>Budget</code>が1000円未満なら<code>"Cheap"</code>、1000円以上なら<code>"Expensive"</code>と示す変数<code>Budget2</code>を作成する場合は<code>ifelse()</code>関数が使えます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb99-2"><a href="#cb99-2"></a>  <span class="fu">mutate</span>(<span class="at">Budget2 =</span> <span class="fu">ifelse</span>(Budget <span class="sc">&lt;</span> <span class="dv">1000</span>, <span class="st">"Cheap"</span>, <span class="st">"Expensive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget2)) <span class="sc">%&gt;%</span> <span class="co"># Budget2が欠損した店舗を除外</span></span>
<span id="cb99-4"><a href="#cb99-4"></a>  <span class="fu">group_by</span>(Pref, Budget2) <span class="sc">%&gt;%</span> <span class="co"># PrefとBudget2でグループ化</span></span>
<span id="cb99-5"><a href="#cb99-5"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),          <span class="co"># 店舗数を表示</span></span>
<span id="cb99-6"><a href="#cb99-6"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 3
   Pref     Budget2       N
   &lt;chr&gt;    &lt;chr&gt;     &lt;int&gt;
 1 京都府   Cheap        22
 2 京都府   Expensive    28
 3 兵庫県   Cheap        39
 4 兵庫県   Expensive    27
 5 千葉県   Cheap        64
 6 千葉県   Expensive    72
 7 和歌山県 Cheap        10
 8 和歌山県 Expensive     5
 9 埼玉県   Cheap        37
10 埼玉県   Expensive    45
11 大阪府   Cheap       104
12 大阪府   Expensive   115
13 奈良県   Cheap        11
14 奈良県   Expensive    10
15 東京都   Cheap       206
16 東京都   Expensive   236
17 神奈川県 Cheap        66
18 神奈川県 Expensive    54</code></pre>
</div>
</div>
<p>これは各都府県ごとの予算1000円未満の店と以上の店の店舗数をまとめた表となります。もし、500円未満なら<code>"Cheap"</code>、500円以上~1000円未満なら<code>"Reasonable"</code>、1000円以上なら<code>"Expensive"</code>になる<code>Budget3</code>変数を作るにはどうすればよいでしょうか。第<a href="programming.html"><span>10</span></a>章で紹介しました<code>ifelse()</code>を重ねることも出来ますが、ここでは<code>case_when()</code>関数が便利です。まずは、<code>ifelse()</code>を使ったコードは以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a><span class="co"># ifelse()を使う場合</span></span>
<span id="cb101-2"><a href="#cb101-2"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb101-3"><a href="#cb101-3"></a>  <span class="fu">mutate</span>(<span class="at">Budget3 =</span> <span class="fu">ifelse</span>(Budget <span class="sc">&lt;</span> <span class="dv">500</span>, <span class="st">"Cheap"</span>, </span>
<span id="cb101-4"><a href="#cb101-4"></a>                          <span class="fu">ifelse</span>(Budget <span class="sc">&gt;=</span> <span class="dv">500</span> <span class="sc">&amp;</span> Budget <span class="sc">&lt;</span> <span class="dv">1000</span>, <span class="st">"Reasonable"</span>,</span>
<span id="cb101-5"><a href="#cb101-5"></a>                                 <span class="st">"Expensive"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb101-6"><a href="#cb101-6"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget3)) <span class="sc">%&gt;%</span></span>
<span id="cb101-7"><a href="#cb101-7"></a>  <span class="fu">group_by</span>(Pref, Budget3) <span class="sc">%&gt;%</span></span>
<span id="cb101-8"><a href="#cb101-8"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),         </span>
<span id="cb101-9"><a href="#cb101-9"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>case_when()</code>を使うと以下のような書き方になります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="co"># case_when()を使う場合</span></span>
<span id="cb102-2"><a href="#cb102-2"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb102-3"><a href="#cb102-3"></a>  <span class="fu">mutate</span>(<span class="at">Budget3 =</span> <span class="fu">case_when</span>(Budget <span class="sc">&lt;</span> <span class="dv">500</span>                  <span class="sc">~</span> <span class="st">"Cheap"</span>,</span>
<span id="cb102-4"><a href="#cb102-4"></a>                             Budget <span class="sc">&gt;=</span> <span class="dv">500</span> <span class="sc">&amp;</span> Budget <span class="sc">&lt;</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">"Reasonable"</span>,</span>
<span id="cb102-5"><a href="#cb102-5"></a>                             Budget <span class="sc">&gt;=</span> <span class="dv">1000</span>                <span class="sc">~</span> <span class="st">"Expensive"</span>),</span>
<span id="cb102-6"><a href="#cb102-6"></a>         <span class="co"># 新しく出来た変数をfactor型にその場で変換することも可能</span></span>
<span id="cb102-7"><a href="#cb102-7"></a>         <span class="at">Budget3 =</span> <span class="fu">factor</span>(Budget3, </span>
<span id="cb102-8"><a href="#cb102-8"></a>                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Cheap"</span>, <span class="st">"Reasonable"</span>, <span class="st">"Expensive"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb102-9"><a href="#cb102-9"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget3)) <span class="sc">%&gt;%</span></span>
<span id="cb102-10"><a href="#cb102-10"></a>  <span class="fu">group_by</span>(Pref, Budget3) <span class="sc">%&gt;%</span></span>
<span id="cb102-11"><a href="#cb102-11"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),         </span>
<span id="cb102-12"><a href="#cb102-12"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>書く手間の観点では<code>case_when()</code>は<code>ifelse()</code>と大きく違いはないかも知れませんが、コードが非常に読みやすくなっています。<code>case_when()</code>関数の書き方は以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a><span class="co"># case_when()の使い方</span></span>
<span id="cb103-2"><a href="#cb103-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3"></a>  <span class="fu">mutate</span>(新変数名 <span class="ot">=</span> <span class="fu">case_when</span>(条件1 <span class="sc">~</span> 条件1を満たす場合の結果値, </span>
<span id="cb103-4"><a href="#cb103-4"></a>                             条件2 <span class="sc">~</span> 条件2を満たす場合の結果値, </span>
<span id="cb103-5"><a href="#cb103-5"></a>                             条件3 <span class="sc">~</span> 条件3を満たす場合の結果値, </span>
<span id="cb103-6"><a href="#cb103-6"></a>                             ...))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>似たような機能をする関数として<code>recode()</code>関数があります<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。これは変数の値を単純に置換したい場合に便利な関数です。たとえば、都府県名をローマ字に変換するケースを考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a><span class="co"># recode()を使う場合</span></span>
<span id="cb104-2"><a href="#cb104-2"></a>df2 <span class="sc">%&gt;%</span> </span>
<span id="cb104-3"><a href="#cb104-3"></a>  <span class="fu">mutate</span>(<span class="at">Pref2 =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb104-4"><a href="#cb104-4"></a>                        <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="st">"Tokyo"</span>,</span>
<span id="cb104-5"><a href="#cb104-5"></a>                        <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="st">"Kanagawa"</span>,</span>
<span id="cb104-6"><a href="#cb104-6"></a>                        <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="st">"Chiba"</span>,</span>
<span id="cb104-7"><a href="#cb104-7"></a>                        <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="st">"Saitama"</span>,</span>
<span id="cb104-8"><a href="#cb104-8"></a>                        <span class="st">"大阪府"</span>   <span class="ot">=</span> <span class="st">"Osaka"</span>,</span>
<span id="cb104-9"><a href="#cb104-9"></a>                        <span class="st">"京都府"</span>   <span class="ot">=</span> <span class="st">"Kyoto"</span>,</span>
<span id="cb104-10"><a href="#cb104-10"></a>                        <span class="st">"兵庫県"</span>   <span class="ot">=</span> <span class="st">"Hyogo"</span>,</span>
<span id="cb104-11"><a href="#cb104-11"></a>                        <span class="st">"奈良県"</span>   <span class="ot">=</span> <span class="st">"Nara"</span>,</span>
<span id="cb104-12"><a href="#cb104-12"></a>                        <span class="st">"和歌山県"</span> <span class="ot">=</span> <span class="st">"Wakayama"</span>,</span>
<span id="cb104-13"><a href="#cb104-13"></a>                        <span class="at">.default  =</span> <span class="st">"NA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N Pref2   
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   
1 京都府         1399.        216       3.68   414 Kyoto   
2 兵庫県         1197.        230       3.54   591 Hyogo   
3 千葉県         1124.        259       3.72  1000 Chiba   
4 和歌山県       1252          83       3.97   140 Wakayama
5 埼玉県         1147.        278       3.64  1000 Saitama 
6 大阪府         1203.        516       3.77  1000 Osaka   
7 奈良県         1169.         45       3.85   147 Nara    
8 東京都         1283.       1165       3.67  1000 Tokyo   
9 神奈川県       1239.        587       3.53  1000 Kanagawa</code></pre>
</div>
</div>
<p>使い方は非常に直感的です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a><span class="co"># recode()の使い方</span></span>
<span id="cb106-2"><a href="#cb106-2"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb106-3"><a href="#cb106-3"></a>  <span class="fu">mutate</span>(新変数名 <span class="ot">=</span> <span class="fu">recode</span>(元の変数名,</span>
<span id="cb106-4"><a href="#cb106-4"></a>                            元の値1 <span class="ot">=</span>  新しい値1, </span>
<span id="cb106-5"><a href="#cb106-5"></a>                            元の値2 <span class="ot">=</span>  新しい値2, </span>
<span id="cb106-6"><a href="#cb106-6"></a>                            元の値3 <span class="ot">=</span>  新しい値3, </span>
<span id="cb106-7"><a href="#cb106-7"></a>                            ...,</span>
<span id="cb106-8"><a href="#cb106-8"></a>                            <span class="at">.default =</span> 該当しない場合の値))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>最後の<code>.default</code>引数は、もし該当する値がない場合に返す値を意味し、長さ1のベクトルを指定します。もし、指定しない場合は<code>NA</code>が表示されます。また、ここには紹介しておりませんでしたが、<code>.missing</code>引数もあり、これは欠損値の場合に返す値を意味します。</p>
<p>もう一つ注意すべきところは、今回はcharacter型変数をcharacter型へ変換したため、「<code>"東京都" = "Tokyo"</code>」のような書き方をしました。しかし、numeric型からcharacter型に変換する場合は数字の部分を<code>`</code>で囲む必要があります。たとえば、「<code>`1` = "Tokyo"</code>」といった形式です。ただし、character型からnumeric型への場合は「<code>"東京都" = 1</code>」で構いません。</p>
<p><code>recode()</code>は値をまとめる際にも便利です。たとえば、<code>EastJapan</code>という変数を作成し、関東なら<code>1</code>を、それ以外なら<code>0</code>を付けるとします。そして、これは<code>Pref</code>変数の後に位置づけます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a><span class="co"># 都府県を関東か否かでまとめる</span></span>
<span id="cb107-2"><a href="#cb107-2"></a>df2 <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="#cb107-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb107-4"><a href="#cb107-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb107-5"><a href="#cb107-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb107-6"><a href="#cb107-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb107-7"><a href="#cb107-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb107-8"><a href="#cb107-8"></a>                            <span class="st">"大阪府"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb107-9"><a href="#cb107-9"></a>                            <span class="st">"京都府"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb107-10"><a href="#cb107-10"></a>                            <span class="st">"兵庫県"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb107-11"><a href="#cb107-11"></a>                            <span class="st">"奈良県"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb107-12"><a href="#cb107-12"></a>                            <span class="st">"和歌山県"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb107-13"><a href="#cb107-13"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb107-14"><a href="#cb107-14"></a>         <span class="at">.after =</span> Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     EastJapan Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府           0       1399.        216       3.68   414
2 兵庫県           0       1197.        230       3.54   591
3 千葉県           1       1124.        259       3.72  1000
4 和歌山県         0       1252          83       3.97   140
5 埼玉県           1       1147.        278       3.64  1000
6 大阪府           0       1203.        516       3.77  1000
7 奈良県           0       1169.         45       3.85   147
8 東京都           1       1283.       1165       3.67  1000
9 神奈川県         1       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>ただし、関東以外は全て0になるため、以下のように省略することも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a><span class="co"># .default引数を指定する場合</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb109-3"><a href="#cb109-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb109-4"><a href="#cb109-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb109-5"><a href="#cb109-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb109-6"><a href="#cb109-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb109-7"><a href="#cb109-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb109-8"><a href="#cb109-8"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb109-9"><a href="#cb109-9"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb109-10"><a href="#cb109-10"></a></span>
<span id="cb109-11"><a href="#cb109-11"></a>df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     EastJapan Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府           0       1399.        216       3.68   414
2 兵庫県           0       1197.        230       3.54   591
3 千葉県           1       1124.        259       3.72  1000
4 和歌山県         0       1252          83       3.97   140
5 埼玉県           1       1147.        278       3.64  1000
6 大阪府           0       1203.        516       3.77  1000
7 奈良県           0       1169.         45       3.85   147
8 東京都           1       1283.       1165       3.67  1000
9 神奈川県         1       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>新しく出来た<code>EastJapan</code>のデータ型はなんでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a><span class="fu">class</span>(df3<span class="sc">$</span>EastJapan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<p><code>EastJapan</code>はnumeric型ですね。もし、これをfactor型にしたい場合はどうすればよいでしょうか。それは<code>mutate()</code>内で<code>EastJapan</code>を生成した後に<code>factor()</code>関数を使うだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a><span class="co"># EastJapan変数をfactor型にする</span></span>
<span id="cb113-2"><a href="#cb113-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb113-3"><a href="#cb113-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb113-4"><a href="#cb113-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb113-5"><a href="#cb113-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb113-6"><a href="#cb113-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb113-7"><a href="#cb113-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb113-8"><a href="#cb113-8"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb113-9"><a href="#cb113-9"></a>         <span class="at">EastJapan =</span> <span class="fu">factor</span>(EastJapan, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb113-10"><a href="#cb113-10"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb113-11"><a href="#cb113-11"></a></span>
<span id="cb113-12"><a href="#cb113-12"></a>df3<span class="sc">$</span>EastJapan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 1 0 1 0 0 1 1
Levels: 0 1</code></pre>
</div>
</div>
<p><code>EastJapan</code>がfactor型になりました。実は、<code>recode</code>は再コーディングと同時にfactor化をしてくれる機能があります。ただし、<code>recode()</code>関数でなく、<code>recode_factor()</code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># recode_factor()を使う方法</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb115-3"><a href="#cb115-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode_factor</span>(Pref,</span>
<span id="cb115-4"><a href="#cb115-4"></a>                                   <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb115-5"><a href="#cb115-5"></a>                                   <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb115-6"><a href="#cb115-6"></a>                                   <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb115-7"><a href="#cb115-7"></a>                                   <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb115-8"><a href="#cb115-8"></a>                                   <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb115-9"><a href="#cb115-9"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb115-10"><a href="#cb115-10"></a></span>
<span id="cb115-11"><a href="#cb115-11"></a>df3<span class="sc">$</span>EastJapan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 1 0 1 0 0 1 1
Levels: 1 0</code></pre>
</div>
</div>
<p>ただし、levelの順番は<code>recode_factor()</code>内で定義された順番になることに注意してください。factor型のより詳細な扱いについては第<a href="factor.html"><span>14</span></a>章で解説します。</p>
</section>
</section>
<section id="sec-handling2-rowwise" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="sec-handling2-rowwise"><span class="header-section-number">13.4</span> 行単位の操作</h2>
<p>ここでは行単位の操作について考えたいと思います。第<a href="datahandling1.html#sec-handling1-select"><span>12.3</span></a>章で使った<code>myDF1</code>を見てみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a>myDF1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb117-2"><a href="#cb117-2"></a>  <span class="at">ID  =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb117-3"><a href="#cb117-3"></a>  <span class="at">X1  =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">7</span>),</span>
<span id="cb117-4"><a href="#cb117-4"></a>  <span class="at">Y1  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb117-5"><a href="#cb117-5"></a>  <span class="at">X1D =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb117-6"><a href="#cb117-6"></a>  <span class="at">X2  =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb117-7"><a href="#cb117-7"></a>  <span class="at">Y2  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>),</span>
<span id="cb117-8"><a href="#cb117-8"></a>  <span class="at">X2D =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb117-9"><a href="#cb117-9"></a>  <span class="at">X3  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb117-10"><a href="#cb117-10"></a>  <span class="at">Y3  =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb117-11"><a href="#cb117-11"></a>  <span class="at">X3D =</span> <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">8</span>)</span>
<span id="cb117-12"><a href="#cb117-12"></a>)</span>
<span id="cb117-13"><a href="#cb117-13"></a></span>
<span id="cb117-14"><a href="#cb117-14"></a>myDF1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID X1 Y1 X1D X2 Y2 X2D X3 Y3 X3D
1  1  2  3   4  5  3   8  3  1   9
2  2  4  5   2  5  3   9  0  5   1
3  3  6  1   1  6  2   5  3  9   3
4  4  2  1   6  0  3   0  0  1   3
5  5  7  0   9  2  1   1  2  3   8</code></pre>
</div>
</div>
<p>ここで<code>X1</code>と<code>X2</code>と<code>X3</code>の平均値を計算し、<code>X_Mean</code>という名の変数にする場合、以下のような書き方が普通でしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(<span class="fu">c</span>(X1, X2, X3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID X1 Y1 X1D X2 Y2 X2D X3 Y3 X3D   X_Mean
1  1  2  3   4  5  3   8  3  1   9 3.133333
2  2  4  5   2  5  3   9  0  5   1 3.133333
3  3  6  1   1  6  2   5  3  9   3 3.133333
4  4  2  1   6  0  3   0  0  1   3 3.133333
5  5  7  0   9  2  1   1  2  3   8 3.133333</code></pre>
</div>
</div>
<p>あら、なんかおかしくありませんか。1行目の場合、<code>X1</code>と<code>X2</code>、<code>X3</code>それぞれ2、5、3であり、平均値は3.333であるはずなのに3.133になりました。これは2行目以降も同じです。なぜでしょうか。</p>
<p>実は<code>dplyr</code>は行単位の計算が苦手です。実際、データフレームというのは既に説明したとおり、縦ベクトルを横に並べたものです。列をまたがる場合、データ型が異なる場合も多いため、そもそも使う場面も多くありません。したがって、以下のような書き方が必要でした。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb121-2"><a href="#cb121-2"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> (X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3) <span class="sc">/</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID X1 Y1 X1D X2 Y2 X2D X3 Y3 X3D    X_Mean
1  1  2  3   4  5  3   8  3  1   9 3.3333333
2  2  4  5   2  5  3   9  0  5   1 3.0000000
3  3  6  1   1  6  2   5  3  9   3 5.0000000
4  4  2  1   6  0  3   0  0  1   3 0.6666667
5  5  7  0   9  2  1   1  2  3   8 3.6666667</code></pre>
</div>
</div>
<p>先ほどの<code>mean(c(X1, X2, X3))</code>は(<code>X1</code>列と<code>X2</code>列、<code>X3</code>列)の平均値です。<code>X1</code>は長さ1のベクトルではなく、その列全体を指すものです。つまり、<code>mean(c(X1, X2, X3))</code>は<code>mean(c(myD1F$X1, myDF1$X2, myDF1$X3))</code>と同じことになります。だから全て3.133という結果が得られました。ただし、後者はベクトル同士の加減乗除になるため問題ありません。実際<code>c(1, 2, 3) + c(3, 5, 0)</code>は同じ位置の要素同士の計算になることを既に第<a href="datastructure.html#sec-datastructure_vector"><span>9.2</span></a>章で説明しました。</p>
<p>ここで<code>mean()</code>関数を使う場合には全ての演算を、一行一行に分けて行う必要があります。ある一行のみに限定する場合、<code>mean(c(X1, X2, X3))</code>の<code>X1</code>などは長さ1のベクトルになるため、<code>(X1 + X2 + X3) / 3</code>と同じことになります。この「一行単位で処理を行う」ことを指定する関数が<code>rowwise()</code>関数です。これは行単位の作業を行う前に指定するだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb123-2"><a href="#cb123-2"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb123-3"><a href="#cb123-3"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(<span class="fu">c</span>(X1, X2, X3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
# Rowwise: 
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9  3.33 
2     2     4     5     2     5     3     9     0     5     1  3    
3     3     6     1     1     6     2     5     3     9     3  5    
4     4     2     1     6     0     3     0     0     1     3  0.667
5     5     7     0     9     2     1     1     2     3     8  3.67 </code></pre>
</div>
</div>
<p>これで問題なく行単位の処理ができるようになりました。今回は変数が3つのみだったので、これで問題ありませんが、変数が多くなると<code>:</code>や<code>starts_with()</code>、<code>num_range()</code>などを使って変数を選択したくなります。この場合は計算する関数内に<code>c_across()</code>を入れます。ここでは<code>X1</code>列から<code>X3D</code>列までの平均値を求めてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb125-2"><a href="#cb125-2"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb125-3"><a href="#cb125-3"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(X1<span class="sc">:</span>X3D))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
# Rowwise: 
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9    5.5
2     2     4     5     2     5     3     9     0     5     1    2.5
3     3     6     1     1     6     2     5     3     9     3    4.5
4     4     2     1     6     0     3     0     0     1     3    2.5
5     5     7     0     9     2     1     1     2     3     8    7.5</code></pre>
</div>
</div>
<p>実は<code>rowwise()</code>関数、2020年6月に公開されたdplyr 1.0.0で注目された関数ですが、昔のdplyrにも<code>rowwise()</code>関数はありました。ただし、<code>purrr</code>パッケージや<code>tidyr</code>パッケージの<code>nest()</code>関数などにより使い道がなくなりましたが、なぜか華麗に復活しました。データ分析に使うデータは基本単位は列であるため、実際に<code>rowwise()</code>が使われる場面は今の段階では多くないでしょう。また、簡単な作業なら<code>X1 + X2</code>のような演算でも対応できます。それでも、覚えておけば便利な関数であることには間違いありません。</p>
</section>
<section id="sec-handling2-merge" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="sec-handling2-merge"><span class="header-section-number">13.5</span> データの結合</h2>
<section id="行の結合" class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="行の結合"><span class="header-section-number">13.5.1</span> 行の結合</h3>
<p>まずは、複数のデータフレームまたはtibbleを縦に結合する方法について解説します。イメージとしては <a href="#fig-handling2_merge_row">図&nbsp;<span>13.1</span></a> のようなものです。</p>
<div id="fig-handling2_merge_row" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge1.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.1: 行の結合</figcaption><p></p>
</figure>
</div>
<p>行を結合する際には<code>dplyr</code>パッケージの<code>bind_rows()</code>関数を使います。この関数の使い方は以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a><span class="co"># 新しいデータ名ではなく、既にあるデータ名にすると上書きとなる</span></span>
<span id="cb127-2"><a href="#cb127-2"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">bind_rows</span>(データ1, データ2, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>それでは早速実際に使ってみましょう。実習のために、4つのtibbleを作成します (tibbleでなくデータフレームでも問題ありません)。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1"></a><span class="co"># tibble()の代わりにdata.frame()も可</span></span>
<span id="cb128-2"><a href="#cb128-2"></a>rbind_df1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb128-3"><a href="#cb128-3"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>),</span>
<span id="cb128-4"><a href="#cb128-4"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(T, T, F)) <span class="co"># TRUEとFALSEはTはFと省略可能</span></span>
<span id="cb128-5"><a href="#cb128-5"></a></span>
<span id="cb128-6"><a href="#cb128-6"></a>rbind_df2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb128-7"><a href="#cb128-7"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"D"</span>, <span class="st">"E"</span>, <span class="st">"F"</span>),</span>
<span id="cb128-8"><a href="#cb128-8"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(F, T, F))</span>
<span id="cb128-9"><a href="#cb128-9"></a></span>
<span id="cb128-10"><a href="#cb128-10"></a>rbind_df3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb128-11"><a href="#cb128-11"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(T, T, T),</span>
<span id="cb128-12"><a href="#cb128-12"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"G"</span>, <span class="st">"H"</span>, <span class="st">"I"</span>))</span>
<span id="cb128-13"><a href="#cb128-13"></a></span>
<span id="cb128-14"><a href="#cb128-14"></a>rbind_df4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb128-15"><a href="#cb128-15"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"J"</span>, <span class="st">"K"</span>, <span class="st">"L"</span>),</span>
<span id="cb128-16"><a href="#cb128-16"></a>                    <span class="at">X5 =</span> <span class="fu">c</span>(<span class="st">"Song"</span>, <span class="st">"Yanai"</span>, <span class="st">"Hadley"</span>))</span>
<span id="cb128-17"><a href="#cb128-17"></a></span>
<span id="cb128-18"><a href="#cb128-18"></a>rbind_df1 <span class="co"># rbind_df1を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1"></a>rbind_df2 <span class="co"># rbind_df2を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     4 D     FALSE
2     5 E     TRUE 
3     6 F     FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1"></a>rbind_df3 <span class="co"># rbind_df3を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X3    X2   
  &lt;int&gt; &lt;lgl&gt; &lt;chr&gt;
1     7 TRUE  G    
2     8 TRUE  H    
3     9 TRUE  I    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1"></a>rbind_df4 <span class="co"># rbind_df4を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X5    
  &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 
1    10 J     Song  
2    11 K     Yanai 
3    12 L     Hadley</code></pre>
</div>
</div>
<p>まずは、<code>rbind_df1</code>と<code>rbind_df2</code>を結合してみます。この2つのデータは同じ変数が同じ順番で並んでいますね。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1"></a>Binded_df1 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2)</span>
<span id="cb136-2"><a href="#cb136-2"></a>Binded_df1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE
4     4 D     FALSE
5     5 E     TRUE 
6     6 F     FALSE</code></pre>
</div>
</div>
<p>2つのデータが結合されたことが確認できます。それでは<code>rbind_df1</code>と<code>rbind_df2</code>、<code>rbind_df3</code>はどうでしょうか。確かに3つのデータは同じ変数を持ちますが、<code>rbind_df3</code>は変数の順番が<code>X1</code>、<code>X3</code>、<code>X2</code>になっています。このまま結合するとエラーが出るでしょうか。とりあえず、やってみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1"></a>Binded_df2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2, rbind_df3)</span>
<span id="cb138-2"><a href="#cb138-2"></a>Binded_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE
4     4 D     FALSE
5     5 E     TRUE 
6     6 F     FALSE
7     7 G     TRUE 
8     8 H     TRUE 
9     9 I     TRUE </code></pre>
</div>
</div>
<p>このように変数の順番が異なっても、先に指定したデータの変数順で問題なく結合できました。これまでの作業は<code>dplyr</code>パッケージの<code>bind_rows()</code>を使わずに、R内蔵関数の<code>rbind()</code>でも同じやり方でできます。<code>bind_rows()</code>の特徴は、変数名が一致しない場合、つまり今回の例だと<code>rbind_df4</code>が含まれる場合です。<code>rbind_df1</code>から<code>rbind_df3</code>までは順番が違っても<code>X1</code>、<code>X2</code>、<code>X3</code>変数で構成されていました。一方、<code>rbind_dr4</code>には<code>X3</code>がなく、新たに<code>X4</code>という変数があります。これを<code>rbind()</code>関数で結合するとエラーが出力されます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1"></a><span class="co"># rbind()を使う場合</span></span>
<span id="cb140-2"><a href="#cb140-2"></a><span class="fu">rbind</span>(rbind_df1, rbind_df2, rbind_df3, rbind_df4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in match.names(clabs, names(xi)): names do not match previous names</code></pre>
</div>
</div>
<p>一方、<code>bind_rows()</code>はどうでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a>Binded_df3 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2, rbind_df3, rbind_df4)</span>
<span id="cb142-2"><a href="#cb142-2"></a>Binded_df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
      X1 X2    X3    X5    
   &lt;int&gt; &lt;chr&gt; &lt;lgl&gt; &lt;chr&gt; 
 1     1 A     TRUE  &lt;NA&gt;  
 2     2 B     TRUE  &lt;NA&gt;  
 3     3 C     FALSE &lt;NA&gt;  
 4     4 D     FALSE &lt;NA&gt;  
 5     5 E     TRUE  &lt;NA&gt;  
 6     6 F     FALSE &lt;NA&gt;  
 7     7 G     TRUE  &lt;NA&gt;  
 8     8 H     TRUE  &lt;NA&gt;  
 9     9 I     TRUE  &lt;NA&gt;  
10    10 J     NA    Song  
11    11 K     NA    Yanai 
12    12 L     NA    Hadley</code></pre>
</div>
</div>
<p><code>X1</code>から<code>X4</code>まで全ての列が生成され、元のデータにはなかった列に関しては<code>NA</code>で埋められています。</p>
<p>ならば、<code>bind_rows()</code>の完全勝利かというと、そうとは限りません。自分で架空した複数のデータフレーム、またはtibbleを結合する際、「このデータは全て同じ変数を持っているはず」と事前に分かっているなら<code>rbind()</code>の方が効果的です。なぜなら、変数名が異なる場合、エラーが出力されるからです。<code>bind_rows()</code>を使うと、コーディングミスなどにより、列名の相違がある場合でも結合してくれてしまうので、分析の結果を歪ませる可能性があります。</p>
</section>
<section id="列の結合" class="level3" data-number="13.5.2">
<h3 data-number="13.5.2" class="anchored" data-anchor-id="列の結合"><span class="header-section-number">13.5.2</span> 列の結合</h3>
<p>実はデータ分析においてデータの結合といえば、列の結合が一般的です。これは <a href="#fig-handling2_merge_col">図&nbsp;<span>13.2</span></a> のような操作を意味します。</p>
<div id="fig-handling2_merge_col" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge2.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.2: 列の結合</figcaption><p></p>
</figure>
</div>
<p>まずは、本章で作成した<code>df2</code>をもう一回作ってみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="#cb144-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb144-3"><a href="#cb144-3"></a>  <span class="fu">summarise</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb144-4"><a href="#cb144-4"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb144-5"><a href="#cb144-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb144-6"><a href="#cb144-6"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb144-7"><a href="#cb144-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>)</span>
<span id="cb144-8"><a href="#cb144-8"></a></span>
<span id="cb144-9"><a href="#cb144-9"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府         1399.        216       3.68   414
2 兵庫県         1197.        230       3.54   591
3 千葉県         1124.        259       3.72  1000
4 和歌山県       1252          83       3.97   140
5 埼玉県         1147.        278       3.64  1000
6 大阪府         1203.        516       3.77  1000
7 奈良県         1169.         45       3.85   147
8 東京都         1283.       1165       3.67  1000
9 神奈川県       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>ラーメン屋の店舗ですが、たしかにデータには埼玉、東京、大阪などは1000店舗しか入っておりません。実はもっと多いですが、ぐるなびAPIの仕様上、最大1000店舗しか情報取得が出来ないからです。ここに実際の店舗数が入っている新しいデータセット、<a href="Data/Ramen2.csv">Ramen2.csv</a>があります。これを読み込み、<code>df3</code>という名で格納しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a>df3 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen2.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 47 Columns: 15
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (1): Pref
dbl (12): RamenN, Turnout, LDP, CDP, DPFP, Komei, JIP, JCP, SDP, Reiwa, NHK,...
num  (2): Pop, Area

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1"></a>df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 15
   Pref      Pop   Area RamenN Turnout   LDP   CDP  DPFP Komei   JIP   JCP   SDP
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 北海道 5.38e6 83424.   1454    53.8  32.3  20.8  6.65 11.7   7.78 11.6   1.31
 2 青森県 1.31e6  9646.    336    42.9  39.8  22.0  7.24 11.3   3.4   8.31  2.36
 3 岩手県 1.28e6 15275.    285    56.5  35.5  17.8 12.5   8.22  4.36 10.4   3.83
 4 宮城県 2.33e6  7282.    557    51.2  39.6  17.8  9.02 11.1   4.6   7.89  2.1 
 5 秋田県 1.02e6 11638.    301    56.3  44.5  13.5  8.64 10.6   4.48  8.09  3.77
 6 山形県 1.12e6  9323.    512    60.7  45.2  14.9  7.37  9.87  4.28  6.51  5.08
 7 福島県 1.91e6 13784.    550    52.4  38.2  13.6 12.1  12.8   5.31  7.99  3.01
 8 茨城県 2.92e6  6097.    663    45.0  39.3  15.2  7.15 15.1   6.73  7.73  1.46
 9 栃木県 1.97e6  6408.    595    44.1  40.3  18.9  9.94 12.8   4.9   5.04  1.03
10 群馬県 1.97e6  6362.    488    48.2  40.6  16.4  9.76 12.4   4.67  7.58  1.87
# … with 37 more rows, and 3 more variables: Reiwa &lt;dbl&gt;, NHK &lt;dbl&gt;, HRP &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-handling2_dataset" class="anchored">

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;"><caption>表&nbsp;13.1:  Ramen2.csvの詳細 </caption>
 <thead>
  <tr>
   <th style="text-align:left;text-align: center;"> 変数名 </th>
   <th style="text-align:left;text-align: center;"> 説明 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> `Pref` </td>
   <td style="text-align:left;"> 都道府県名 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `Pop` </td>
   <td style="text-align:left;"> 日本人人口 (2015年国勢調査) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `Area` </td>
   <td style="text-align:left;"> 面積 (2015年国勢調査) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `RamenN` </td>
   <td style="text-align:left;"> ぐるなびに登録されたラーメン屋の店舗数 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `Turnout` </td>
   <td style="text-align:left;"> 2019年参院選: 投票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `LDP` </td>
   <td style="text-align:left;"> 2019年参院選: 自民党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `CDP` </td>
   <td style="text-align:left;"> 2019年参院選: 立憲民主党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `DPFP` </td>
   <td style="text-align:left;"> 2019年参院選: 国民民主党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `Komei` </td>
   <td style="text-align:left;"> 2019年参院選: 公明党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `JIP` </td>
   <td style="text-align:left;"> 2019年参院選: 日本維新の会の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `JCP` </td>
   <td style="text-align:left;"> 2019年参院選: 日本共産党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `SDP` </td>
   <td style="text-align:left;"> 2019年参院選: 社会民主党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `Reiwa` </td>
   <td style="text-align:left;"> 2019年参院選: れいわ新選組の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `NHK` </td>
   <td style="text-align:left;"> 2019年参院選: NHKから国民を守る党の得票率 (比例) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> `HRP` </td>
   <td style="text-align:left;"> 2019年参院選: 幸福実現党の得票率 (比例) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>本データは都道府県ごとの人口、面積、ぐるなびに登録されたラーメン屋の店舗数、2019年参議院議員通常選挙の結果が格納されています。人口と面積は2015年国勢調査、ぐるなびの情報は2020年6月時点での情報です。</p>
<p><code>df2</code>にデータ上の店舗数ではなく、実際の店舗数を新しい列として追加したい場合はどうすれば良いでしょうか。簡単な方法としては<code>df3</code>から情報を取得し、それを自分で入れる方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a>df3 <span class="sc">%&gt;%</span></span>
<span id="cb150-2"><a href="#cb150-2"></a>  <span class="co"># df2のPrefベクトルの要素と一致するものに絞る</span></span>
<span id="cb150-3"><a href="#cb150-3"></a>  <span class="fu">filter</span>(Pref <span class="sc">%in%</span> df2<span class="sc">$</span>Pref) <span class="sc">%&gt;%</span></span>
<span id="cb150-4"><a href="#cb150-4"></a>  <span class="co"># 都道府県名とラーメン屋の店舗数のみ抽出</span></span>
<span id="cb150-5"><a href="#cb150-5"></a>  <span class="fu">select</span>(Pref, RamenN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     RamenN
  &lt;chr&gt;     &lt;dbl&gt;
1 埼玉県     1106
2 千葉県     1098
3 東京都     3220
4 神奈川県   1254
5 京都府      415
6 大阪府     1325
7 兵庫県      591
8 奈良県      147
9 和歌山県    140</code></pre>
</div>
</div>
<p>そして、この情報を<code>df2$RamenN &lt;- c(415, 1106, 1254, ...)</code>のように追加すればいいですね。</p>
<p>しかし、このような方法は非効率的です。そもそも<code>df3</code>から得られた結果の順番と<code>df2</code>の順番も一致しないので、一々対照しながらベクトルを作ることになります。ここで登場する関数が<code>dplyr</code>の<code>*_join()</code>関数群です。この関数群には4つの関数が含まれており、以下のような使い方になります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a><span class="co"># 新しいデータ名ではなく、データ1またはデータ2の名前に格納すると上書きとなる</span></span>
<span id="cb152-2"><a href="#cb152-2"></a></span>
<span id="cb152-3"><a href="#cb152-3"></a><span class="co"># 1. データ1を基準に結合</span></span>
<span id="cb152-4"><a href="#cb152-4"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">left_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb152-5"><a href="#cb152-5"></a></span>
<span id="cb152-6"><a href="#cb152-6"></a><span class="co"># 2. データ2を基準に結合</span></span>
<span id="cb152-7"><a href="#cb152-7"></a>新しいデータ名 <span class="ot">&lt;-</span> <span class="fu">right_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb152-8"><a href="#cb152-8"></a></span>
<span id="cb152-9"><a href="#cb152-9"></a><span class="co"># 3. データ1とデータ2両方に共通するケースのみ結合</span></span>
<span id="cb152-10"><a href="#cb152-10"></a>新しいデータ名 <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb152-11"><a href="#cb152-11"></a></span>
<span id="cb152-12"><a href="#cb152-12"></a><span class="co"># 4. データ1とデータ2、どれかに存在するケースを結合</span></span>
<span id="cb152-13"><a href="#cb152-13"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">full_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>4つの関数の違いについて説明する前に、<code>by</code>引数について話したいと思います。これは主にキー (key)変数と呼ばれる変数で、それぞれのデータに同じ名前の変数がある必要があります。<code>df2</code>と<code>df3</code>だとそれが<code>Pref</code>変数です。どの<code>*_join()</code>関数でも、<code>Pref</code>の値が同じもの同士を結合することになります。</p>
<p>データのキー変数名が異なる場合もあります。たとえば、データ1の都道府県名は<code>Pref</code>という列に、データ2の都道府県名は<code>Prefecture</code>という列になっている場合、<code>by = "Pref"</code>でなく、<code>by = c("データ1のキー変数名" = "データ2のキー変数名")</code>、つまり、<code>by = c("Pref" = "Prefecture")</code>と指定します。</p>
<p>それでは、<code>df3</code>から都道府県名とラーメン屋の店舗数だけ抽出し、<code>df4</code>として格納しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1"></a>df4 <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb153-2"><a href="#cb153-2"></a>  <span class="fu">select</span>(Pref, RamenN)</span>
<span id="cb153-3"><a href="#cb153-3"></a></span>
<span id="cb153-4"><a href="#cb153-4"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 2
   Pref   RamenN
   &lt;chr&gt;   &lt;dbl&gt;
 1 北海道   1454
 2 青森県    336
 3 岩手県    285
 4 宮城県    557
 5 秋田県    301
 6 山形県    512
 7 福島県    550
 8 茨城県    663
 9 栃木県    595
10 群馬県    488
# … with 37 more rows</code></pre>
</div>
</div>
<p>これから共通変数名の値をキー (key)と呼びます。今回の例だと<code>Pref</code>が<code>df2</code>と<code>df4</code>のキー変数であり、その値である<code>"東京都"</code>、<code>"北海道"</code>などがキーです。</p>
<p>まずは、<code>inner_join()</code>の仕組みについて考えます。これは<code>df2</code>と<code>df4</code>に共通するキーを持つケースのみ結合する関数です。<code>df4</code>には<code>"北海道"</code>というキーがありますが、<code>df2</code>にはありません。したがって、キーが<code>"北海道"</code>のケースは結合から除外されます。これをイメージにしたものが <a href="#fig-handling2_merge_inner">図&nbsp;<span>13.3</span></a> です<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。それぞれ3 <span class="math inline">\(\times\)</span> 2 (3行2列)のデータですが、キーが一致するケースは2つしかないため、結合後のデータは3 <span class="math inline">\(\times\)</span> 2となります。</p>
<div id="fig-handling2_merge_inner" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge_Inner.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.3: <code>inner_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
<p>実際にやってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a><span class="fu">inner_join</span>(df2, df4, <span class="at">by =</span> <span class="st">"Pref"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N RamenN
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;
1 京都府         1399.        216       3.68   414    415
2 兵庫県         1197.        230       3.54   591    591
3 千葉県         1124.        259       3.72  1000   1098
4 和歌山県       1252          83       3.97   140    140
5 埼玉県         1147.        278       3.64  1000   1106
6 大阪府         1203.        516       3.77  1000   1325
7 奈良県         1169.         45       3.85   147    147
8 東京都         1283.       1165       3.67  1000   3220
9 神奈川県       1239.        587       3.53  1000   1254</code></pre>
</div>
</div>
<p>共通するキーは9つのみであり、結果として返されたデータの大きさも9 <span class="math inline">\(\times\)</span> 6です。<code>df2</code>に足された<code>df4</code>は2列のデータですが、キー変数である<code>Pref</code>は共通するため、1列のみ足されました。キー変数を両方残す場合は<code>keep = TRUE</code>引数を追加してください。</p>
<p>一方、<code>full_join()</code>は、すべてのキーに対して結合を行います ( <a href="#fig-handling2_merge_full">図&nbsp;<span>13.4</span></a> )。たとえば、<code>df2</code>には<code>"北海道"</code>というキーがありません。それでも新しく出来上がるデータには北海道の列が追加されます。ただし、道内店舗の平均予算、口コミ数などの情報はないため、欠損値が代入されます。</p>
<div id="fig-handling2_merge_full" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge_Full.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.4: <code>full_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
<p>それでは実際、結果を確認してみましょう。今回は結合後、<code>RamenN</code>が大きい順で出力します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1"></a><span class="fu">full_join</span>(df2, df4, <span class="at">by =</span> <span class="st">"Pref"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb157-2"><a href="#cb157-2"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(RamenN)) <span class="co"># ぐるなびに登録された店舗の多い都道府県から出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 6
   Pref     Budget_Mean ScoreN_Sum Score_Mean     N RamenN
   &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;
 1 東京都         1283.       1165       3.67  1000   3220
 2 北海道           NA          NA      NA       NA   1454
 3 大阪府         1203.        516       3.77  1000   1325
 4 愛知県           NA          NA      NA       NA   1255
 5 神奈川県       1239.        587       3.53  1000   1254
 6 埼玉県         1147.        278       3.64  1000   1106
 7 千葉県         1124.        259       3.72  1000   1098
 8 福岡県           NA          NA      NA       NA    985
 9 新潟県           NA          NA      NA       NA    705
10 静岡県           NA          NA      NA       NA    679
# … with 37 more rows</code></pre>
</div>
</div>
<p><code>df2</code>にはなかった北海道や愛知県などの行ができました。そして、<code>df2</code>にはない情報はすべて欠損値 (<code>NA</code>)となりました。</p>
<p>続いて、<code>left_join()</code>ですが、これは先に指定したデータに存在するキーのみで結合を行います ( <a href="#fig-handling2_merge_left">図&nbsp;<span>13.5</span></a> )。今回は<code>df2</code>が先に指定されていますが、<code>df2</code>のキーは<code>df4</code>のキーの部分集合であるため、<code>inner_join()</code>と同じ結果が得られます。</p>
<div id="fig-handling2_merge_left" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge_Left.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.5: <code>left_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
<p>一方、<code>right_join()</code>は<code>left_join()</code>と逆の関数であり、後に指定したデータに存在するキーを基準に結合を行います ( <a href="#fig-handling2_merge_right">図&nbsp;<span>13.6</span></a> )。後に指定された<code>df4</code>のキーは<code>df2</code>のキーを完全に含むので、<code>full_join()</code>と同じ結果が得られます。</p>
<div id="fig-handling2_merge_right" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling2/Merge_Right.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">図&nbsp;13.6: <code>right</code>_join()`の仕組み</figcaption><p></p>
</figure>
</div>
<p>これからは<code>df2</code>と<code>df4</code>を結合することになりますが、この2つのtibbleの大きさが異なります。<code>df2</code>は9つの都府県のみであるに対し、<code>df4</code>は47都道府県全てのデータが入っているからです。</p>
<p>ここまではキー変数が一つである場合についてのみ考えましたが、複数のキー変数が必要な場合もあります。たとえば、市区町村の人口・面積データと市区町村の投票率データを結合するとします。各自治体に与えられている「<a href="https://www.soumu.go.jp/denshijiti/code.html">全国地方公共団体コード</a>」が両データに含まれている場合は、このコードをキー変数として使えば問題ありませんが、市区町村名をキー変数として使わざる得ないケースもあるでしょう。しかし、キー変数が複数ある場合もあります。たとえば、府中市は東京都と広島県にありますし、太子町は大阪府と兵庫県にあります。この場合、市区町村名のみでケースをマッチングすると、重複されてマッチングされる恐れがあります。この場合はキー変数を増やすことで対処できます。たとえば、同じ都道府県なら同じ市区町村は存在しないでしょう<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。キー変数を複数指定する方法は簡単です。たとえば、市区町村名変数が<code>Munip</code>、都道府県名変数が<code>Pref</code>なら<code>by = c("Munip", "Pref")</code>と指定するだけです。</p>
<p>最後に、キー変数以外の変数名が重複する場合について考えましょう。これはパネルデータを結合する時によく直面する問題です。同じ回答者に2回の調査を行った場合、回答者のIDでデータを結合することになります。ただし、それぞれのデータにおいて回答者の性別に関する変数が<code>F1</code>という名前の場合、どうなるでしょうか。同じデータの同じ名前の変数が複数あると、非常に扱いにくくなります。実際の結果を見てみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1"></a>Wave1_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb159-2"><a href="#cb159-2"></a>                   <span class="at">F1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb159-3"><a href="#cb159-3"></a>                   <span class="at">F2 =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">77</span>, <span class="dv">37</span>, <span class="dv">50</span>, <span class="dv">41</span>),</span>
<span id="cb159-4"><a href="#cb159-4"></a>                   <span class="at">Q1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb159-5"><a href="#cb159-5"></a></span>
<span id="cb159-6"><a href="#cb159-6"></a>Wave2_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>),</span>
<span id="cb159-7"><a href="#cb159-7"></a>                   <span class="at">F1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb159-8"><a href="#cb159-8"></a>                   <span class="at">F2 =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">37</span>, <span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">62</span>),</span>
<span id="cb159-9"><a href="#cb159-9"></a>                   <span class="at">Q1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">4</span>))</span>
<span id="cb159-10"><a href="#cb159-10"></a></span>
<span id="cb159-11"><a href="#cb159-11"></a><span class="fu">full_join</span>(Wave1_df, Wave2_df, <span class="at">by =</span> <span class="st">"ID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 7
     ID  F1.x  F2.x  Q1.x  F1.y  F2.y  Q1.y
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    18     1     1    18     1
2     2     1    77     5    NA    NA    NA
3     3     0    37     2     0    37     2
4     4     0    50     2     0    50     2
5     5     1    41     3    NA    NA    NA
6     6    NA    NA    NA     0    20     5
7     7    NA    NA    NA     1    62     4</code></pre>
</div>
</div>
<p>それぞれの変数名の後に<code>.x</code>と<code>.y</code>が付きます。この接尾辞 (suffix)は<code>suffix</code>引数を指定することで、分析側からカスタマイズ可能です。たとえば、接尾辞を<code>_W1</code>、<code>_W2</code>にしたい場合は</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1"></a><span class="fu">full_join</span>(Wave1_df, Wave2_df, <span class="at">by =</span> <span class="st">"ID"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_W1"</span>, <span class="st">"_W2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 7
     ID F1_W1 F2_W1 Q1_W1 F1_W2 F2_W2 Q1_W2
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    18     1     1    18     1
2     2     1    77     5    NA    NA    NA
3     3     0    37     2     0    37     2
4     4     0    50     2     0    50     2
5     5     1    41     3    NA    NA    NA
6     6    NA    NA    NA     0    20     5
7     7    NA    NA    NA     1    62     4</code></pre>
</div>
</div>
<p>のように、データ1とデータ2それぞれの接尾辞を指定するだけです。</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Grolemund_Wickham:2016" class="csl-entry" role="doc-biblioentry">
Grolemund, Garrett, and Hadley Wickham. 2016. <em>R for Data Science</em>. O’Reilly.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>今回の例のように記述統計量とケース数を同時に計算する場合は<code>n()</code>を使いますが、ケース数<strong>のみ</strong>を計算する場合は<code>group_by()</code>と<code>summarise()</code>と組み合わせず、<code>count()</code>関数だけ使うことも可能です。グループ化変数（ここでは<code>Pref</code>）を<code>count()</code>の引数として指定すると、<code>Pref</code>の値ごとのケース数が表示されます。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>recode()</code>関数は他にも{car}パッケージでも提供されています。{car}も広く使われている依存パッケージの一つであるため、<code>dplyr::recode()</code>と明示した方が良いかも知れません。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>これらの図は <span class="citation" data-cites="Grolemund_Wickham:2016">Grolemund and Wickham (<a href="references.html#ref-Grolemund_Wickham:2016" role="doc-biblioref">2016</a>)</span> を参考にしました。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>行政区も含むなら多くの政令指定都市にある「南区」とか「北区」が重複しますが、ここでは考えないことにしましょう。<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/www\.jaysong\.net\/RBook\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./datahandling1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データハンドリング [抽出]</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./factor.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データハンドリング [factor型]</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Copyright 2023, Jaehyun Song and Yuki Yanai</div>
  </div>
</footer>



</body></html>